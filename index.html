<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>CÔNG TY TNHH KIM TRƯỜNG PHÚC - Tính hiệu suất lò hơi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f4f6fb;
      --bg-alt: #e9f0ff;
      --card-bg: #ffffff;
      --accent: #1976d2;
      --accent-soft: rgba(25,118,210,0.08);
      --accent-strong: #0d47a1;
      --danger: #c62828;
      --warning: #ef6c00;
      --success: #2e7d32;
      --text-main: #1f2933;
      --text-muted: #607d8b;
      --border: #dde3f0;
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.12);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --transition-fast: 0.18s ease-out;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #e3f2fd 0, #f4f6fb 40%, #f4f6fb 100%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header.app-header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(18px);
      background: linear-gradient(120deg, rgba(13,71,161,0.96), rgba(25,118,210,0.96));
      color: #fff;
      box-shadow: 0 10px 30px rgba(13,71,161,0.45);
    }

    .header-inner {
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #bbdefb, #0d47a1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 18px;
      letter-spacing: 0.04em;
      box-shadow: 0 8px 20px rgba(3,16,48,0.5);
    }

    .brand-text h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .brand-text p {
      margin: 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .header-badge {
      padding: 6px 14px;
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(227,242,253,0.5);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .header-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #69f0ae;
      box-shadow: 0 0 0 4px rgba(105,240,174,0.3);
    }

    main.app-main {
      flex: 1;
      max-width: 1180px;
      margin: 22px auto 28px auto;
      padding: 0 16px 40px 16px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 3.2fr) minmax(0, 3.1fr);
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(209, 223, 255, 0.7);
      padding: 18px 18px 20px 18px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(25,118,210,0.2);
      color: var(--text-muted);
      background: rgba(227,242,253,0.6);
    }

    .section-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px 16px;
      margin-top: 8px;
    }

    .fieldset {
      border-radius: var(--radius-md);
      border: 1px solid rgba(203, 213, 245, 0.9);
      padding: 10px 12px 12px 12px;
      background: rgba(248, 250, 255, 0.9);
      position: relative;
    }

    .fieldset legend {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 6px;
      margin-left: 2px;
    }

    .field-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      margin-top: 4px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    label span.hint {
      font-size: 10px;
      opacity: 0.9;
    }

    input[type="number"],
    select {
      border-radius: 9px;
      border: 1px solid var(--border);
      padding: 6px 9px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
      background: #fdfdff;
    }

    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(25,118,210,0.2);
      background: #ffffff;
      transform: translateY(-0.5px);
    }

    input[type="number"]::placeholder {
      color: #b0bec5;
    }

    .input-addon {
      display: flex;
      align-items: center;
      border-radius: 9px;
      border: 1px solid var(--border);
      background: #fdfdff;
      overflow: hidden;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .input-addon input[type="number"] {
      border: none;
      flex: 1;
      padding-right: 4px;
      box-shadow: none;
    }

    .input-addon span {
      padding: 0 8px;
      font-size: 11px;
      color: var(--text-muted);
      border-left: 1px solid var(--border);
      background: #f5f7ff;
      white-space: nowrap;
    }

    .input-addon:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(25,118,210,0.18);
      background: #ffffff;
    }

    .fuel-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 2fr);
      gap: 8px;
      align-items: center;
    }

    .subtle-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .btn-row {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
      outline: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #fff;
      box-shadow: 0 10px 24px rgba(25,118,210,0.4);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(25,118,210,0.5);
    }

    .btn-ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(25,118,210,0.4);
    }

    .btn-ghost:hover {
      background: rgba(25,118,210,0.06);
    }

    .btn-icon {
      font-size: 16px;
      line-height: 0;
    }

    .results-header-main {
      margin-bottom: 10px;
    }

    .efficiency-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-size: 12px;
      font-weight: 500;
    }

    .efficiency-value {
      font-size: 22px;
      font-weight: 700;
    }

    .efficiency-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .stat-card {
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(209,223,255,0.9);
      background: linear-gradient(145deg, #f7f9ff, #ffffff);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .stat-main {
      font-size: 17px;
      font-weight: 600;
    }

    .stat-main span.unit {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-muted);
      margin-left: 4px;
    }

    .stat-note {
      font-size: 11px;
      color: var(--text-muted);
    }

    .loss-table-wrapper {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid rgba(209,223,255,0.9);
      overflow: hidden;
    }

    table.loss-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #f9fbff;
    }

    table.loss-table thead {
      background: linear-gradient(135deg, #e3f2fd, #e8eaf6);
    }

    table.loss-table th,
    table.loss-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(223,231,248,0.9);
      text-align: left;
      vertical-align: top;
    }

    table.loss-table th {
      font-weight: 600;
      font-size: 11px;
      color: var(--text-main);
    }

    table.loss-table td.loss-name {
      font-weight: 500;
      width: 26%;
    }

    table.loss-table td.loss-value {
      width: 14%;
      white-space: nowrap;
    }

    .loss-value-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(25,118,210,0.06);
      font-size: 11px;
    }

    .loss-tag {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(158,158,158,0.4);
      color: #616161;
      background: rgba(250,250,250,0.9);
      white-space: nowrap;
    }

    .loss-tag.bad {
      border-color: rgba(198,40,40,0.5);
      color: var(--danger);
      background: rgba(255,235,238,0.8);
    }

    .loss-tag.warn {
      border-color: rgba(239,108,0,0.6);
      color: var(--warning);
      background: rgba(255,243,224,0.9);
    }

    .loss-tag.good {
      border-color: rgba(46,125,50,0.5);
      color: var(--success);
      background: rgba(232,245,233,0.9);
    }

    table.loss-table td.loss-tip {
      font-size: 11px;
      color: var(--text-muted);
    }

    .recommendations {
      margin-top: 16px;
      padding: 10px 12px 12px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(144,164,174,0.8);
      background: linear-gradient(135deg, rgba(200,230,201,0.18), rgba(227,242,253,0.4));
    }

    .recommendations-title {
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .recommendations-list {
      font-size: 11px;
      color: var(--text-main);
      padding-left: 16px;
      margin: 0;
    }

    .recommendations-list li {
      margin-bottom: 3px;
    }

    .dot-bullet {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--success);
    }

    .details-card {
      margin-top: 22px;
      background: #ffffff;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(209,223,255,0.9);
      box-shadow: 0 14px 30px rgba(15,23,42,0.09);
      padding: 14px 18px 16px 18px;
    }

    details {
      border-radius: 10px;
      border: 1px solid rgba(209,223,255,0.8);
      background: #f7f9ff;
      padding: 8px 10px;
      margin-top: 8px;
    }

    summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      font-weight: 500;
      color: var(--accent-strong);
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .summary-arrow {
      font-size: 14px;
      transition: transform 0.2s ease;
    }

    details[open] .summary-arrow {
      transform: rotate(90deg);
    }

    .step-body {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-main);
      line-height: 1.5;
    }

    .step-body code {
      font-family: "SFMono-Regular", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(203,213,245,0.4);
      padding: 1px 4px;
      border-radius: 4px;
      font-size: 10px;
    }

    .step-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 6px 14px;
      margin-top: 4px;
    }

    .tagline {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .pill-soft {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(144,164,174,0.6);
      color: #455a64;
      background: rgba(236,239,241,0.8);
    }

    footer.app-footer {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      padding: 0 0 18px 0;
    }

    .error-text {
      margin-top: 6px;
      font-size: 11px;
      color: var(--danger);
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="header-inner">
      <div class="brand">
        <div class="brand-logo">KP</div>
        <div class="brand-text">
          <h1>CÔNG TY TNHH KIM TRƯỜNG PHÚC</h1>
          <p>TÍNH HIỆU SUẤT LÒ HƠI – TỔN THẤT & GIẢI PHÁP TỐI ƯU</p>
        </div>
      </div>
      <div class="header-badge">
        <span class="header-dot"></span>
        <span>Phiên bản demo nội bộ • Giao diện 2 cột</span>
      </div>
    </div>
  </header>

  <main class="app-main">
    <div class="layout">
      <!-- LEFT: INPUTS -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            Thông số đầu vào
            <span class="pill">Nhập liệu trực quan</span>
          </div>
          <span class="pill-soft">Đơn vị nhiệt: kJ, °C, bar(g)</span>
        </div>

        <div class="section-grid">
          <!-- Fuel block -->
          <fieldset class="fieldset">
            <legend>Nhiên liệu & phân tích nguyên tố (Dry Basis)</legend>
            <div class="field fuel-row">
              <div class="field">
                <label for="fuelPreset">Chọn nhiên liệu</label>
                <select id="fuelPreset">
                  <option value="dnb">Dăm ván lạng DNB</option>
                  <option value="mb">Dăm ván lạng MB</option>
                  <option value="rh">Trấu vỏ</option>
                  <option value="custom">Nhập tùy chọn (custom)</option>
                </select>
              </div>
              <div class="field">
                <label for="gcv_db">GCV<sub>db</sub> (kJ/kg)</label>
                <div class="input-addon">
                  <input type="number" id="gcv_db" step="1" placeholder="GCV khô" />
                  <span>kJ/kg</span>
                </div>
              </div>
            </div>

            <div class="field-group" style="margin-top:8px;">
              <div class="field">
                <label for="c_db">C<sub>db</sub> (%)</label>
                <input type="number" id="c_db" step="0.01" />
              </div>
              <div class="field">
                <label for="h_db">H<sub>db</sub> (%)</label>
                <input type="number" id="h_db" step="0.01" />
              </div>
              <div class="field">
                <label for="o_db">O<sub>db</sub> (%)</label>
                <input type="number" id="o_db" step="0.01" />
              </div>
              <div class="field">
                <label for="s_db">S<sub>db</sub> (%)</label>
                <input type="number" id="s_db" step="0.01" />
              </div>
              <div class="field">
                <label for="n_db">N<sub>db</sub> (%)</label>
                <input type="number" id="n_db" step="0.01" />
              </div>
              <div class="field">
                <label for="a_db">Ash<sub>db</sub> (%)</label>
                <input type="number" id="a_db" step="0.01" />
              </div>
            </div>

            <div class="field-group" style="margin-top:8px;">
              <div class="field">
                <label for="moisture">
                  Độ ẩm M<sub>ar</sub> (%)
                  <span class="hint">Trạng thái sử dụng</span>
                </label>
                <div class="input-addon">
                  <input type="number" id="moisture" step="0.1" value="45" />
                  <span>% khối lượng</span>
                </div>
              </div>
              <div class="field">
                <label for="fuelPrice">
                  Giá nhiên liệu
                  <span class="hint">VND/kg nhiên liệu</span>
                </label>
                <div class="input-addon">
                  <input type="number" id="fuelPrice" step="10" value="1500" />
                  <span>VND/kg</span>
                </div>
              </div>
            </div>

            <p class="subtle-text">
              Lưu ý: tổng C+H+O+S+N+Ash (dry) ≈ 100%. Độ ẩm M là % khối lượng nhiên liệu thực tế (as-received).
            </p>
          </fieldset>

          <!-- Flue gas block -->
          <fieldset class="fieldset">
            <legend>Khói thải & điều kiện môi trường</legend>
            <div class="field-group">
              <div class="field">
                <label for="o2_dry">
                  O<sub>2,dry</sub> khói thải (%)
                  <span class="hint">3 – 8% là vùng thường dùng</span>
                </label>
                <div class="input-addon">
                  <input type="number" id="o2_dry" step="0.1" value="6">
                  <span>% vol (khô)</span>
                </div>
              </div>
              <div class="field">
                <label for="co_ppm">
                  CO khói thải (ppm)
                  <span class="hint">&lt; 400 ppm: cháy khá tốt</span>
                </label>
                <div class="input-addon">
                  <input type="number" id="co_ppm" step="1" value="200">
                  <span>ppm</span>
                </div>
              </div>
              <div class="field">
                <label for="tf">
                  Nhiệt độ khói thải T<sub>f</sub>
                  <span class="hint">°C</span>
                </label>
                <div class="input-addon">
                  <input type="number" id="tf" step="1" value="180">
                  <span>°C</span>
                </div>
              </div>
              <div class="field">
                <label for="ta">
                  Nhiệt độ môi trường T<sub>a</sub>
                </label>
                <div class="input-addon">
                  <input type="number" id="ta" step="1" value="30">
                  <span>°C</span>
                </div>
              </div>
              <div class="field">
                <label for="rh">
                  Độ ẩm không khí RH
                </label>
                <div class="input-addon">
                  <input type="number" id="rh" step="1" value="80">
                  <span>%</span>
                </div>
              </div>
            </div>
            <p class="subtle-text">
              Độ ẩm không khí dùng để tính tổn thất L4 (nhiệt mang theo hơi nước trong không khí cấp).
            </p>
          </fieldset>

          <!-- Boiler block -->
          <fieldset class="fieldset">
            <legend>Thông số lò hơi & nước cấp</legend>
            <div class="field-group">
              <div class="field">
                <label for="t_fw">
                  Nhiệt độ nước cấp T<sub>fw</sub>
                </label>
                <div class="input-addon">
                  <input type="number" id="t_fw" step="1" value="80">
                  <span>°C</span>
                </div>
              </div>
              <div class="field">
                <label for="p_g">
                  Áp suất lò P<sub>g</sub>
                  <span class="hint">bar(g)</span>
                </label>
                <div class="input-addon">
                  <input type="number" id="p_g" step="0.1" value="10">
                  <span>bar(g)</span>
                </div>
              </div>
              <div class="field">
                <label for="br">
                  Tỷ lệ xả đáy BR
                  <span class="hint">% của lưu lượng hơi</span>
                </label>
                <div class="input-addon">
                  <input type="number" id="br" step="0.1" value="3">
                  <span>%</span>
                </div>
              </div>
              <div class="field">
                <label for="l_unburnt">
                  Tổn thất carbon chưa cháy L<sub>8</sub>
                </label>
                <div class="input-addon">
                  <input type="number" id="l_unburnt" step="0.1" value="1.0">
                  <span>%</span>
                </div>
              </div>
            </div>
            <p class="subtle-text">
              L6 (tổn thất bức xạ) mặc định 0,7%. Hiệu suất giả thiết ban đầu η<sub>init</sub> = 0,9 dùng cho tính L<sub>7</sub> (xả đáy).
            </p>
          </fieldset>
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="calcBtn" type="button">
            <span class="btn-icon">⚙️</span>
            <span>Tính tổn thất & hiệu suất lò hơi</span>
          </button>
          <button class="btn-ghost" id="resetBtn" type="button">
            <span class="btn-icon">↺</span>
            <span>Reset về mẫu nhiên liệu</span>
          </button>
        </div>
        <div class="error-text" id="errorArea"></div>
      </section>

      <!-- RIGHT: RESULTS -->
      <section class="card">
        <div class="card-header results-header-main">
          <div class="card-title">
            Kết quả & đánh giá hiệu suất
            <span class="pill">L1–L8 theo phương pháp gián tiếp</span>
          </div>
        </div>

        <div id="resultsSection">
          <div class="efficiency-pill">
            <span>Hiệu suất lò hơi ước tính</span>
            <span class="efficiency-value" id="etaValue">–</span>
            <span class="efficiency-sub">% (trên GCV<sub>ar</sub>)</span>
          </div>

          <div class="result-grid">
            <div class="stat-card">
              <div class="stat-label">Tiêu hao nhiên liệu cho 1 tấn hơi</div>
              <div class="stat-main">
                <span id="fuelPerTon">–</span>
                <span class="unit">kg nhiên liệu / tấn hơi</span>
              </div>
              <div class="stat-note">F<sub>steam</sub> = (h<sub>steam</sub> - h<sub>fw</sub>) / (η·GCV<sub>ar</sub>)</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Chi phí tạo 1 tấn hơi</div>
              <div class="stat-main">
                <span id="costPerTon">–</span>
                <span class="unit">VND/tấn hơi</span>
              </div>
              <div class="stat-note">Tính theo giá nhiên liệu (VND/kg) bạn nhập.</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">GCV<sub>ar</sub> & nhiệt trị hữu ích</div>
              <div class="stat-main">
                <span id="gcv_ar_display">–</span>
                <span class="unit">kJ/kg (as-received)</span>
              </div>
              <div class="stat-note">GCV<sub>ar</sub> = GCV<sub>db</sub>·(1 - M/100)</div>
            </div>
          </div>

          <div class="loss-table-wrapper">
            <table class="loss-table">
              <thead>
                <tr>
                  <th>Tổn thất</th>
                  <th>Giá trị</th>
                  <th>Mức đánh giá</th>
                  <th>Gợi ý cải thiện (giải pháp khả thi)</th>
                </tr>
              </thead>
              <tbody id="lossTableBody">
                <tr>
                  <td colspan="4" style="text-align:center; padding:10px; font-size:12px; color:var(--text-muted);">
                    Nhấn "Tính tổn thất & hiệu suất lò hơi" để xem chi tiết L1–L8 và khuyến nghị vận hành.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="recommendations" id="recommendationsBox" style="display:none;">
            <div class="recommendations-title">
              <span class="dot-bullet"></span>
              <span>Tổng hợp khuyến nghị chính (ưu tiên giải pháp kinh tế)</span>
            </div>
            <ul class="recommendations-list" id="recommendationsList"></ul>
          </div>
        </div>
      </section>
    </div>

    <!-- DETAILS SECTION -->
    <section class="details-card">
      <div class="card-header">
        <div class="card-title">
          Chi tiết từng bước tính toán
          <span class="pill">Để người dùng giám sát & kiểm tra</span>
        </div>
      </div>
      <p class="tagline">Tất cả giá trị bên dưới được cập nhật tự động sau mỗi lần bấm tính.</p>

      <details id="step1Details">
        <summary>
          <span>Bước 1 – Quy đổi phân tích khô sang trạng thái sử dụng (as-received)</span>
          <span class="summary-arrow">▶</span>
        </summary>
        <div class="step-body" id="step1Body"></div>
      </details>

      <details id="step2Details">
        <summary>
          <span>Bước 2 – Lượng không khí lý thuyết, không khí thừa & hệ số λ</span>
          <span class="summary-arrow">▶</span>
        </summary>
        <div class="step-body" id="step2Body"></div>
      </details>

      <details id="step3Details">
        <summary>
          <span>Bước 3 & 4 – Khối lượng khói thải khô, thành phần & C<sub>p, dg</sub></span>
          <span class="summary-arrow">▶</span>
        </summary>
        <div class="step-body" id="step3Body"></div>
      </details>

      <details id="step5Details">
        <summary>
          <span>Bước 5 – Các tổn thất L1–L8 theo phương pháp gián tiếp</span>
          <span class="summary-arrow">▶</span>
        </summary>
        <div class="step-body" id="step5Body"></div>
      </details>

      <details id="step6Details">
        <summary>
          <span>Bước 6 – Hiệu suất, tiêu hao nhiên liệu & chi phí 1 tấn hơi</span>
          <span class="summary-arrow">▶</span>
        </summary>
        <div class="step-body" id="step6Body"></div>
      </details>
    </section>
  </main>

  <footer class="app-footer">
    <span>Gợi ý: nhập số dùng dấu chấm “.” cho phần thập phân. Mẫu giao diện mang tính tham khảo, có thể tùy chỉnh theo nhu cầu thực tế.</span>
  </footer>
</div>

<script>
  // Preset fuels data (dry basis, %, and GCV_db in kJ/kg)
  const fuelPresets = {
    dnb: {
      name: "Dăm ván lạng DNB",
      c_db: 47.61,
      h_db: 4.87,
      o_db: 44.24,
      s_db: 0.06,
      n_db: 0.31,
      a_db: 2.91,
      gcv_db: 19639
    },
    mb: {
      name: "Dăm ván lạng MB",
      c_db: 47.61,
      h_db: 4.87,
      o_db: 44.24,
      s_db: 0.06,
      n_db: 0.31,
      a_db: 2.91,
      gcv_db: 17000
    },
    rh: {
      name: "Trấu vỏ",
      c_db: 36.42,
      h_db: 4.91,
      o_db: 35.88,
      s_db: 0.0,
      n_db: 0.59,
      a_db: 22.20,
      gcv_db: 16089
    }
  };

  const fuelPresetSelect = document.getElementById("fuelPreset");
  const errorArea = document.getElementById("errorArea");

  function loadFuelPreset() {
    const id = fuelPresetSelect.value;
    const preset = fuelPresets[id];
    if (!preset) return;
    document.getElementById("c_db").value = preset.c_db;
    document.getElementById("h_db").value = preset.h_db;
    document.getElementById("o_db").value = preset.o_db;
    document.getElementById("s_db").value = preset.s_db;
    document.getElementById("n_db").value = preset.n_db;
    document.getElementById("a_db").value = preset.a_db;
    document.getElementById("gcv_db").value = preset.gcv_db;
  }

  fuelPresetSelect.addEventListener("change", () => {
    if (fuelPresetSelect.value !== "custom") {
      loadFuelPreset();
    }
  });

  // Load default preset on start
  loadFuelPreset();

  function toNumber(id, defaultValue = 0) {
    const v = parseFloat(document.getElementById(id).value);
    return isFinite(v) ? v : defaultValue;
  }

  function formatNumber(value, decimals = 2) {
    if (!isFinite(value)) return "–";
    return value.toFixed(decimals);
  }

  // Saturation water vapour pressure (kPa) using Magnus formula
  function satPressureKPa(T) {
    // T in °C
    const A = 17.27;
    const B = 237.7;
    const alpha = (A * T) / (T + B);
    const psat = 0.61078 * Math.exp(alpha); // in kPa
    return psat;
  }

  // Approximate saturated water & steam enthalpy from pressure
  function steamPropsFromPressure(P_abs_bar) {
    // Rough correlation for saturation temperature (°C)
    const Tsat = 100 * Math.pow(Math.max(P_abs_bar, 1), 0.25);
    const h_f = 4.18 * Tsat; // kJ/kg, approximate
    const h_fg = 2500 - 2.36 * Tsat; // decreases with temp
    const h_steam = h_f + h_fg;
    return { Tsat, h_f, h_steam };
  }

  function calculate() {
    errorArea.textContent = "";

    // Fuel analysis (dry basis)
    const C_db = toNumber("c_db");
    const H_db = toNumber("h_db");
    const O_db = toNumber("o_db");
    const S_db = toNumber("s_db");
    const N_db = toNumber("n_db");
    const A_db = toNumber("a_db");
    const sumDry = C_db + H_db + O_db + S_db + N_db + A_db;

    if (sumDry < 98 || sumDry > 102) {
      errorArea.textContent = "Cảnh báo: Tổng C+H+O+S+N+Ash (dry) khác 100% nhiều (≈ " + sumDry.toFixed(2) + "%). Kiểm tra lại phân tích nguyên tố.";
    }

    const M = toNumber("moisture"); // %
    const fuelPrice = toNumber("fuelPrice");

    const GCV_db = toNumber("gcv_db");
    const GCV_ar = GCV_db * (100 - M) / 100.0; // kJ/kg

    // Step 1: As-received (%)
    const C_ar = C_db * (100 - M) / 100.0;
    const H_ar = H_db * (100 - M) / 100.0;
    const O_ar = O_db * (100 - M) / 100.0;
    const S_ar = S_db * (100 - M) / 100.0;
    const N_ar = N_db * (100 - M) / 100.0;
    const A_ar = A_db * (100 - M) / 100.0;
    const M_ar = M;

    const c = C_ar / 100.0;
    const h = H_ar / 100.0;
    const o = O_ar / 100.0;
    const s = S_ar / 100.0;
    const n = N_ar / 100.0;
    const a = A_ar / 100.0;
    const m = M_ar / 100.0;

    const O2_dry = toNumber("o2_dry");
    const CO_ppm = toNumber("co_ppm");
    const Tf = toNumber("tf");
    const Ta = toNumber("ta");
    const RH = toNumber("rh");

    const T_fw = toNumber("t_fw");
    const P_g = toNumber("p_g");
    const BR = toNumber("br");
    const L_unburnt = toNumber("l_unburnt");

    if (GCV_ar <= 0) {
      errorArea.textContent = "GCV_ar ≤ 0. Vui lòng kiểm tra lại GCV_db và độ ẩm M.";
      return;
    }

    // Step 2: Theoretical O2 and air
    const O2_req = 2.667 * c + 8 * h + s - o; // kg O2/kg fuel
    const A_th = O2_req / 0.232; // kg air/kg fuel

    const CO_vol = CO_ppm / 10000.0; // in %vol
    const lambda = 21.0 / (21.0 - O2_dry - 0.5 * CO_vol); // air excess factor
    const A_act = lambda * A_th; // actual air (kg/kg fuel)

    // Step 3: Dry flue gas mass (simple expression)
    const m_dg_simple = A_act + 1 - a - m - 9 * h;

    // Step 4: Flue gas composition to compute Cp_dg
    const K = CO_ppm * 12.0 / 1000000.0;
    const N_dg = (A_act * 0.03468 - h / 4.0 + n / 28.0) / (1.0 - K / 24.0); // kmol/kg fuel
    const c_CO = K * N_dg; // kg C as CO per kg fuel

    const mass_CO2 = 3.667 * (c - c_CO);
    const mass_CO = 2.333 * c_CO;
    const mass_SO2 = 2.0 * s;
    const mass_O2 = A_act * 0.232 - (2.667 * c - 1.333 * c_CO + 8.0 * h + s - o);
    const mass_N2 = A_act * 0.768 + n;

    const m_dg = mass_CO2 + mass_CO + mass_SO2 + mass_O2 + mass_N2;

    const f_CO2 = mass_CO2 / m_dg;
    const f_CO = mass_CO / m_dg;
    const f_SO2 = mass_SO2 / m_dg;
    const f_O2 = mass_O2 / m_dg;
    const f_N2 = mass_N2 / m_dg;

    const Cp_CO2 = 0.85;
    const Cp_O2 = 0.91;
    const Cp_N2 = 1.04;
    const Cp_SO2 = 0.64;
    const Cp_CO = 1.04;

    const Cp_dg = f_CO2 * Cp_CO2 + f_O2 * Cp_O2 + f_N2 * Cp_N2 + f_SO2 * Cp_SO2 + f_CO * Cp_CO;

    // Step 5: Losses
    const dT = Tf - Ta;

    const L1 = (m_dg * Cp_dg * dT) / GCV_ar * 100.0;

    const L2 = (9.0 * h * (2450.0 + 1.88 * dT)) / GCV_ar * 100.0;

    const L3 = (m * (2450.0 + 1.88 * dT)) / GCV_ar * 100.0;

    const P_sat = satPressureKPa(Ta);
    const P_v = (RH / 100.0) * P_sat;
    const omega = 0.622 * P_v / (101.325 - P_v);
    const L4 = (A_act * omega * 1.88 * dT) / GCV_ar * 100.0;

    const L5 = (c_CO * 24100.0) / GCV_ar * 100.0;

    const L6 = 0.7; // radiation & unaccounted

    // Blowdown loss L7
    const P_abs = P_g + 1.0; // bar(a)
    const { Tsat, h_f, h_steam } = steamPropsFromPressure(P_abs);
    const h_fw = 4.18 * T_fw;

    const BR_frac = BR / 100.0;
    const eta_init = 0.9;
    let L7 = 0;
    if (h_steam > h_fw) {
      L7 = eta_init * BR_frac * (h_f - h_fw) / (h_steam - h_fw) * 100.0;
    }

    const L8 = L_unburnt; // unburnt carbon (user-set, default 1%)

    const losses = {
      L1, L2, L3, L4, L5, L6, L7, L8
    };

    const totalLoss = L1 + L2 + L3 + L4 + L5 + L6 + L7 + L8;
    const eta = 100.0 - totalLoss;

    // Fuel consumption & cost
    const eta_frac = eta / 100.0;
    let F_steam = NaN;
    let fuelPerTon = NaN;
    let costPerTon = NaN;

    if (eta_frac > 0 && GCV_ar > 0) {
      F_steam = (h_steam - h_fw) / (eta_frac * GCV_ar); // kg fuel / kg steam
      fuelPerTon = F_steam * 1000.0; // kg fuel per 1 t steam
      costPerTon = fuelPerTon * fuelPrice;
    }

    // Update main results
    document.getElementById("etaValue").textContent = isFinite(eta) ? eta.toFixed(2) : "–";
    document.getElementById("fuelPerTon").textContent = isFinite(fuelPerTon) ? fuelPerTon.toFixed(1) : "–";
    document.getElementById("costPerTon").textContent = isFinite(costPerTon) ? costPerTon.toFixed(0) : "–";
    document.getElementById("gcv_ar_display").textContent = GCV_ar.toFixed(0);

    // Update loss table with simple tagging and local tips
    renderLossTable(losses, { O2_dry, CO_ppm, Tf, Ta, M, BR });

    // Recommendations
    renderRecommendations(losses, {
      O2_dry, CO_ppm, Tf, Ta, M, BR, eta, GCV_ar, fuelPerTon
    });

    // Step details
    renderStepDetails({
      C_db, H_db, O_db, S_db, N_db, A_db,
      C_ar, H_ar, O_ar, S_ar, N_ar, A_ar, M_ar,
      c, h, o, s, n, a, m, GCV_db, GCV_ar,
      O2_req, A_th, lambda, A_act, m_dg,
      Cp_dg, dT, P_sat, P_v, omega, h_fw,
      Tsat, h_f, h_steam, losses, eta, F_steam, fuelPerTon, costPerTon
    });
  }

  function renderLossTable(losses, context) {
    const tbody = document.getElementById("lossTableBody");
    tbody.innerHTML = "";

    const { L1, L2, L3, L4, L5, L6, L7, L8 } = losses;
    const { O2_dry, CO_ppm, Tf, Ta, M, BR } = context;

    const rows = [
      {
        key: "L1",
        name: "L1 – Tổn thất khí thải khô",
        value: L1,
        tip: ""
      },
      {
        key: "L2",
        name: "L2 – Nước hình thành từ H trong nhiên liệu",
        value: L2,
        tip: ""
      },
      {
        key: "L3",
        name: "L3 – Độ ẩm sẵn có trong nhiên liệu",
        value: L3,
        tip: ""
      },
      {
        key: "L4",
        name: "L4 – Độ ẩm không khí cấp (ω)",
        value: L4,
        tip: ""
      },
      {
        key: "L5",
        name: "L5 – Do CO (cháy không hoàn toàn)",
        value: L5,
        tip: ""
      },
      {
        key: "L6",
        name: "L6 – Bức xạ & tổn thất không xác định",
        value: L6,
        tip: "Mặc định 0,7%. Có thể giảm nhẹ bằng cách bảo ôn tốt, che chắn gió lùa."
      },
      {
        key: "L7",
        name: "L7 – Tổn thất xả đáy",
        value: L7,
        tip: ""
      },
      {
        key: "L8",
        name: "L8 – Tổn thất do carbon chưa cháy",
        value: L8,
        tip: ""
      }
    ];

    // Generate context-based tips and tags
    rows.forEach(r => {
      let tag = "OK";
      let tagClass = "loss-tag good";
      let tip = r.tip || "";

      if (r.key === "L1") {
        if (Tf > 220) {
          tag = "Cao";
          tagClass = "loss-tag bad";
          tip = "Khí thải nóng, xem xét lắp economizer/air-preheater, vệ sinh ống khói–bề mặt trao đổi nhiệt.";
        } else if (Tf > 180) {
          tag = "Hơi cao";
          tagClass = "loss-tag warn";
          tip = "Có thể tối ưu thêm bằng giảm nhiệt độ khói: kiểm tra bám bẩn, phân phối gió, tỷ lệ gió–nhiên liệu.";
        } else {
          tip = tip || "Nhiệt độ khói ở mức tương đối hợp lý. Vẫn nên kiểm tra định kỳ cáu cặn & bám bẩn.";
        }
      }

      if (r.key === "L2") {
        if (M > 50) {
          tag = "Cao";
          tagClass = "loss-tag bad";
          tip = "Độ ẩm nhiên liệu và hàm lượng H cao làm tăng L2. Cân nhắc sấy sơ bộ nhiên liệu, trộn với mẻ khô hơn.";
        } else if (L2 > 6) {
          tag = "Hơi cao";
          tagClass = "loss-tag warn";
          tip = tip || "Theo dõi độ ẩm & thành phần H của nhiên liệu, cố gắng giữ ổn định giữa các mẻ.";
        } else {
          tip = tip || "Tổn thất do nước từ H ở mức chấp nhận được với nhiên liệu sinh khối ẩm.";
        }
      }

      if (r.key === "L3") {
        if (M > 50) {
          tag = "Cao";
          tagClass = "loss-tag bad";
          tip = "M > 50% ⇒ L3 lớn. Giải pháp: phơi/sấy nhiên liệu, che mưa, lưu kho nơi thông thoáng khô ráo.";
        } else if (M > 40) {
          tag = "Hơi cao";
          tagClass = "loss-tag warn";
          tip = tip || "Độ ẩm 40–50%: nên cải thiện khâu lưu kho, tránh tưới ướt, hạn chế lấy nhiên liệu mới ướt chế biến.";
        } else {
          tip = tip || "Độ ẩm nhiên liệu tương đối tốt đối với lò hơi sinh khối.";
        }
      }

      if (r.key === "L4") {
        if (L4 > 1.0) {
          tag = "Hơi cao";
          tagClass = "loss-tag warn";
          tip = "Độ ẩm không khí cao (RH lớn). Có thể hạn chế bằng hút gió nóng từ phòng máy/khí hồi, tránh hút gió ngoài trời quá ẩm.";
        } else {
          tip = tip || "L4 thường nhỏ, ít dư địa cải thiện so với các tổn thất khác.";
        }
      }

      if (r.key === "L5") {
        if (CO_ppm > 800) {
          tag = "Cao";
          tagClass = "loss-tag bad";
          tip = "CO cao ⇒ cháy thiếu gió/pha trộn kém. Tăng nhẹ gió cấp, tối ưu phân phối gió sơ cấp/thứ cấp, kiểm tra cấp nhiên liệu.";
        } else if (CO_ppm > 400) {
          tag = "Hơi cao";
          tagClass = "loss-tag warn";
          tip = "CO hơi cao. Tối ưu điều chỉnh gió và nạp nhiên liệu để giảm CO nhưng vẫn giữ O₂ trong vùng hợp lý (4–7%).";
        } else {
          tip = tip || "CO thấp ⇒ cháy khá hoàn toàn. Có thể cân nhắc giảm nhẹ gió (O₂) để giảm L1 mà vẫn giữ CO an toàn.";
        }
      }

      if (r.key === "L7") {
        if (BR > 5) {
          tag = "Cao";
          tagClass = "loss-tag bad";
          tip = "Tỷ lệ xả đáy cao ⇒ mất nhiệt lớn. Kiểm tra chất lượng nước cấp, tối ưu TDS setpoint, cân nhắc thu hồi nhiệt nước xả đáy.";
        } else if (BR > 3) {
          tag = "Hơi cao";
          tagClass = "loss-tag warn";
          tip = tip || "Xem xét tối ưu chu trình xả đáy liên tục, đo TDS online để giảm lượng xả nhưng vẫn đảm bảo chất lượng nước lò.";
        } else {
          tip = tip || "BR ở mức hợp lý. Vẫn có thể thu hồi nhiệt nước xả đáy (flash tank, heat exchanger) nếu chưa lắp.";
        }
      }

      if (r.key === "L8") {
        if (L8 > 1.5) {
          tag = "Cao";
          tagClass = "loss-tag bad";
          tip = "Tổn thất do carbon chưa cháy cao ⇒ tro còn nhiều than. Kiểm tra kích thước nhiên liệu, phân phối gió và thời gian lưu trong buồng lửa.";
        } else if (L8 > 1.0) {
          tag = "Hơi cao";
          tagClass = "loss-tag warn";
          tip = tip || "Có thể cải thiện bằng tối ưu tốc độ ghi, chiều dày lớp nhiên liệu, đảm bảo đủ gió đi qua lớp nhiên liệu.";
        } else {
          tip = tip || "Tổn thất carbon chưa cháy thấp – vận hành buồng đốt khá tốt.";
        }
      }

      // O2-based overall hints used in L1 row or others
      if (r.key === "L1") {
        if (O2_dry > 8) {
          tip += " O₂ khói thải > 8% ⇒ gió dư lớn, nên giảm gió cấp từng bước nhỏ và theo dõi CO/O₂ để giảm L1.";
          tag = "Cao";
          tagClass = "loss-tag bad";
        } else if (O2_dry < 3) {
          tip += " O₂ < 3% ⇒ nguy cơ thiếu gió, CO tăng – nên tăng nhẹ gió cấp để đảm bảo an toàn cháy.";
          tagClass = "loss-tag warn";
        } else {
          tip += " O₂ ≈ " + O2_dry.toFixed(1) + "% nằm trong vùng hợp lý cho nhiên liệu ẩm.";
        }
      }

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.className = "loss-name";
      tdName.textContent = r.name;

      const tdValue = document.createElement("td");
      tdValue.className = "loss-value";
      const badge = document.createElement("span");
      badge.className = "loss-value-badge";
      badge.textContent = isFinite(r.value) ? r.value.toFixed(2) + " %" : "–";
      tdValue.appendChild(badge);

      const tdTag = document.createElement("td");
      const spanTag = document.createElement("span");
      spanTag.className = tagClass;
      spanTag.textContent = tag;
      tdTag.appendChild(spanTag);

      const tdTip = document.createElement("td");
      tdTip.className = "loss-tip";
      tdTip.textContent = tip;

      tr.appendChild(tdName);
      tr.appendChild(tdValue);
      tr.appendChild(tdTag);
      tr.appendChild(tdTip);

      tbody.appendChild(tr);
    });
  }

  function renderRecommendations(losses, ctx) {
    const box = document.getElementById("recommendationsBox");
    const list = document.getElementById("recommendationsList");
    list.innerHTML = "";

    const { L1, L2, L3, L4, L5, L7, L8 } = losses;
    const { O2_dry, CO_ppm, Tf, Ta, M, BR, eta, fuelPerTon } = ctx;

    const recs = [];

    // 1. Excess air & flue gas temperature
    if (O2_dry > 8 || Tf > 200) {
      recs.push("Giảm dần gió dư (giữ O₂ khói thải khoảng 3–7%) và vệ sinh bề mặt trao đổi nhiệt/economizer để hạ nhiệt độ khói thải, qua đó giảm L1 và cải thiện η.");
    } else if (O2_dry >= 3 && O2_dry <= 7 && Tf <= 200) {
      recs.push("Duy trì O₂ khói thải ≈ " + O2_dry.toFixed(1) + "% và T₍khí thải₎ ≈ " + Tf.toFixed(0) + "°C – đây là vùng vận hành khá tối ưu. Có thể tinh chỉnh nhỏ để tìm điểm η cao nhất.");
    }

    // 2. Moisture in fuel
    if (M > 50) {
      recs.push("Ưu tiên giảm độ ẩm nhiên liệu (M ≈ " + M.toFixed(1) + "%) bằng che mưa, cải thiện kho chứa, phơi/sấy sơ bộ hoặc trộn với mẻ nhiên liệu khô hơn để giảm L2+L3.");
    } else if (M > 40) {
      recs.push("Độ ẩm nhiên liệu 40–50%: nếu có điều kiện, cải thiện quản lý kho (lót nền, mái che, thoát nước tốt) để giảm thêm L2, L3 và tăng GCV₍ar₎.");
    }

    // 3. CO & combustion quality
    if (CO_ppm > 400) {
      recs.push("CO ≈ " + CO_ppm.toFixed(0) + " ppm ⇒ cháy chưa hoàn toàn. Cần tối ưu phân phối gió sơ cấp/thứ cấp, chỉnh lại lưu lượng gió và tốc độ cấp nhiên liệu để vừa giảm CO vừa giữ O₂ trong vùng cho phép.");
    } else {
      recs.push("CO thấp ⇒ cháy tương đối hoàn toàn. Có thể thử giảm nhẹ gió cấp (O₂ giảm nhưng vẫn an toàn) để giảm L1 mà không làm CO tăng quá cao.");
    }

    // 4. Blowdown
    if (BR > 5) {
      recs.push("Tỷ lệ xả đáy BR ≈ " + BR.toFixed(1) + "% là khá cao. Khuyến nghị: kiểm tra lại chất lượng nước cấp, tối ưu TDS setpoint, lắp đo TDS online và cân nhắc thu hồi nhiệt nước xả đáy bằng bộ trao đổi nhiệt.");
    }

    // 5. Unburnt carbon
    if (L8 > 1.5) {
      recs.push("Tổn thất do carbon chưa cháy (L8 ≈ " + L8.toFixed(2) + "%) cao ⇒ tro còn nhiều than. Cần tối ưu kích thước nhiên liệu, chiều dày lớp nhiên liệu, tốc độ ghi/chuẩn cấp liệu và phân phối gió qua lớp nhiên liệu.");
    }

    // 6. Overall efficiency
    if (isFinite(eta)) {
      if (eta < 75) {
        recs.push("Hiệu suất η ≈ " + eta.toFixed(2) + "% còn thấp. Nên tập trung ưu tiên vào giảm L1 (khói thải), L2+L3 (độ ẩm) và L7 (xả đáy) vì đây thường là các tổn thất chiếm tỷ trọng lớn và có giải pháp kinh tế.");
      } else if (eta >= 75 && eta < 85) {
        recs.push("Hiệu suất η ≈ " + eta.toFixed(2) + "% ở mức trung bình khá với lò hơi sinh khối. Việc tinh chỉnh tối ưu gió dư, sấy nhiên liệu tốt hơn, thu hồi nhiệt khói thải có thể đưa η lên ~85%.");
      } else {
        recs.push("Hiệu suất η ≈ " + eta.toFixed(2) + "% là khá tốt. Tiếp tục duy trì chế độ vận hành hiện tại, kết hợp theo dõi định kỳ O₂, CO, T khói và điều chỉnh khi nhiên liệu thay đổi.");
      }
    }

    // 7. Fuel consumption & cost
    if (isFinite(fuelPerTon)) {
      recs.push("Chỉ số tiêu hao nhiên liệu hiện tại ≈ " + fuelPerTon.toFixed(1) + " kg/tấn hơi. Mỗi 1–2% cải thiện η sẽ giúp giảm đáng kể chi phí nhiên liệu theo thời gian.");
    }

    if (recs.length === 0) {
      box.style.display = "none";
      return;
    }

    recs.forEach(r => {
      const li = document.createElement("li");
      li.textContent = r;
      list.appendChild(li);
    });

    box.style.display = "block";
  }

  function renderStepDetails(data) {
    const {
      C_db, H_db, O_db, S_db, N_db, A_db,
      C_ar, H_ar, O_ar, S_ar, N_ar, A_ar, M_ar,
      c, h, o, s, n, a, m, GCV_db, GCV_ar,
      O2_req, A_th, lambda, A_act, m_dg,
      Cp_dg, dT, P_sat, P_v, omega, h_fw,
      Tsat, h_f, h_steam, losses, eta, F_steam, fuelPerTon, costPerTon
    } = data;

    const step1Body = document.getElementById("step1Body");
    step1Body.innerHTML =
      `<div class="step-grid">
        <div>
          <strong>Thành phần khô (Dry Basis):</strong><br>
          C<sub>db</sub> = ${formatNumber(C_db, 2)}%,
          H<sub>db</sub> = ${formatNumber(H_db, 2)}%,
          O<sub>db</sub> = ${formatNumber(O_db, 2)}%,
          S<sub>db</sub> = ${formatNumber(S_db, 2)}%,
          N<sub>db</sub> = ${formatNumber(N_db, 2)}%,
          Ash<sub>db</sub> = ${formatNumber(A_db, 2)}%.<br>
          GCV<sub>db</sub> = ${formatNumber(GCV_db, 0)} kJ/kg.
        </div>
        <div>
          <strong>Chuyển sang trạng thái sử dụng (As-received):</strong><br>
          M = ${formatNumber(M_ar, 2)}% ⇒ C<sub>ar</sub> = C<sub>db</sub>·(100−M)/100 = ${formatNumber(C_ar, 2)}%<br>
          Tương tự: H<sub>ar</sub> = ${formatNumber(H_ar, 2)}%, O<sub>ar</sub> = ${formatNumber(O_ar, 2)}%, S<sub>ar</sub> = ${formatNumber(S_ar, 2)}%, N<sub>ar</sub> = ${formatNumber(N_ar, 2)}%, Ash<sub>ar</sub> = ${formatNumber(A_ar, 2)}%.<br>
          GCV<sub>ar</sub> = GCV<sub>db</sub>·(100−M)/100 = ${formatNumber(GCV_ar, 0)} kJ/kg.
        </div>
        <div>
          <strong>Phần khối lượng (kg/kg nhiên liệu):</strong><br>
          c = C<sub>ar</sub>/100 = ${formatNumber(c, 4)}<br>
          h = H<sub>ar</sub>/100 = ${formatNumber(h, 4)}<br>
          o = O<sub>ar</sub>/100 = ${formatNumber(o, 4)}<br>
          s = S<sub>ar</sub>/100 = ${formatNumber(s, 4)}<br>
          n = N<sub>ar</sub>/100 = ${formatNumber(n, 4)}<br>
          a = Ash<sub>ar</sub>/100 = ${formatNumber(a, 4)}<br>
          m = M<sub>ar</sub>/100 = ${formatNumber(m, 4)}
        </div>
      </div>`;

    const step2Body = document.getElementById("step2Body");
    step2Body.innerHTML =
      `<div class="step-grid">
        <div>
          <strong>Lượng O₂ lý thuyết:</strong><br>
          <code>O2_req = 2.667·c + 8·h + s − o</code><br>
          ⇒ O2_req = ${formatNumber(O2_req, 4)} kg O₂/kg nhiên liệu.
        </div>
        <div>
          <strong>Không khí lý thuyết:</strong><br>
          <code>A_th = O2_req / 0.232</code><br>
          ⇒ A<sub>th</sub> = ${formatNumber(A_th, 4)} kg không khí/kg nhiên liệu.
        </div>
        <div>
          <strong>Không khí thừa & hệ số λ:</strong><br>
          CO(ppm) = ${formatNumber(data.CO_ppm || 0, 0)} ⇒ CO_vol = CO/10000.<br>
          <code>λ = 21 / (21 − O2_dry − 0.5·CO_vol)</code><br>
          ⇒ λ = ${formatNumber(lambda, 3)}<br>
          <code>A_act = λ·A_th</code> ⇒ A<sub>act</sub> = ${formatNumber(A_act, 4)} kg/kg nhiên liệu.
        </div>
      </div>`;

    const step3Body = document.getElementById("step3Body");
    step3Body.innerHTML =
      `<div class="step-grid">
        <div>
          <strong>Khối lượng khói thải khô:</strong><br>
          Tính theo thành phần sản phẩm cháy:<br>
          CO₂: ${formatNumber(data.mass_CO2 || 0, 4)} kg/kg, CO: ${formatNumber(data.mass_CO || 0, 4)} kg/kg,<br>
          SO₂: ${formatNumber(data.mass_SO2 || 0, 4)} kg/kg, O₂ dư: ${formatNumber(data.mass_O2 || 0, 4)} kg/kg,<br>
          N₂: ${formatNumber(data.mass_N2 || 0, 4)} kg/kg.<br>
          <code>m_dg = Σ m_i</code> ⇒ m_dg ≈ ${formatNumber(m_dg, 4)} kg khói thải khô/kg nhiên liệu.
        </div>
        <div>
          <strong>Thành phần khối lượng & C<sub>p,dg</sub>:</strong><br>
          f<sub>CO₂</sub> = ${formatNumber(data.f_CO2 || 0, 3)}, f<sub>CO</sub> = ${formatNumber(data.f_CO || 0, 3)},<br>
          f<sub>SO₂</sub> = ${formatNumber(data.f_SO2 || 0, 3)}, f<sub>O₂</sub> = ${formatNumber(data.f_O2 || 0, 3)},<br>
          f<sub>N₂</sub> = ${formatNumber(data.f_N2 || 0, 3)}.<br>
          <code>Cp_dg = Σ f_i·Cp_i</code> ⇒ C<sub>p,dg</sub> = ${formatNumber(Cp_dg, 3)} kJ/kg·°C.
        </div>
        <div>
          <strong>Độ ẩm không khí:</strong><br>
          T<sub>a</sub> = ${formatNumber(data.Ta || 0, 1)}°C ⇒ P<sub>sat</sub>(T<sub>a</sub>) ≈ ${formatNumber(P_sat, 3)} kPa.<br>
          RH = ${formatNumber(data.RH || 0, 1)}% ⇒ P<sub>v</sub> = RH·P<sub>sat</sub> = ${formatNumber(P_v, 3)} kPa.<br>
          <code>ω = 0.622·P_v / (101.325 − P_v)</code> ⇒ ω = ${formatNumber(omega, 4)} kg ẩm/kg không khí khô.
        </div>
      </div>`;

    const step5Body = document.getElementById("step5Body");
    const { L1, L2, L3, L4, L5, L6, L7, L8 } = data.losses;
    step5Body.innerHTML =
      `<div class="step-grid">
        <div>
          <strong>L1 – Khí thải khô:</strong><br>
          <code>L1 = (m_dg·Cp_dg·(T_f − T_a))/GCV_ar·100</code><br>
          ⇒ L1 = ${formatNumber(L1, 2)} %.
        </div>
        <div>
          <strong>L2 – Nước từ H trong nhiên liệu:</strong><br>
          <code>L2 = (9·h·(2450 + 1.88·ΔT))/GCV_ar·100</code><br>
          ⇒ L2 = ${formatNumber(L2, 2)} %.
        </div>
        <div>
          <strong>L3 – Độ ẩm nhiên liệu:</strong><br>
          <code>L3 = (m·(2450 + 1.88·ΔT))/GCV_ar·100</code><br>
          ⇒ L3 = ${formatNumber(L3, 2)} %.
        </div>
      </div>
      <div class="step-grid" style="margin-top:6px;">
        <div>
          <strong>L4 – Độ ẩm không khí cấp:</strong><br>
          <code>L4 = (A_act·ω·1.88·ΔT)/GCV_ar·100</code><br>
          ⇒ L4 = ${formatNumber(L4, 2)} %.
        </div>
        <div>
          <strong>L5 – Tổn thất do CO:</strong><br>
          <code>L5 = (c_CO·24100)/GCV_ar·100</code><br>
          ⇒ L5 = ${formatNumber(L5, 2)} %.
        </div>
        <div>
          <strong>L6 – Bức xạ & khác:</strong><br>
          L6 mặc định = ${formatNumber(L6, 2)} %.
        </div>
      </div>
      <div class="step-grid" style="margin-top:6px;">
        <div>
          <strong>L7 – Tổn thất xả đáy:</strong><br>
          P<sub>g</sub> + 1 = P<sub>abs</sub> ⇒ T<sub>sat</sub> ≈ ${formatNumber(Tsat, 1)}°C.<br>
          h<sub>f</sub> ≈ ${formatNumber(h_f, 1)} kJ/kg, h<sub>steam</sub> ≈ ${formatNumber(h_steam, 1)} kJ/kg.<br>
          <code>L7 = η_init·BR·(h_f − h_fw)/(h_steam − h_fw)·100</code><br>
          ⇒ L7 = ${formatNumber(L7, 2)} %.
        </div>
        <div>
          <strong>L8 – Carbon chưa cháy:</strong><br>
          L8 do người dùng thiết lập (mặc định 1%) ⇒ L8 = ${formatNumber(L8, 2)} %.
        </div>
        <div>
          <strong>Tổng tổn thất & hiệu suất:</strong><br>
          ΣL = ${formatNumber(L1 + L2 + L3 + L4 + L5 + L6 + L7 + L8, 2)} %<br>
          <code>η = 100 − ΣL</code> ⇒ η = ${formatNumber(eta, 2)} %.
        </div>
      </div>`;

    const step6Body = document.getElementById("step6Body");
    step6Body.innerHTML =
      `<div class="step-grid">
        <div>
          <strong>Enthalpy nước cấp & hơi bão hòa:</strong><br>
          h<sub>fw</sub> ≈ 4.18·T<sub>fw</sub> = ${formatNumber(h_fw, 1)} kJ/kg.<br>
          h<sub>f</sub> ≈ ${formatNumber(h_f, 1)} kJ/kg, h<sub>steam</sub> ≈ ${formatNumber(h_steam, 1)} kJ/kg.<br>
          Δh = h<sub>steam</sub> − h<sub>fw</sub> ≈ ${formatNumber(h_steam - h_fw, 1)} kJ/kg hơi.
        </div>
        <div>
          <strong>Tiêu hao nhiên liệu:</strong><br>
          <code>F_steam = (h_steam − h_fw)/(η·GCV_ar)</code> (η dạng phần thập phân).<br>
          ⇒ F<sub>steam</sub> ≈ ${isFinite(F_steam) ? formatNumber(F_steam, 4) : "–"} kg nhiên liệu/kg hơi.<br>
          ⇒ ≈ ${isFinite(fuelPerTon) ? formatNumber(fuelPerTon, 1) : "–"} kg nhiên liệu/tấn hơi.
        </div>
        <div>
          <strong>Chi phí nhiên liệu/tấn hơi:</strong><br>
          Chi phí ≈ ${isFinite(costPerTon) ? formatNumber(costPerTon, 0) : "–"} VND/tấn hơi<br>
          (tính theo giá nhiên liệu bạn nhập).
        </div>
      </div>`;
  }

  document.getElementById("calcBtn").addEventListener("click", calculate);
  document.getElementById("resetBtn").addEventListener("click", () => {
    if (fuelPresetSelect.value !== "custom") {
      loadFuelPreset();
    }
    document.getElementById("moisture").value = 45;
    document.getElementById("fuelPrice").value = 1500;
    document.getElementById("o2_dry").value = 6;
    document.getElementById("co_ppm").value = 200;
    document.getElementById("tf").value = 180;
    document.getElementById("ta").value = 30;
    document.getElementById("rh").value = 80;
    document.getElementById("t_fw").value = 80;
    document.getElementById("p_g").value = 10;
    document.getElementById("br").value = 3;
    document.getElementById("l_unburnt").value = 1;
    document.getElementById("etaValue").textContent = "–";
    document.getElementById("fuelPerTon").textContent = "–";
    document.getElementById("costPerTon").textContent = "–";
    document.getElementById("gcv_ar_display").textContent = "–";
    document.getElementById("lossTableBody").innerHTML =
      '<tr><td colspan="4" style="text-align:center; padding:10px; font-size:12px; color:var(--text-muted);">Nhấn "Tính tổn thất & hiệu suất lò hơi" để xem chi tiết L1–L8 và khuyến nghị vận hành.</td></tr>';
    document.getElementById("recommendationsBox").style.display = "none";
    document.getElementById("step1Body").innerHTML = "";
    document.getElementById("step2Body").innerHTML = "";
    document.getElementById("step3Body").innerHTML = "";
    document.getElementById("step5Body").innerHTML = "";
    document.getElementById("step6Body").innerHTML = "";
    document.getElementById("errorArea").textContent = "";
  });
</script>
</body>
</html>
