<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Biomass Boiler Efficiency Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --accent: #10b981; /* xanh ngọc lục bảo */
      --accent-soft: #d1fae5;
      --accent-strong: #059669;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-subtle: #e5e7eb;
      --radius-lg: 16px;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #ecfeff 0, #f3f4f6 30%, #e5e7eb 100%);
      color: var(--text-main);
    }

    h1, h2, h3 {
      margin: 0;
    }

    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }

    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .app-title {
      font-size: 1.6rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 4px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.1);
      color: var(--accent-strong);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .app-subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .columns {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .col {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 16px;
      border: 1px solid rgba(15, 23, 42, 0.03);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 0.98rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .card-body {
      font-size: 0.85rem;
      color: var(--text-main);
    }

    .section-hint {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .grid-input-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }

    .grid-input-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.8rem;
    }

    .form-group label {
      font-weight: 500;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .form-group small {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.72rem;
    }

    .form-group input,
    .form-group select {
      border-radius: 9px;
      border: 1px solid var(--border-subtle);
      padding: 6px 8px;
      font-size: 0.8rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      background: #f9fafb;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.25);
      background: #ffffff;
    }

    .fuel-rows {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .fuel-row {
      display: grid;
      grid-template-columns: 1.4fr 0.8fr 0.8fr 0.9fr auto;
      gap: 6px;
      align-items: center;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.72rem;
      color: #374151;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #e5e7eb;
      color: #111827;
      transition: background 0.15s ease, transform 0.05s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.14);
      color: var(--danger);
    }

    .btn-ghost {
      background: transparent;
      border: 1px dashed #d1d5db;
    }

    .btn:hover {
      transform: translateY(-0.5px);
      filter: brightness(1.03);
    }

    .btn:active {
      transform: translateY(0.5px);
      filter: brightness(0.97);
    }

    .results-header {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    .metric {
      flex: 1;
      min-width: 120px;
      background: #f9fafb;
      border-radius: 12px;
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .metric-label {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .metric-value {
      font-size: 0.98rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .metric-unit {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .loss-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .loss-group {
      border-radius: 12px;
      padding: 8px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
    }

    .loss-group-title {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .loss-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.8rem;
      padding: 3px 0;
    }

    .loss-item span:first-child {
      color: #374151;
    }

    .loss-item span:last-child {
      font-weight: 600;
    }

    .loss-item.bad {
      color: var(--danger);
    }

    .loss-item.warn {
      color: var(--warning);
    }

    .loss-item.ok {
      color: var(--accent-strong);
    }

    .tags-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      font-size: 0.72rem;
    }

    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #6b7280;
    }

    .tag.danger {
      border-color: rgba(239, 68, 68, 0.4);
      background: rgba(254, 242, 242, 0.9);
      color: var(--danger);
    }

    .tag.warning {
      border-color: rgba(245, 158, 11, 0.4);
      background: rgba(255, 251, 235, 0.9);
      color: #92400e;
    }

    .scenario-cards {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .scenario-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      font-size: 0.78rem;
      background: #f9fafb;
    }

    .scenario-card h4 {
      margin: 0 0 4px;
      font-size: 0.8rem;
    }

    .scenario-card small {
      color: var(--text-muted);
    }

    .scenario-metrics {
      margin-top: 2px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 2px 6px;
    }

    .scenario-metrics div {
      font-size: 0.75rem;
    }

    .warnings-list,
    .advice-list,
    .knowledge-list,
    .steps-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .warnings-list li,
    .advice-list li,
    .knowledge-list li,
    .steps-list li {
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .warnings-list li.level-0 {
      border-color: rgba(16, 185, 129, 0.4);
      background: rgba(240, 253, 250, 0.9);
    }

    .warnings-list li.level-1 {
      border-color: rgba(245, 158, 11, 0.4);
      background: rgba(255, 251, 235, 0.9);
    }

    .warnings-list li.level-2 {
      border-color: rgba(239, 68, 68, 0.5);
      background: rgba(254, 242, 242, 0.95);
    }

    .advice-list li.severity-medium {
      border-color: rgba(245, 158, 11, 0.4);
      background: rgba(255, 251, 235, 0.9);
    }

    .advice-list li.severity-high {
      border-color: rgba(239, 68, 68, 0.5);
      background: rgba(254, 242, 242, 0.95);
    }

    .step-key {
      font-weight: 600;
    }

    .step-value {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
    }

    @media (max-width: 1024px) {
      .columns {
        flex-direction: column;
      }
      .scenario-cards {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      .fuel-row {
        grid-template-columns: 1fr 1fr;
        grid-auto-rows: auto;
      }
      .fuel-row > *:nth-child(3),
      .fuel-row > *:nth-child(4),
      .fuel-row > *:nth-child(5) {
        margin-top: 4px;
      }
      .loss-columns {
        grid-template-columns: 1fr;
      }
      .scenario-cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="app-header">
    <div>
      <div class="app-title">
        <span>Biomass Boiler Efficiency Dashboard</span>
        <span class="pill">BFB / CFB • Heat Balance</span>
      </div>
      <div class="app-subtitle">
        Nhập thông số vận hành → Web app tự động tính L1–L8, η, nhiên liệu/tấn hơi, chi phí hơi & gợi ý tối ưu vận hành.
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;font-size:0.78rem;">
      <div class="chip">
        <span>⏎</span>
        <span>Enter = Tính toán</span>
      </div>
      <button id="btnCalculate" class="btn btn-primary">
        <span>⚙️</span>
        <span>Tính ngay</span>
      </button>
    </div>
  </header>

  <main class="columns">
    <!-- COLUMN 1: Phần 1–3 -->
    <section class="col">
      <!-- PHẦN 1: ĐẦU VÀO -->
      <section class="card" id="section-inputs">
        <div class="card-header">
          <div class="card-title">
            <span>PHẦN 1 – ĐẦU VÀO NGƯỜI DÙNG</span>
            <span class="badge">Fuel mix + Operation</span>
          </div>
        </div>
        <div class="card-body">
          <div class="section-hint">1. Phối trộn nhiên liệu</div>
          <div class="chip">Người dùng có thể thêm / xóa nhiên liệu để tạo hỗn hợp đốt lò.</div>

          <div class="fuel-rows" id="fuelRows"></div>

          <div style="margin-top:6px;display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <button id="btnAddFuel" class="btn btn-ghost" type="button">
              <span>➕</span><span>Thêm nhiên liệu</span>
            </button>
            <div style="font-size:0.72rem;color:var(--text-muted);">
              Tổng MF (%) nên ≈ 100%. Hệ thống sẽ tự scale nếu lệch.
            </div>
          </div>

          <hr style="margin:10px 0;border:none;border-top:1px dashed #e5e7eb;" />

          <div class="section-hint">2. Thông số vận hành</div>
          <div class="grid-input-2">
            <div class="form-group">
              <label>O₂_dry (% vol khô)</label>
              <input type="number" step="0.1" id="inpO2" placeholder="4 – 8.5" />
            </div>
            <div class="form-group">
              <label>CO (ppm)</label>
              <input type="number" step="1" id="inpCO" placeholder="0 – 2000" />
            </div>
            <div class="form-group">
              <label>Tf – Nhiệt độ khói (°C)</label>
              <input type="number" step="1" id="inpTf" placeholder="150 – 200" />
            </div>
            <div class="form-group">
              <label>Ta – Nhiệt độ môi trường (°C)</label>
              <input type="number" step="1" id="inpTa" placeholder="25 – 35" />
            </div>
            <div class="form-group">
              <label>T_fw – Nhiệt độ bồn nước cấp (°C)</label>
              <input type="number" step="1" id="inpTfw" placeholder="60 – 105" />
            </div>
            <div class="form-group">
              <label>T_b – Nhiệt độ buồng đốt (°C)</label>
              <input type="number" step="1" id="inpTb" placeholder="700 – 900" />
            </div>
            <div class="form-group">
              <label>T_w – Nhiệt độ vách đuôi lò (°C)</label>
              <input type="number" step="1" id="inpTw" placeholder="80 – 120" />
            </div>
            <div class="form-group">
              <label>RH – Độ ẩm không khí (%)</label>
              <input type="number" step="1" id="inpRH" placeholder="70 – 95" />
            </div>
            <div class="form-group">
              <label>P_g – Áp suất lò (bar_g)</label>
              <input type="number" step="0.1" id="inpPg" placeholder="10" />
            </div>
            <div class="form-group">
              <label>Công suất thiết kế (t/h)</label>
              <input type="number" step="0.1" id="inpDesignCap" placeholder="tấn hơi/giờ" />
            </div>
            <div class="form-group">
              <label>Công suất vận hành (t/h)</label>
              <input type="number" step="0.1" id="inpActualCap" placeholder="tấn hơi/giờ" />
            </div>
            <div class="form-group">
              <label>TDS nước cấp (ppm)</label>
              <input type="number" step="1" id="inpTDS" placeholder="≤ 300" />
            </div>
            <div class="form-group">
              <label>BR – Tỉ lệ xả đáy (%)</label>
              <input type="number" step="0.1" id="inpBR" placeholder="VD 3 – 8" />
              <small>Nếu bỏ trống → hệ thống gợi ý từ TDS.</small>
            </div>
            <div class="form-group">
              <label>L6 – Tổn thất bức xạ & cơ khí (%)
                <small>tùy chọn</small>
              </label>
              <input type="number" step="0.1" id="inpL6User" placeholder="VD 0.7" />
            </div>
            <div class="form-group">
              <label>L7 – Tổn thất cháy không hết (%)
                <small>tùy chọn</small>
              </label>
              <input type="number" step="0.1" id="inpL7User" placeholder="VD 1.5" />
            </div>
          </div>
        </div>
      </section>

      <!-- PHẦN 2: LƯU 3 TRƯỜNG HỢP VẬN HÀNH -->
      <section class="card" id="section-scenarios">
        <div class="card-header">
          <div class="card-title">
            <span>PHẦN 2 – KỊCH BẢN VẬN HÀNH</span>
            <span class="badge">Lưu tối đa 3 case</span>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="btn" type="button" data-save-scenario="1">Lưu Case 1</button>
            <button class="btn" type="button" data-save-scenario="2">Lưu Case 2</button>
            <button class="btn" type="button" data-save-scenario="3">Lưu Case 3</button>
          </div>
        </div>
        <div class="card-body">
          <div class="section-hint">
            Lưu lại thông số & kết quả để so sánh phương án vận hành (η, nhiên liệu/tấn hơi, chi phí).
          </div>
          <div class="scenario-cards" id="scenarioCards">
            <!-- Filled by JS -->
          </div>
        </div>
      </section>

      <!-- PHẦN 3: CẢNH BÁO -->
      <section class="card" id="section-warnings">
        <div class="card-header">
          <div class="card-title">
            <span>PHẦN 3 – CẢNH BÁO AN TOÀN</span>
            <span class="badge">Tự động đánh giá mức Xanh / Vàng / Đỏ</span>
          </div>
        </div>
        <div class="card-body">
          <div class="section-hint">
            Cảnh báo dựa trên: độ ẩm nhiên liệu, T_b, O₂_dry, T_fw, TDS, tải lò, T_stack (Tf), Tw...
          </div>
          <ul class="warnings-list" id="warningsList"></ul>
        </div>
      </section>
    </section>

    <!-- COLUMN 2: Phần 4–7 -->
    <section class="col">
      <!-- PHẦN 4: TỔN THẤT & HIỆU SUẤT -->
      <section class="card" id="section-losses">
        <div class="card-header">
          <div class="card-title">
            <span>PHẦN 4 – TỔN THẤT & HIỆU SUẤT</span>
            <span class="badge">L1 – L8 • η • Fuel / Steam</span>
          </div>
        </div>
        <div class="card-body">
          <div class="results-header">
            <div class="metric">
              <div class="metric-label">Hiệu suất lò (η)</div>
              <div class="metric-value">
                <span id="valEta">–</span>
                <span class="metric-unit">%</span>
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">Nhiên liệu tiêu hao / 1 tấn hơi</div>
              <div class="metric-value">
                <span id="valFuelPerTon">–</span>
                <span class="metric-unit">kg/tấn hơi</span>
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">Chi phí hơi (ước tính)</div>
              <div class="metric-value">
                <span id="valSteamCost">–</span>
                <span class="metric-unit">VND/tấn hơi</span>
              </div>
            </div>
          </div>

          <div class="tags-row">
            <span class="tag">L1: Khói thải khô</span>
            <span class="tag">L2: Ẩm do H₂</span>
            <span class="tag">L3: Ẩm sẵn trong nhiên liệu</span>
            <span class="tag">L4: Ẩm không khí</span>
            <span class="tag">L5: CO chưa cháy hết</span>
            <span class="tag">L6: Bức xạ & cơ khí</span>
            <span class="tag">L7: Cháy không hết (carbon)</span>
            <span class="tag">L8: Khác / Dự phòng (xả đáy, nước ngưng...)</span>
          </div>

          <div class="loss-columns">
            <div class="loss-group" id="lossGroupControllable">
              <div class="loss-group-title">Nhóm tổn thất CÓ THỂ kiểm soát tốt</div>
              <div id="lossListControllable"></div>
            </div>
            <div class="loss-group" id="lossGroupLess">
              <div class="loss-group-title">Nhóm tổn thất KHÓ / ÍT có thể cải thiện</div>
              <div id="lossListLess"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- PHẦN 5: GIẢI PHÁP -->
      <section class="card" id="section-advice">
        <div class="card-header">
          <div class="card-title">
            <span>PHẦN 5 – GIẢI PHÁP TỐI ƯU VẬN HÀNH</span>
            <span class="badge">Rule-based từ Vanhanh.json</span>
          </div>
        </div>
        <div class="card-body">
          <div class="section-hint">
            Hệ thống map từng tổn thất / thông số bất lợi sang nhóm lỗi – nguyên nhân – khuyến nghị.
          </div>
          <ul class="advice-list" id="adviceList"></ul>
        </div>
      </section>

      <!-- PHẦN 6: KIẾN THỨC LÒ HƠI -->
      <section class="card" id="section-knowledge">
        <div class="card-header">
          <div class="card-title">
            <span>PHẦN 6 – KIẾN THỨC LÒ HƠI</span>
            <span class="badge">Gợi ý theo tình trạng hiện tại</span>
          </div>
        </div>
        <div class="card-body">
          <div class="section-hint">
            Gợi nhắc các khuyến nghị chung về chất lượng nước, xả đáy, bảo trì, và tổn thất đang chiếm tỉ lệ cao.
          </div>
          <ul class="knowledge-list" id="knowledgeList"></ul>
        </div>
      </section>

      <!-- PHẦN 7: KIỂM TRA TÍNH TOÁN -->
      <section class="card" id="section-steps">
        <div class="card-header">
          <div class="card-title">
            <span>PHẦN 7 – KIỂM TRA TÍNH TOÁN</span>
            <span class="badge">Step 1 → Step 6</span>
          </div>
        </div>
        <div class="card-body">
          <div class="section-hint">
            Hiển thị tóm tắt các bước tính theo Cachtinh.json (As-received → Air → Flue Gas → L1–L8 → η).
          </div>
          <ul class="steps-list" id="stepsList"></ul>
        </div>
      </section>
    </section>
  </main>
</div>

<script>
/* ==========================================================
   1. JSON DỮ LIỆU – EMBED TRỰC TIẾP
   ========================================================== */

/* -------- 1.1 Nhienlieu.json (ví dụ, có thể mở rộng) -------- */
const nhienLieuJSON = {
  "fuels": [
    {
      "fuel_name": "Dăm ván lạng DNB",
      "C_db": 47.61,
      "H_db": 4.87,
      "O_db": 44.24,
      "S_db": 0.06,
      "N_db": 0.31,
      "A_db": 2.91,
      "GCV_db": 19678,
      "default_M": 40
    },
    {
      "fuel_name": "Dăm ván lạng MB",
      "C_db": 47.61,
      "H_db": 4.87,
      "O_db": 44.24,
      "S_db": 0.06,
      "N_db": 0.31,
      "A_db": 2.91,
      "GCV_db": 17011,
      "default_M": 40
    },
    {
      "fuel_name": "Trấu vỏ",
      "C_db": 36.42,
      "H_db": 4.91,
      "O_db": 35.88,
      "S_db": 0.0,
      "N_db": 0.59,
      "A_db": 22.20,
      "GCV_db": 16098,
      "default_M": 18
    }
  ]
};

/* -------- 1.2 Cachtinh.json – Đặc tả tính toán -------- */
const congThucJSON = {
  "title": "Biomass Boiler Efficiency Calculation Specification",
  "units": {
    "temperature": "°C",
    "energy": "kJ/kg",
    "pressure": "bar",
    "percentage": "%",
    "concentration": "ppm",
    "mass_flow": "kg/kg_fuel",
    "humidity_ratio": "kg_water/kg_dry_air"
  },
  "inputs": {
    "fuels": {
      "description": "Người dùng chọn 1 hoặc nhiều nhiên liệu, trộn thành hỗn hợp đốt lò.",
      "actions": ["add_fuel", "remove_fuel"],
      "per_fuel_fields": {
        "name": {
          "label": "Tên nhiên liệu",
          "type": "string",
          "source": "Nhienlieu.json",
          "key_in_library": "fuel_name"
        },
        "moisture_pct": {
          "label": "Độ ẩm",
          "type": "number",
          "unit": "%",
          "maps_to": "M_ar"
        },
        "mass_fraction_pct": {
          "label": "Phần trăm khối lượng trong hỗn hợp",
          "type": "number",
          "unit": "%",
          "description": "Dùng để tính trung bình gia quyền các thông số nhiên liệu."
        },
        "price_vnd_per_kg": {
          "label": "Giá nhiên liệu",
          "type": "number",
          "unit": "VND/kg"
        }
      }
    },
    "operation": {
      "description": "User nhập thông số đo và điều kiện vận hành lò.",
      "fields": {
        "O2_dry": { "label": "O2 khô trong khói", "type": "number", "unit": "%" },
        "CO_ppm": { "label": "CO trong khói", "type": "number", "unit": "ppm" },
        "Tf": { "label": "Nhiệt độ khói thải", "type": "number", "unit": "°C" },
        "Ta": { "label": "Nhiệt độ môi trường", "type": "number", "unit": "°C" },
        "T_fw": {
          "label": "Nhiệt độ nước cấp (bồn nước cấp)",
          "type": "number",
          "unit": "°C"
        },
        "T_b": { "label": "Nhiệt độ buồng đốt", "type": "number", "unit": "°C" },
        "T_w": {
          "label": "Nhiệt độ vách đuôi lò (chưa bảo ôn)",
          "type": "number",
          "unit": "°C"
        },
        "RH": { "label": "Độ ẩm không khí", "type": "number", "unit": "%", "default": 80 },
        "design_capacity": {
          "label": "Công suất thiết kế",
          "type": "number",
          "unit": "tấn hơi/giờ"
        },
        "actual_capacity": {
          "label": "Công suất hơi thực tế",
          "type": "number",
          "unit": "tấn hơi/giờ"
        },
        "P_g": {
          "label": "Áp suất lò (gauge)",
          "type": "number",
          "unit": "bar_g",
          "default": 10
        },
        "TDS": {
          "label": "TDS nước cấp",
          "type": "number",
          "unit": "ppm"
        },
        "BR": {
          "label": "Tỉ lệ xả đáy",
          "type": "number",
          "unit": "%",
          "description": "Tỉ lệ xả đáy tính từ TDS nước cấp."
        },
        "L6_user": {
          "label": "Tổn thất bức xạ/bảo ôn (tùy chọn)",
          "type": "number",
          "unit": "%",
          "default": 0.7
        },
        "L7_user": {
          "label": "Tổn thất cháy không hết (tùy chọn)",
          "type": "number",
          "unit": "%",
          "default": 1.5
        }
      }
    }
  }
};

/* -------- 1.3 Vanhanh.json – Losses & general warnings -------- */
const vanHanhJSON = {
  "schema_version": "1.0",
  "description": "Tài liệu tổng hợp vận hành lò hơi biomass (BFB/CFB) – tóm tắt L1–L8 và các cảnh báo cần thiết.",
  "language": "vi",
  "losses": [
    {
      "loss_id": "L1",
      "loss_name": "TỔN THẤT KHÓI THẢI KHÔ (Dry Flue Gas Loss)",
      "sections": {
        "factors": [
          "Nhiệt độ khói lò càng cao thì tổn thất càng lớn; nếu giảm quá thấp dễ ngưng tụ axit (H₂SO₄, HCl, HF) gây ăn mòn đuôi lò.",
          "Oxi dư (O₂_dry) cao làm tăng khối lượng khói thải, tăng tổn thất; O₂ quá thấp gây cháy không hoàn toàn, sinh CO, giảm hiệu suất.",
          "Độ sạch bề mặt truyền nhiệt: muội bám trên ống sinh hơi, bộ hâm, bộ sấy làm giảm trao đổi nhiệt, khiến nhiệt độ khói tăng dần."
        ],
        "optimal_parameters": [
          "O₂_dry: 4% – 8.5% (tối ưu cho hầu hết nhiên liệu sinh khối).",
          "Nhiệt độ khí thải sau bộ hâm nước (economizer): khoảng 145–155°C.",
          "Nhiệt độ vách kim loại phần đuôi lò (Tw): Tw > 80°C để tránh ngưng tụ H₂SO₄."
        ],
        "symptoms": [
          "Nhiệt độ khí thải tăng dần theo thời gian trong cùng điều kiện tải và nhiên liệu.",
          "Giá trị O₂ dư cao kéo dài, thường xuyên > 9%.",
          "Hiệu suất tổng thể lò hơi giảm."
        ],
        "operational_actions": [
          "Kiểm soát O₂ hợp lý: nếu O₂ < 4% thì tăng quạt cấp gió; nếu O₂ > 8.5% thì giảm lưu lượng gió.",
          "Giảm nhiệt độ khí thải bằng cách tối ưu bộ hâm nước (economizer) và/hoặc bộ sấy không khí (air-preheater).",
          "Vệ sinh định kỳ bề mặt truyền nhiệt.",
          "Cải thiện chất lượng nhiên liệu: giảm độ ẩm, kiểm soát kích thước đồng đều."
        ]
      }
    },
    {
      "loss_id": "L2",
      "loss_name": "TỔN THẤT DO HƠI ẨM HÌNH THÀNH TỪ H₂ TRONG NHIÊN LIỆU",
      "sections": {
        "factors": [
          "Hàm lượng hydro (H_db) trong nhiên liệu càng cao thì lượng hơi nước sinh ra trong quá trình cháy càng lớn.",
          "Hơi nước mang theo một phần nhiệt ra khỏi buồng đốt, làm tăng tổn thất L2."
        ],
        "operational_actions": [
          "Đây là tổn thất mang tính đặc trưng của thành phần nhiên liệu biomass, khó can thiệp nhiều bằng vận hành.",
          "Khi có thể lựa chọn, ưu tiên nhiên liệu có thành phần phù hợp và độ ẩm không quá cao."
        ]
      }
    },
    {
      "loss_id": "L3",
      "loss_name": "TỔN THẤT DO HƠI ẨM CÓ SẴN TRONG NHIÊN LIỆU (W – Moisture)",
      "sections": {
        "factors": [
          "Độ ẩm trong nhiên liệu càng cao thì càng phải dùng nhiệt để hóa hơi lượng nước này, làm giảm nhiệt cháy hữu ích.",
          "GCV của nhiên liệu giảm mạnh khi độ ẩm tăng, buồng đốt khó đạt ~850°C.",
          "Độ ẩm cao làm tăng tạo muội, giảm tốc độ cháy, dễ gây cháy không kiệt."
        ],
        "optimal_parameters": [
          "Độ ẩm sinh khối < 45% là tốt nhất cho lò BFB."
        ],
        "symptoms": [
          "Nhiệt độ buồng đốt thấp, thường < 700°C.",
          "Áp suất hơi yếu, không ổn định.",
          "Khói trắng nhiều, thể hiện nhiều hơi nước."
        ],
        "operational_actions": [
          "Phối trộn nhiên liệu khô hơn với nhiên liệu ẩm cao để giảm ẩm trung bình.",
          "Điều chỉnh chính sách thu mua: ưu tiên nhiên liệu có W < 45%.",
          "Ưu tiên tăng nhiệt gió cấp 1 để hỗ trợ cháy."
        ]
      }
    },
    {
      "loss_id": "L4",
      "loss_name": "TỔN THẤT DO HƠI ẨM TRONG KHÔNG KHÍ (Air Moisture Loss)",
      "sections": {
        "factors": [
          "Không khí có độ ẩm cao làm tăng lượng hơi nước đi vào lò qua gió cấp."
        ],
        "operational_actions": [
          "Đây là điều kiện khách quan do thời tiết, khó điều chỉnh trực tiếp bằng vận hành.",
          "Tăng cường kiểm tra cách nhiệt, bề mặt kim loại lạnh để tránh ngưng tụ và ăn mòn."
        ]
      }
    },
    {
      "loss_id": "L5",
      "loss_name": "TỔN THẤT DO CO CHƯA CHÁY HẾT",
      "sections": {
        "factors": [
          "O₂ dư quá thấp (< 4%) dẫn đến thiếu oxy cho cháy hoàn toàn.",
          "Nhiệt độ buồng đốt thấp làm phản ứng cháy không triệt để.",
          "Kích thước nhiên liệu quá lớn hoặc phân bố kích thước không hợp lý gây cháy không đều.",
          "Phân phối gió cấp 1 – cấp 2 chưa hợp lý."
        ],
        "optimal_parameters": [
          "O₂ dư: 4–8.5%.",
          "Nhiệt độ buồng đốt: khoảng 850°C."
        ],
        "symptoms": [
          "Nồng độ CO trong khói thải tăng.",
          "Khói màu nâu hoặc xám đậm, có mùi khét."
        ],
        "operational_actions": [
          "Tăng quạt gió khi O₂ < 4%.",
          "Tăng nhiệt độ buồng đốt bằng phối trộn nhiên liệu, ưu tiên nhiên liệu ẩm thấp.",
          "Điều chỉnh lại phân phối gió cấp 1 và cấp 2 hợp lý."
        ]
      }
    },
    {
      "loss_id": "L6",
      "loss_name": "TỔN THẤT BỨC XẠ & CƠ KHÍ",
      "sections": {
        "factors": [
          "Bảo ôn kém làm nhiệt thoát ra qua tường lò, vỏ lò, bề mặt ống.",
          "Rò rỉ khí, rò rỉ gió phụ qua các khe hở, cửa lò, mặt bích."
        ],
        "optimal_parameters": [
          "Bảo ôn đạt tiêu chuẩn, không rỗ, nứt, bong tróc.",
          "Không để Tw < 80°C ở ống đuôi vì dễ ăn mòn."
        ],
        "symptoms": [
          "Tường lò nóng rát khi chạm tay.",
          "Tiêu thụ nhiên liệu tăng bất thường khi tải không đổi."
        ],
        "operational_actions": [
          "Tăng cường bảo ôn toàn bộ bề mặt lò, ống.",
          "Kiểm tra rò gió, rò khói; siết chặt mặt bích, bít các khe hở không cần thiết."
        ]
      }
    },
    {
      "loss_id": "L7",
      "loss_name": "TỔN THẤT CHÁY KHÔNG HẾT (CARBON CHƯA CHÁY)",
      "sections": {
        "factors": [
          "Nhiên liệu quá to hoặc không đồng đều làm khó cháy kiệt.",
          "Điều chỉnh quạt hút quá cao làm tro cháy bị hút ra khi chưa cháy hết.",
          "Nhiệt độ buồng đốt không đủ do nhiên liệu ẩm cao."
        ],
        "optimal_parameters": [
          "Nhiệt độ buồng đốt: 700–950°C, tốt nhất khoảng 850°C."
        ],
        "symptoms": [
          "Tro xỉ có nhiều mảnh đen (carbon chưa cháy).",
          "Khói xám, đen, nhiều hạt muội."
        ],
        "operational_actions": [
          "Phối trộn nhiên liệu hợp lý, tránh quá nhiều hạt nhiên liệu quá to hoặc quá ẩm.",
          "Tăng nhiệt độ buồng đốt, tối ưu phân phối gió.",
          "Điều chỉnh quạt hút ở mức hợp lý."
        ]
      }
    },
    {
      "loss_id": "L8",
      "loss_name": "TỔN THẤT KHÁC / DỰ PHÒNG",
      "sections": {
        "factors": [
          "Xả đáy quá mức làm thất thoát nhiều nước nóng và nhiệt.",
          "Không thu hồi nước ngưng từ hệ thống sử dụng hơi.",
          "Vận hành lò dưới tải quá thấp (< 20%) trong thời gian dài."
        ],
        "optimal_parameters": [
          "Blowdown theo TDS thực tế, giữ TDS nước lò < 3500 ppm.",
          "Thu hồi tối đa nước ngưng."
        ],
        "operational_actions": [
          "Kiểm soát TDS, tăng cường xả đáy hợp lý, tránh xả quá ít hoặc quá nhiều.",
          "Lắp bộ thu hồi nhiệt xả đáy.",
          "Thu hồi nước ngưng triệt để.",
          "Tránh chạy tải < 20%."
        ]
      }
    }
  ],
  "general_warnings": [
    {
      "warning_id": "W1",
      "title": "Chất lượng nước cấp",
      "parameters": [
        "Độ cứng nước cấp < 3 ppm.",
        "TDS nước cấp < 300–500 ppm.",
        "pH nước cấp: 6.5–9."
      ],
      "notes": "Nước cấp sạch giúp hạn chế cáu cặn, giảm ăn mòn, cải thiện truyền nhiệt và giảm tổn thất."
    },
    {
      "warning_id": "W2",
      "title": "Quy trình xả đáy",
      "parameters": [
        "Đo TDS mỗi ca để điều chỉnh chế độ xả đáy.",
        "Giữ TDS nước lò < 3500 ppm.",
        "Sử dụng bể giãn nở và thu hồi nhiệt xả đáy."
      ],
      "notes": "Xả đáy hợp lý giúp duy trì chất lượng nước lò và hơi, đồng thời giảm tổn thất L8."
    },
    {
      "warning_id": "W3",
      "title": "Bảo trì & vệ sinh định kỳ",
      "parameters": [
        "Thổi muội khi nhiệt độ khói thải tăng so với baseline.",
        "Kiểm tra rò gió, rò hơi, rò khói định kỳ.",
        "Hiệu chuẩn cảm biến nhiệt độ, O₂, áp suất, lưu lượng."
      ],
      "notes": "Bảo trì và vệ sinh định kỳ giúp duy trì hiệu suất lò, hạn chế tổn thất do bám muội, cáu cặn, rò rỉ và sai số đo lường."
    }
  ]
};

/* -------- 1.4 Canhbao.json – Ngưỡng cảnh báo (rút gọn) -------- */
const canhBaoJSON = {
  "fuel_moisture": {
    "param": "W",
    "levels": [
      { "level": 0, "max": 35, "label": "Bình thường", "color": "green",
        "message": "Độ ẩm nhiên liệu rất tốt (≤ 35%). Cháy khỏe, dễ giữ T_b ~ 850°C." },
      { "level": 1, "min": 35, "max": 55, "label": "Cảnh báo", "color": "yellow",
        "message": "Độ ẩm nhiên liệu cao, buồng đốt dễ tụt nhiệt độ, tiêu hao nhiên liệu tăng." },
      { "level": 2, "min": 55, "label": "Nguy hiểm", "color": "red",
        "message": "W > 55%. Rất khó giữ nhiệt độ buồng đốt; nguy cơ cháy không kiệt, CO cao, hiệu suất giảm mạnh." }
    ]
  },
  "furnace_temp": {
    "param": "T_b",
    "levels": [
      { "level": 2, "max": 550, "label": "Nguy hiểm (thấp)", "color": "red",
        "message": "T_b < 550°C: cháy rất kém, CO cao, khó đáp ứng tải." },
      { "level": 1, "min": 550, "max": 700, "label": "Cảnh báo (thiếu nhiệt)", "color": "yellow",
        "message": "550°C ≤ T_b < 700°C: cháy kém, dễ sinh CO, áp suất hơi dao động." },
      { "level": 0, "min": 700, "max": 950, "label": "Bình thường", "color": "green",
        "message": "700–950°C: vùng làm việc tốt, ưu tiên ~850°C." },
      { "level": 1, "min": 950, "label": "Cảnh báo (quá nóng)", "color": "yellow",
        "message": "T_b > 950°C: nguy cơ kết khối/xỉ, bám muội mạnh, cần xem lại phân phối gió & tải." }
    ]
  },
  "O2_dry": {
    "param": "O2_dry",
    "levels": [
      { "level": 2, "max": 3, "label": "Nguy hiểm (thiếu gió)", "color": "red",
        "message": "O₂_dry < 3%: rất dễ sinh CO cao, cháy không hoàn toàn." },
      { "level": 1, "min": 3, "max": 4, "label": "Cảnh báo thiếu gió", "color": "yellow",
        "message": "3–4%: bắt đầu nguy cơ thiếu gió, có thể xuất hiện CO." },
      { "level": 0, "min": 4, "max": 8.5, "label": "Bình thường", "color": "green",
        "message": "4–8.5%: dải O₂ tối ưu cho sinh khối." },
      { "level": 1, "min": 8.5, "max": 9, "label": "Cảnh báo dư gió", "color": "yellow",
        "message": "8.5–9%: khói thải tăng, tổn thất L1 tăng." },
      { "level": 2, "min": 9, "label": "Nguy hiểm (dư gió)", "color": "red",
        "message": "O₂_dry > 9%: tổn thất khói thải rất lớn, hiệu suất tụt rõ rệt." }
    ]
  },
  "T_fw": {
    "param": "T_fw",
    "levels": [
      { "level": 2, "max": 60, "label": "Nguy hiểm (nước cấp lạnh)", "color": "red",
        "message": "T_fw < 60°C: nước cấp rất lạnh, sốc nhiệt, nguy cơ nứt nhiệt." },
      { "level": 1, "min": 60, "max": 80, "label": "Cảnh báo", "color": "yellow",
        "message": "60–80°C: nước cấp hơi lạnh, phải đốt nhiều nhiên liệu hơn." },
      { "level": 0, "min": 80, "max": 105, "label": "Bình thường", "color": "green",
        "message": "80–105°C: dải khuyến nghị, hỗ trợ khử khí tốt." },
      { "level": 1, "min": 105, "max": 115, "label": "Cảnh báo (quá nóng)", "color": "yellow",
        "message": "105–115°C: nguy cơ xâm thực bơm nước cấp." },
      { "level": 2, "min": 115, "label": "Nguy hiểm", "color": "red",
        "message": "T_fw > 115°C: đa số bơm không còn phù hợp, rất dễ hỏng bơm." }
    ]
  },
  "T_stack": {
    "param": "T_stack",
    "levels": [
      { "level": 2, "max": 100, "label": "Nguy hiểm (ăn mòn)", "color": "red",
        "message": "T_stack < 100°C (đặc biệt khi W cao): nguy cơ ngưng tụ axit, ăn mòn mạnh phần đuôi lò." },
      { "level": 1, "min": 120, "max": 145, "label": "Cảnh báo (thấp)", "color": "yellow",
        "message": "120–145°C: cần theo dõi nguy cơ ngưng tụ khi độ ẩm môi trường cao." },
      { "level": 0, "min": 145, "max": 155, "label": "Bình thường", "color": "green",
        "message": "145–155°C: vùng tối ưu giữa hiệu suất và chống ăn mòn." },
      { "level": 1, "min": 155, "max": 180, "label": "Cảnh báo (cao)", "color": "yellow",
        "message": "155–180°C: bắt đầu lãng phí nhiệt, thường do bám muội/cáu cặn." },
      { "level": 2, "min": 180, "label": "Nguy hiểm (rất cao)", "color": "red",
        "message": "T_stack > 180°C: tổn thất rất lớn, nguy cơ cháy túi vải lọc bụi." }
    ]
  },
  "T_w": {
    "param": "T_w",
    "levels": [
      { "level": 2, "max": 70, "label": "Nguy hiểm", "color": "red",
        "message": "Tw < 70°C: nguy cơ ăn mòn mạnh, thủng ống, rò rỉ." },
      { "level": 1, "min": 70, "max": 80, "label": "Cảnh báo", "color": "yellow",
        "message": "70–80°C: bắt đầu nguy cơ ngưng tụ axit trên bề mặt kim loại." },
      { "level": 0, "min": 80, "max": 120, "label": "Bình thường", "color": "green",
        "message": "80–120°C: vùng an toàn cho ống đuôi lò." }
    ]
  },
  "load": {
    "param": "Load",
    "levels": [
      { "level": 1, "max": 20, "label": "Nguy hiểm (tải rất thấp)", "color": "red",
        "message": "Load < 20%: vận hành dưới tải quá thấp, tổn thất lớn, khó giữ T_b và O₂." },
      { "level": 1, "min": 20, "max": 35, "label": "Cảnh báo (tải thấp)", "color": "yellow",
        "message": "20–35%: hiệu suất bắt đầu giảm, O₂ thường cao hơn." },
      { "level": 0, "min": 35, "max": 85, "label": "Bình thường", "color": "green",
        "message": "35–85%: dải tải hiệu quả, dễ tối ưu O₂ và nhiệt khói." },
      { "level": 1, "min": 85, "label": "Cảnh báo (tải cao)", "color": "yellow",
        "message": "Load > 85%: tổn thất L1 tăng rõ rệt, rủi ro sự cố nâng cao (đặc biệt nếu >100%)." }
    ]
  },
  "TDS_boiler": {
    "param": "TDS_boiler",
    "levels": [
      { "level": 0, "max": 2500, "label": "Bình thường", "color": "green",
        "message": "TDS nước lò ≤ 2500 ppm: ít nguy cơ sôi bọt, cuốn nước theo hơi." },
      { "level": 1, "min": 2500, "max": 3500, "label": "Cảnh báo", "color": "yellow",
        "message": "2500–3500 ppm: bắt đầu nguy cơ sôi bọt, cuốn nước; cần tăng xả đáy." },
      { "level": 2, "min": 3500, "label": "Nguy hiểm", "color": "red",
        "message": "TDS nước lò > 3500 ppm: dễ kéo nước vào hơi, cáu cặn tăng nhanh." }
    ]
  }
};

/* ==========================================================
   2. HÀM TIỆN ÍCH & ĐỌC INPUT
   ========================================================== */

function getFuelByName(name) {
  return nhienLieuJSON.fuels.find(f => f.fuel_name === name);
}

function parseNumber(value, fallback = 0) {
  const v = parseFloat(value);
  return Number.isFinite(v) ? v : fallback;
}

function approxPsat_kPa(T) {
  // Công thức Magnus cho áp suất bão hòa nước (°C → kPa)
  const e = 0.61094 * Math.exp((17.625 * T) / (T + 243.04));
  return e * 10; // 1 hPa ~ 0.1 kPa; dùng hệ số gần đúng, mục đích vận hành
}

function approxSteamProps(Pg_bar) {
  // Ước lượng đơn giản: Tsat ≈ 100 + 3*Pg
  const Tsat = 100 + 3 * Pg_bar;
  const h_f = 4.18 * Tsat;       // ~kJ/kg nước sôi
  const h_steam = 2746 + 5 * (Pg_bar - 10); // kJ/kg, xấp xỉ quanh 10 bar
  return { Tsat, h_f, h_steam };
}

function getFuelRowsData() {
  const rows = Array.from(document.querySelectorAll(".fuel-row"));
  let fuels = [];
  for (const row of rows) {
    const fuelName = row.querySelector(".fuel-name").value;
    if (!fuelName) continue;
    const fuel = getFuelByName(fuelName);
    if (!fuel) continue;
    const moisture = parseNumber(row.querySelector(".fuel-moisture").value, fuel.default_M ?? 40);
    const mf = parseNumber(row.querySelector(".fuel-mf").value, 0);
    const price = parseNumber(row.querySelector(".fuel-price").value, 0);

    fuels.push({
      fuel,
      M_ar: moisture,
      mass_fraction_pct: mf,
      price_vnd_per_kg: price
    });
  }
  return fuels;
}

function getOperationInputs() {
  const O2_dry = parseNumber(document.getElementById("inpO2").value);
  const CO_ppm = parseNumber(document.getElementById("inpCO").value);
  const Tf = parseNumber(document.getElementById("inpTf").value);
  const Ta = parseNumber(document.getElementById("inpTa").value);
  const T_fw = parseNumber(document.getElementById("inpTfw").value);
  const T_b = parseNumber(document.getElementById("inpTb").value);
  const T_w = parseNumber(document.getElementById("inpTw").value);
  const RH = parseNumber(document.getElementById("inpRH").value || "80", 80);
  const P_g = parseNumber(document.getElementById("inpPg").value || "10", 10);
  const design_capacity = parseNumber(document.getElementById("inpDesignCap").value);
  const actual_capacity = parseNumber(document.getElementById("inpActualCap").value);
  const TDS_fw = parseNumber(document.getElementById("inpTDS").value);
  let BR = document.getElementById("inpBR").value;
  let BR_val = parseNumber(BR);
  if (!BR && TDS_fw > 0) {
    // Gợi ý BR ~ phụ thuộc TDS nước cấp (σ đơn giản)
    BR_val = Math.max(1, Math.min(10, (TDS_fw / 300) * 3));
  }
  const L6_user = document.getElementById("inpL6User").value;
  const L7_user = document.getElementById("inpL7User").value;

  return {
    O2_dry,
    CO_ppm,
    Tf,
    Ta,
    T_fw,
    T_b,
    T_w,
    RH,
    P_g,
    design_capacity,
    actual_capacity,
    TDS_fw,
    BR: BR_val,
    L6_user: L6_user ? parseNumber(L6_user) : null,
    L7_user: L7_user ? parseNumber(L7_user) : null
  };
}

/* ==========================================================
   3. CHUỖI TÍNH TOÁN CHÍNH
   ========================================================== */

// Bước 1 – As-received & hỗn hợp nhiên liệu
function convertAsReceived(selectedFuels) {
  if (!selectedFuels.length) {
    return null;
  }
  // Scale mass_fraction_pct về tổng 1.0 kg
  let sumMF = selectedFuels.reduce((s, f) => s + f.mass_fraction_pct, 0);
  if (sumMF <= 0) sumMF = 100;
  const factor = 1 / sumMF;

  let totalMass = 0;
  let mass_C = 0, mass_H = 0, mass_O = 0, mass_S = 0, mass_N = 0, mass_A = 0;
  let massWater = 0;
  let sumGCVdry = 0;
  let sumPrice = 0;

  for (const sf of selectedFuels) {
    const m_mix = sf.mass_fraction_pct * factor; // kg trên 1 kg hỗn hợp
    const M = sf.M_ar; // %
    const m_dry = m_mix * (1 - M / 100);
    const m_w = m_mix - m_dry;

    const { C_db, H_db, O_db, S_db, N_db, A_db, GCV_db } = sf.fuel;
    mass_C += m_dry * (C_db / 100);
    mass_H += m_dry * (H_db / 100);
    mass_O += m_dry * (O_db / 100);
    mass_S += m_dry * (S_db / 100);
    mass_N += m_dry * (N_db / 100);
    mass_A += m_dry * (A_db / 100);
    massWater += m_w;
    sumGCVdry += m_dry * GCV_db;
    sumPrice += m_mix * sf.price_vnd_per_kg;
    totalMass += m_mix;
  }

  // Tổng mass ≈ 1 kg
  const C_ar = (mass_C / totalMass) * 100;
  const H_ar = (mass_H / totalMass) * 100;
  const O_ar = (mass_O / totalMass) * 100;
  const S_ar = (mass_S / totalMass) * 100;
  const N_ar = (mass_N / totalMass) * 100;
  const A_ar = (mass_A / totalMass) * 100;
  const M_ar = (massWater / totalMass) * 100;
  const GCV_ar = sumGCVdry / totalMass;
  const price_avg = sumPrice / totalMass;

  const c = C_ar / 100;
  const h = H_ar / 100;
  const o = O_ar / 100;
  const s = S_ar / 100;
  const n = N_ar / 100;
  const a = A_ar / 100;
  const m = M_ar / 100;

  return {
    C_ar, H_ar, O_ar, S_ar, N_ar, A_ar, M_ar,
    GCV_ar,
    price_avg,
    c, h, o, s, n, a, m
  };
}

// Bước 2 – Air: O₂_req, A_th, λ, A_act
function calculateAir(mix, op) {
  const { c, h, o, s } = mix;
  const { O2_dry, CO_ppm } = op;
  const O2_req = 2.667 * c + 8 * h + s - o;  // kg O2/kg nhiên liệu
  const A_th = O2_req / 0.232;               // kg không khí lý thuyết/kg nhiên liệu
  const CO_vol = CO_ppm / 10000;            // %vol
  const lambda = 21 / (21 - O2_dry - 0.5 * CO_vol);
  const A_act = lambda * A_th;
  return { O2_req, A_th, lambda, A_act, CO_vol };
}

// Bước 3–4 – Flue gas & Cp
function calculateFlueGas(mix, op, air) {
  const { c, h, s, n, a, m } = mix;
  const { CO_ppm } = op;
  const { A_act } = air;

  const m_dg = A_act + 1 - a - m - 9 * h; // kg khí khô/kg nhiên liệu
  const K = CO_ppm * 12 / 1000000;
  const N_dg = (A_act * 0.03468 - h / 4 + n / 28) / (1 - K / 24);
  const c_CO = K * N_dg;

  const mass_CO2 = 3.667 * (c - c_CO);
  const mass_CO = 2.333 * c_CO;
  const mass_SO2 = 2 * s;
  const mass_O2 = A_act * 0.232 - (2.667 * c - 1.333 * c_CO + 8 * h + s - mix.o);
  const mass_N2 = A_act * 0.768 + n;

  const f_CO2 = mass_CO2 / m_dg;
  const f_CO = mass_CO / m_dg;
  const f_SO2 = mass_SO2 / m_dg;
  const f_O2 = mass_O2 / m_dg;
  const f_N2 = mass_N2 / m_dg;

  const Cp_CO2 = 0.203;
  const Cp_O2 = 0.217;
  const Cp_N2 = 0.248;
  const Cp_SO2 = 0.153;
  const Cp_CO = 0.248;

  const Cp_dg =
      f_CO2 * Cp_CO2 +
      f_O2 * Cp_O2 +
      f_N2 * Cp_N2 +
      f_SO2 * Cp_SO2 +
      f_CO * Cp_CO;

  return {
    m_dg,
    c_CO,
    N_dg,
    Cp_dg,
    fractions: { f_CO2, f_CO, f_SO2, f_O2, f_N2 }
  };
}

// Bước 5 – Tổn thất L1–L8 (mapping lại theo spec mới)
function calculateLosses(mix, op, air, fg) {
  const { GCV_ar, m, h } = mix;
  const { Tf, Ta, RH, P_g, T_fw, BR, L6_user, L7_user } = op;
  const { A_act } = air;
  const { m_dg, c_CO, Cp_dg } = fg;

  const P_abs = P_g + 1;
  const { Tsat, h_f, h_steam } = approxSteamProps(P_g);
  const h_fw = 4.18 * T_fw;

  // Tổn thất cơ sở từ đặc tả cũ
  const L_CO = (c_CO * 24100) / GCV_ar * 100;                         // CO
  const L_dry = (m_dg * Cp_dg * (Tf - Ta)) / GCV_ar * 100;            // khói khô
  const L_fuel_moist = (m * (2450 + 1.88 * (Tf - Ta))) / GCV_ar * 100; // ẩm trong nhiên liệu
  const L_H_moist = (9 * h * (2450 + 1.88 * (Tf - Ta))) / GCV_ar * 100; // hơi ẩm do H₂
  const P_v = (RH / 100) * approxPsat_kPa(Ta);
  const omega = 0.622 * P_v / (101.325 - P_v);
  const L_air_moist = (A_act * omega * 1.88 * (Tf - Ta)) / GCV_ar * 100; // ẩm không khí

  // Blowdown (tổn thất khác / dự phòng)
  const eta_init = 0.9;
  const L_blowdown = eta_init * (BR / 100) * (h_f - h_fw) / (h_steam - h_fw) * 100;

  // L6, L7 do user nhập (bức xạ & carbon chưa cháy)
  const L6 = L6_user != null ? L6_user : 0.7;
  const L7 = L7_user != null ? L7_user : 1.5;

  // Mapping cuối theo định nghĩa mới:
  // L1: khói thải khô
  // L2: hơi ẩm từ H₂
  // L3: ẩm sẵn trong nhiên liệu
  // L4: ẩm không khí
  // L5: CO chưa cháy hết
  // L6: bức xạ & cơ khí (user)
  // L7: cháy không hết (carbon) (user)
  // L8: khác / dự phòng (xả đáy, nước ngưng...)
  const L1 = L_dry;
  const L2 = L_H_moist;
  const L3 = L_fuel_moist;
  const L4 = L_air_moist;
  const L5 = L_CO;
  const L8 = L_blowdown;

  return {
    L1, L2, L3, L4, L5, L6, L7, L8,
    details: {
      L_CO,
      L_dry,
      L_fuel_moist,
      L_H_moist,
      L_air_moist,
      L_blowdown,
      P_abs,
      Tsat,
      h_f,
      h_steam,
      h_fw,
      omega
    }
  };
}

// Bước 6 – Hiệu suất & tiêu hao nhiên liệu
function calculateEfficiency(mix, op, losses) {
  const { GCV_ar, price_avg } = mix;
  const { T_fw, P_g } = op;
  const { L1, L2, L3, L4, L5, L6, L7, L8 } = losses;

  const sumLoss = L1 + L2 + L3 + L4 + L5 + L6 + L7 + L8;
  const eta = 100 - sumLoss;

  const { h_f, h_steam } = approxSteamProps(P_g);
  const h_fw = 4.18 * T_fw;
  const q_useful = h_steam - h_fw; // kJ/kg hơi

  // Nhiên liệu / 1 tấn hơi (kg/tấn hơi)
  // Năng lượng cần cho 1 kg hơi = q_useful; 1 kg nhiên liệu cung cấp ≈ eta/100 * GCV_ar
  const fuel_per_kg_steam = q_useful / (eta / 100 * GCV_ar);
  const fuel_per_ton_steam = fuel_per_kg_steam * 1000;

  const steam_cost = fuel_per_ton_steam * price_avg;

  return {
    eta,
    fuel_per_ton_steam,
    steam_cost,
    q_useful
  };
}

/* ==========================================================
   4. RULE-BASED ADVICE & KNOWLEDGE
   ========================================================== */

function classifyLossValue(value) {
  if (!Number.isFinite(value)) return "neutral";
  if (value >= 8) return "bad";
  if (value >= 3) return "warn";
  return "ok";
}

function buildRuleBasedAdvice(mix, op, losses, efficiency) {
  const advices = [];
  const { eta } = efficiency;
  const { L1, L2, L3, L4, L5, L6, L7, L8 } = losses;
  const { O2_dry, T_b, T_w, Tf, RH, T_fw, design_capacity, actual_capacity, TDS_fw } = op;

  const load = design_capacity > 0 ? (actual_capacity / design_capacity) * 100 : null;

  function pushAdvice(lossId, severity, condition, extraNote) {
    const loss = vanHanhJSON.losses.find(l => l.loss_id === lossId);
    if (!loss) return;
    advices.push({
      loss_id: lossId,
      title: loss.loss_name,
      severity,
      condition,
      summary: loss.sections.factors?.[0] || "",
      actions: loss.sections.operational_actions || [],
      extraNote
    });
  }

  // L1 cao
  if (L1 > 8 || (Tf > 180) || (O2_dry > 8.5)) {
    let note = [];
    if (Tf > 180) note.push("T_stack (Tf) > 180°C");
    if (O2_dry > 8.5) note.push(`O₂_dry = ${O2_dry.toFixed(1)}% > 8.5%`);
    pushAdvice("L1", L1 > 12 ? "high" : "medium", "Tổn thất khói thải khô cao", note.join("; "));
  }

  // L3 cao, W lớn
  if (L3 > 5 || mix.M_ar > 45) {
    pushAdvice("L3", L3 > 8 ? "high" : "medium", "Độ ẩm nhiên liệu cao, L3 lớn",
      `Độ ẩm hỗn hợp W ≈ ${mix.M_ar.toFixed(1)}%.`);
  }

  // L5 – CO, nếu CO_ppm lớn
  if (L5 > 1 || op.CO_ppm > 400) {
    pushAdvice("L5", L5 > 3 ? "high" : "medium", "CO cao, cháy không hoàn toàn",
      `CO đo được ≈ ${op.CO_ppm.toFixed(0)} ppm.`);
  }

  // L7 – tro xỉ chưa cháy
  if (L7 > 1.5) {
    pushAdvice("L7", L7 > 3 ? "high" : "medium", "Tổn thất cháy không hết (tro nhiều carbon).");
  }

  // L8 – blowdown & nước ngưng
  if (L8 > 1 || TDS_fw > 300) {
    pushAdvice("L8", L8 > 3 ? "high" : "medium",
      "Xả đáy / thu hồi nước ngưng chưa tối ưu.",
      `TDS nước cấp ≈ ${TDS_fw.toFixed(0)} ppm.`);
  }

  // Load quá thấp hoặc quá cao
  if (load != null) {
    if (load < 35 || load > 85) {
      const severity = (load < 20 || load > 100) ? "high" : "medium";
      advices.push({
        loss_id: "LOAD",
        title: "Chế độ tải lò",
        severity,
        condition: `Tải lò ≈ ${load.toFixed(1)}% công suất thiết kế.`,
        summary: "Chạy quá thấp hoặc quá cao so với dải tối ưu 35–85% sẽ làm hiệu suất giảm.",
        actions: [
          "Cân nhắc điều chỉnh kế hoạch sản xuất để lò làm việc trong vùng tải 35–85%.",
          "Nếu thường xuyên phải chạy rất thấp (<20%), cần xem xét cải tiến buồng đốt cho phù hợp tải nhỏ."
        ]
      });
    }
  }

  // Hiệu suất tổng thể thấp
  if (eta < 78) {
    advices.push({
      loss_id: "ETA",
      title: "Hiệu suất tổng thể",
      severity: "high",
      condition: `Hiệu suất η ≈ ${eta.toFixed(1)}% (thấp hơn mong muốn 80–88%).`,
      summary: "Tổng tổn thất L1–L8 đang ở mức cao, cần rà soát đồng bộ nhiên liệu – không khí – nước – bảo ôn.",
      actions: [
        "Giảm L1 bằng cách tối ưu O₂_dry, vệ sinh bề mặt truyền nhiệt, kiểm soát bám muội.",
        "Giảm L3 bằng chính sách nhiên liệu (ưu tiên W ≤ 45%), phối trộn nhiên liệu khô hơn.",
        "Giảm L5, L7 bằng tối ưu phân phối gió, nhiệt độ buồng đốt, kích thước nhiên liệu.",
        "Kiểm tra lại hệ thống thu hồi nước ngưng, xả đáy theo TDS thực tế để giảm L8."
      ]
    });
  }

  return advices;
}

function displayKnowledgeSection(mix, op, losses, efficiency) {
  const items = [];

  // Khuyến nghị chung về nước, xả đáy, bảo trì
  vanHanhJSON.general_warnings.forEach(w => {
    items.push({
      title: w.title,
      content: (w.parameters || []).join(" • ") + (w.notes ? " – " + w.notes : "")
    });
  });

  // Thêm một số kiến thức theo tổn thất nổi trội
  const entries = [
    { id: "L1", value: losses.L1 },
    { id: "L3", value: losses.L3 },
    { id: "L5", value: losses.L5 },
    { id: "L7", value: losses.L7 },
    { id: "L8", value: losses.L8 }
  ];
  entries
    .sort((a, b) => b.value - a.value)
    .slice(0, 2)
    .forEach(e => {
      const loss = vanHanhJSON.losses.find(l => l.loss_id === e.id);
      if (!loss) return;
      items.push({
        title: loss.loss_name,
        content: (loss.sections.factors || []).join(" • ")
      });
    });

  return items;
}

/* ==========================================================
   5. CẢNH BÁO THEO CANHBAO.JSON
   ========================================================== */

function evalThreshold(thr, value) {
  if (!Number.isFinite(value)) return null;
  const min = (thr.min !== undefined) ? thr.min : -Infinity;
  const max = (thr.max !== undefined) ? thr.max : Infinity;
  if (value >= min && value <= max) return thr;
  return null;
}

function buildWarnings(mix, op) {
  const warnings = [];
  const avgW = mix ? mix.M_ar : null;
  const { T_b, O2_dry, T_fw, Tf, T_w, design_capacity, actual_capacity, TDS_fw } = op;

  const load = design_capacity > 0 ? (actual_capacity / design_capacity) * 100 : null;

  function checkBlock(key, value, label) {
    const block = canhBaoJSON[key];
    if (!block || !Number.isFinite(value)) return;
    for (const lvl of block.levels) {
      const hit = evalThreshold(lvl, value);
      if (hit) {
        warnings.push({
          key,
          paramLabel: label,
          value,
          level: hit.level,
          label: hit.label,
          message: hit.message
        });
        break;
      }
    }
  }

  if (avgW != null) checkBlock("fuel_moisture", avgW, "Độ ẩm nhiên liệu W");
  if (T_b) checkBlock("furnace_temp", T_b, "Nhiệt độ buồng đốt T_b");
  if (O2_dry) checkBlock("O2_dry", O2_dry, "O₂_dry");
  if (T_fw) checkBlock("T_fw", T_fw, "Nhiệt độ nước cấp T_fw");
  if (Tf) checkBlock("T_stack", Tf, "Nhiệt độ khói Tf");
  if (T_w) checkBlock("T_w", T_w, "Nhiệt độ vách đuôi lò T_w");
  if (load != null) checkBlock("load", load, "Tải lò (%)");

  // TDS nước cấp > 300 ppm – cảnh báo
  if (TDS_fw > 0) {
    if (TDS_fw <= 300) {
      warnings.push({
        key: "TDS_fw",
        paramLabel: "TDS nước cấp",
        value: TDS_fw,
        level: 0,
        label: "Bình thường",
        message: "TDS nước cấp ≤ 300 ppm – chất lượng nước đạt khuyến nghị."
      });
    } else {
      warnings.push({
        key: "TDS_fw",
        paramLabel: "TDS nước cấp",
        value: TDS_fw,
        level: 2,
        label: "Nguy hiểm",
        message: "TDS nước cấp > 300 ppm – cần kiểm tra hệ xử lý nước / RO / softener."
      });
    }
  }

  return warnings;
}

/* ==========================================================
   6. RENDER UI
   ========================================================== */

function createFuelRow(initialIndex = 0) {
  const row = document.createElement("div");
  row.className = "fuel-row";

  const select = document.createElement("select");
  select.className = "fuel-name";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "— Chọn nhiên liệu —";
  select.appendChild(opt0);
  nhienLieuJSON.fuels.forEach((f, idx) => {
    const opt = document.createElement("option");
    opt.value = f.fuel_name;
    opt.textContent = f.fuel_name;
    select.appendChild(opt);
    if (idx === initialIndex) select.value = f.fuel_name;
  });

  const moistureInput = document.createElement("input");
  moistureInput.type = "number";
  moistureInput.step = "0.1";
  moistureInput.placeholder = "Mar (%)";
  moistureInput.className = "fuel-moisture";

  const mfInput = document.createElement("input");
  mfInput.type = "number";
  mfInput.step = "0.1";
  mfInput.placeholder = "MF (%)";
  mfInput.className = "fuel-mf";

  const priceInput = document.createElement("input");
  priceInput.type = "number";
  priceInput.step = "1";
  priceInput.placeholder = "Giá (VND/kg)";
  priceInput.className = "fuel-price";

  const btnRemove = document.createElement("button");
  btnRemove.type = "button";
  btnRemove.className = "btn btn-danger";
  btnRemove.innerHTML = "✖";
  btnRemove.addEventListener("click", () => {
    row.remove();
  });

  // auto set default M & MF
  select.addEventListener("change", () => {
    const fuel = getFuelByName(select.value);
    if (fuel) {
      if (!moistureInput.value) moistureInput.value = fuel.default_M ?? 40;
      if (!mfInput.value) mfInput.value = 100;
    }
  });

  row.appendChild(select);
  row.appendChild(moistureInput);
  row.appendChild(mfInput);
  row.appendChild(priceInput);
  row.appendChild(btnRemove);

  return row;
}

function renderLosses(losses) {
  const controllableIds = ["L1", "L3", "L5", "L7", "L8"];
  const lessIds = ["L2", "L4", "L6"];

  const mapLoss = {
    L1: "Khói thải khô",
    L2: "Ẩm do H₂ trong nhiên liệu",
    L3: "Ẩm sẵn trong nhiên liệu",
    L4: "Ẩm không khí",
    L5: "CO chưa cháy hết",
    L6: "Bức xạ & cơ khí",
    L7: "Cháy không hết (carbon trong tro)",
    L8: "Khác / Dự phòng (xả đáy, nước ngưng...)"
  };

  const ctl = document.getElementById("lossListControllable");
  const less = document.getElementById("lossListLess");
  ctl.innerHTML = "";
  less.innerHTML = "";

  const makeLossItem = (id) => {
    const val = losses[id];
    const cls = classifyLossValue(val);
    const div = document.createElement("div");
    div.className = "loss-item " + (cls === "bad" ? "bad" : cls === "warn" ? "warn" : "ok");
    const nameSpan = document.createElement("span");
    nameSpan.textContent = id + " – " + mapLoss[id];
    const valueSpan = document.createElement("span");
    valueSpan.textContent = Number.isFinite(val) ? val.toFixed(2) + " %" : "–";
    div.appendChild(nameSpan);
    div.appendChild(valueSpan);
    return div;
  };

  controllableIds.forEach(id => ctl.appendChild(makeLossItem(id)));
  lessIds.forEach(id => less.appendChild(makeLossItem(id)));
}

function renderWarnings(warnings) {
  const ul = document.getElementById("warningsList");
  ul.innerHTML = "";
  warnings.forEach(w => {
    const li = document.createElement("li");
    li.className = "level-" + w.level;
    li.innerHTML =
      `<strong>${w.paramLabel}</strong>: ${w.value != null ? w.value.toFixed(1) : "–"} ` +
      `→ <em>${w.label}</em>. ${w.message}`;
    ul.appendChild(li);
  });
}

function renderAdvice(adviceList) {
  const ul = document.getElementById("adviceList");
  ul.innerHTML = "";
  if (!adviceList.length) {
    const li = document.createElement("li");
    li.textContent = "Chưa có cảnh báo lớn. Các thông số đang ở mức tương đối tốt.";
    ul.appendChild(li);
    return;
  }
  adviceList.forEach(a => {
    const li = document.createElement("li");
    li.className = "severity-" + a.severity;
    const title = document.createElement("div");
    title.style.fontWeight = "600";
    title.textContent = `${a.title} (${a.loss_id}) – ${a.condition}`;
    const summary = document.createElement("div");
    summary.style.fontSize = "0.78rem";
    summary.style.marginTop = "2px";
    summary.textContent = a.summary;
    li.appendChild(title);
    li.appendChild(summary);
    if (a.extraNote) {
      const note = document.createElement("div");
      note.style.fontSize = "0.76rem";
      note.style.marginTop = "2px";
      note.style.color = "#6b7280";
      note.textContent = "Ghi chú: " + a.extraNote;
      li.appendChild(note);
    }
    if (a.actions && a.actions.length) {
      const ul2 = document.createElement("ul");
      ul2.style.margin = "4px 0 0 16px";
      ul2.style.paddingLeft = "0";
      a.actions.forEach(act => {
        const li2 = document.createElement("li");
        li2.style.fontSize = "0.78rem";
        li2.textContent = "• " + act;
        ul2.appendChild(li2);
      });
      li.appendChild(ul2);
    }
    ul.appendChild(li);
  });
}

function renderKnowledge(knowledgeItems) {
  const ul = document.getElementById("knowledgeList");
  ul.innerHTML = "";
  knowledgeItems.forEach(k => {
    const li = document.createElement("li");
    const title = document.createElement("div");
    title.style.fontWeight = "600";
    title.textContent = k.title;
    const body = document.createElement("div");
    body.style.fontSize = "0.78rem";
    body.style.marginTop = "2px";
    body.textContent = k.content;
    li.appendChild(title);
    li.appendChild(body);
    ul.appendChild(li);
  });
}

function renderStepsSummary(mix, op, air, fg, losses, efficiency) {
  const list = document.getElementById("stepsList");
  list.innerHTML = "";

  const push = (label, obj) => {
    const li = document.createElement("li");
    const title = document.createElement("div");
    title.className = "step-key";
    title.textContent = label;
    const pre = document.createElement("div");
    pre.className = "step-value";
    pre.textContent = JSON.stringify(obj, (k, v) => (typeof v === "number" ? parseFloat(v.toFixed(4)) : v));
    li.appendChild(title);
    li.appendChild(pre);
    list.appendChild(li);
  };

  push("Bước 1 – Hỗn hợp nhiên liệu (As-received)", {
    C_ar: mix.C_ar, H_ar: mix.H_ar, O_ar: mix.O_ar,
    S_ar: mix.S_ar, N_ar: mix.N_ar, A_ar: mix.A_ar,
    M_ar: mix.M_ar, GCV_ar: mix.GCV_ar
  });
  push("Bước 2 – Không khí lý thuyết & thực tế", air);
  push("Bước 3–4 – Khối lượng & Cp khí khô", {
    m_dg: fg.m_dg,
    c_CO: fg.c_CO,
    Cp_dg: fg.Cp_dg
  });
  push("Bước 5 – Tổn thất chi tiết", losses.details);
  push("Bước 6 – Hiệu suất & tiêu hao", {
    eta: efficiency.eta,
    fuel_per_ton_steam: efficiency.fuel_per_ton_steam,
    steam_cost: efficiency.steam_cost
  });
}

/* ==========================================================
   7. KỊCH BẢN VẬN HÀNH (3 CASE)
   ========================================================== */

const scenarios = {
  "1": null,
  "2": null,
  "3": null
};

function saveScenario(slot, mix, op, losses, efficiency) {
  scenarios[slot] = {
    time: new Date(),
    mix,
    op,
    losses,
    efficiency
  };
  renderScenarios();
}

function renderScenarios() {
  const container = document.getElementById("scenarioCards");
  container.innerHTML = "";
  ["1", "2", "3"].forEach(slot => {
    const sc = scenarios[slot];
    const card = document.createElement("div");
    card.className = "scenario-card";
    const title = document.createElement("h4");
    title.textContent = "Case " + slot;
    card.appendChild(title);
    if (!sc) {
      const small = document.createElement("small");
      small.textContent = "Chưa lưu kịch bản. Chạy tính toán rồi bấm 'Lưu Case " + slot + "'.";
      card.appendChild(small);
    } else {
      const ts = sc.time.toLocaleTimeString();
      const eta = sc.efficiency.eta.toFixed(1);
      const fuel = sc.efficiency.fuel_per_ton_steam.toFixed(1);
      const cost = sc.efficiency.steam_cost.toFixed(0);
      const small = document.createElement("small");
      small.textContent = "Lưu lúc " + ts;
      card.appendChild(small);

      const metrics = document.createElement("div");
      metrics.className = "scenario-metrics";
      metrics.innerHTML =
        `<div>η: <strong>${eta}%</strong></div>` +
        `<div>Fuel/t: <strong>${fuel}</strong></div>` +
        `<div>Chi phí/t: <strong>${cost}</strong></div>` +
        `<div>W mix: <strong>${sc.mix.M_ar.toFixed(1)}%</strong></div>`;
      card.appendChild(metrics);
    }
    container.appendChild(card);
  });
}

/* ==========================================================
   8. LUỒNG TÍNH TOÁN CHÍNH
   ========================================================== */

function calculateAll() {
  const selectedFuels = getFuelRowsData();
  const op = getOperationInputs();

  if (!selectedFuels.length) {
    alert("Vui lòng chọn ít nhất 1 nhiên liệu và nhập MF, Mar.");
    return;
  }

  const mix = convertAsReceived(selectedFuels);
  if (!mix || !Number.isFinite(mix.GCV_ar) || mix.GCV_ar <= 0) {
    alert("GCV_ar của hỗn hợp không hợp lệ. Vui lòng kiểm tra dữ liệu nhiên liệu.");
    return;
  }

  const air = calculateAir(mix, op);
  const fg = calculateFlueGas(mix, op, air);
  const losses = calculateLosses(mix, op, air, fg);
  const efficiency = calculateEfficiency(mix, op, losses);

  // Cập nhật kết quả chính
  document.getElementById("valEta").textContent =
    Number.isFinite(efficiency.eta) ? efficiency.eta.toFixed(2) : "–";
  document.getElementById("valFuelPerTon").textContent =
    Number.isFinite(efficiency.fuel_per_ton_steam) ? efficiency.fuel_per_ton_steam.toFixed(1) : "–";
  document.getElementById("valSteamCost").textContent =
    Number.isFinite(efficiency.steam_cost) ? efficiency.steam_cost.toFixed(0) : "–";

  renderLosses(losses);

  const warnings = buildWarnings(mix, op);
  renderWarnings(warnings);

  const adviceList = buildRuleBasedAdvice(mix, op, losses, efficiency);
  renderAdvice(adviceList);

  const knowledgeItems = displayKnowledgeSection(mix, op, losses, efficiency);
  renderKnowledge(knowledgeItems);

  renderStepsSummary(mix, op, air, fg, losses, efficiency);

  // Lưu tạm để slot kịch bản có thể sử dụng
  window.__lastCalculation = { mix, op, losses, efficiency };
}

/* ==========================================================
   9. KHỞI TẠO UI & SỰ KIỆN
   ========================================================== */

function init() {
  const fuelContainer = document.getElementById("fuelRows");
  fuelContainer.appendChild(createFuelRow(0));

  document.getElementById("btnAddFuel").addEventListener("click", () => {
    fuelContainer.appendChild(createFuelRow(0));
  });

  document.getElementById("btnCalculate").addEventListener("click", calculateAll);

  document.querySelectorAll("[data-save-scenario]").forEach(btn => {
    btn.addEventListener("click", () => {
      const slot = btn.getAttribute("data-save-scenario");
      if (!window.__lastCalculation) {
        alert("Chưa có kết quả để lưu. Vui lòng tính toán trước.");
        return;
      }
      const { mix, op, losses, efficiency } = window.__lastCalculation;
      saveScenario(slot, mix, op, losses, efficiency);
    });
  });

  renderScenarios();

  // Enter = tính toán (trừ khi đang focus button)
  document.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter" && ev.target.tagName !== "BUTTON") {
      ev.preventDefault();
      calculateAll();
    }
  });
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
