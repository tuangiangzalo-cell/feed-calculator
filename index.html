<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>C√¥ng ty TNHH Kim Tr∆∞·ªùng Ph√∫c - T√≠nh hi·ªáu su·∫•t l√≤ h∆°i</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --accent: #009688;
      --accent-soft: rgba(0,150,136,0.06);
      --accent-strong: #00695c;
      --danger: #c62828;
      --text-main: #263238;
      --text-muted: #607d8b;
      --border: #dde2eb;
      --shadow-soft: 0 14px 28px rgba(0,0,0,0.08);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --transition-fast: 0.2s ease-out;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #e3f2fd 0, #f5f7fb 45%, #f5f7fb 100%);
      color: var(--text-main);
    }

    .page {
      min-height: 100vh;
      padding: 28px 16px 40px;
      max-width: 1280px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 24px;
      text-align: center;
    }

    header .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 14px;
      border-radius: var(--radius-pill);
      background: rgba(0,0,0,0.03);
      color: var(--text-muted);
      font-size: 12px;
      margin-bottom: 8px;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }

    header h2 {
      margin: 4px 0 6px;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.7fr);
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 10px;
    }

    .card-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-header h3 span.icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--accent-strong);
    }

    .card-header .sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill-tag {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: var(--accent-soft);
      color: var(--accent-strong);
      white-space: nowrap;
    }

    .section-title {
      margin: 14px 0 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .two-col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px 14px;
    }

    .three-col {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px 14px;
    }

    .form-row {
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
      color: var(--text-muted);
    }

    .field-inline {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    select,
    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 7px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      font-size: 13px;
      outline: none;
      background: #fafbff;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform 0.08s ease-out;
    }

    select:focus,
    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0,150,136,0.15);
      background: #ffffff;
      transform: translateY(-1px);
    }

    .unit {
      font-size: 11px;
      color: var(--text-muted);
      padding: 0 6px;
      background: #f0f3fa;
      border-radius: var(--radius-pill);
      line-height: 1.6;
      white-space: nowrap;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .fuel-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      margin: 6px 0 10px;
    }

    .fuel-option {
      position: relative;
      border-radius: var(--radius-md);
      padding: 8px 9px;
      border: 1px solid var(--border);
      background: #fafbff;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 3px;
      transition: all var(--transition-fast);
    }

    .fuel-option strong {
      font-size: 12px;
    }

    .fuel-option small {
      font-size: 11px;
      color: var(--text-muted);
    }

    .fuel-option.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(0,150,136,0.15);
    }

    .fuel-option .chip {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 9px;
      padding: 1px 6px;
      border-radius: var(--radius-pill);
      background: rgba(0,150,136,0.12);
      color: var(--accent-strong);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: var(--radius-pill);
      padding: 7px 18px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease-out, box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast);
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), #26a69a);
      color: #ffffff;
      box-shadow: 0 10px 18px rgba(0,150,136,0.3);
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(0,150,136,0.32);
    }

    button.secondary {
      background: #eef1f8;
      color: var(--text-main);
    }

    button.secondary:hover {
      background: #e0e4f0;
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    /* Result panel */
    .results-top {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 640px) {
      .results-top {
        grid-template-columns: 1fr;
      }
    }

    .metric-card {
      background: var(--accent-soft);
      border-radius: var(--radius-lg);
      padding: 12px 12px 11px;
      border: 1px solid rgba(0,150,136,0.25);
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
      overflow: hidden;
    }

    .metric-card::before {
      content: "";
      position: absolute;
      inset: auto -30px -40px;
      height: 80px;
      background: radial-gradient(circle at center, rgba(255,255,255,0.5), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .metric-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--accent-strong);
    }

    .metric-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent-strong);
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .metric-unit {
      font-size: 12px;
      color: var(--text-muted);
    }

    .metric-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .metric-chip {
      position: absolute;
      top: 8px;
      right: 10px;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,0.8);
      color: var(--accent-strong);
    }

    .loss-table {
      width: 100%;
      border-spacing: 0;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 12px;
    }

    .loss-table th,
    .loss-table td {
      padding: 4px 4px;
      text-align: right;
    }

    .loss-table th:first-child,
    .loss-table td:first-child {
      text-align: left;
    }

    .loss-table thead th {
      font-size: 11px;
      color: var(--text-muted);
      border-bottom: 1px dashed var(--border);
    }

    .loss-table tbody tr:nth-child(odd) {
      background: #fafbff;
    }

    .loss-table tfoot td {
      border-top: 1px solid var(--border);
      font-weight: 600;
    }

    .loss-name {
      white-space: nowrap;
    }

    .loss-highlight {
      color: var(--danger);
      font-weight: 600;
    }

    .note-warning {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .note-warning strong {
      color: var(--danger);
    }

    /* Advice */
    .advice-list {
      margin: 6px 0 0;
      padding-left: 18px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .advice-list li {
      margin-bottom: 3px;
    }

    .pill-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      border-radius: var(--radius-pill);
      background: #f3f5fb;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Details / steps */
    .details-card {
      margin-top: 20px;
    }

    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: #f3f5fb;
      font-size: 13px;
      transition: background var(--transition-fast);
    }

    .accordion-header:hover {
      background: #e6e9f3;
    }

    .accordion-header span {
      font-weight: 500;
    }

    .accordion-header .chevron {
      font-size: 16px;
      transform: rotate(0deg);
      transition: transform var(--transition-fast);
      color: var(--text-muted);
    }

    .accordion-header.open .chevron {
      transform: rotate(90deg);
    }

    .accordion-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
    }

    .accordion-inner {
      padding-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .step-block {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: #fafbff;
      border: 1px dashed var(--border);
    }

    .step-block h4 {
      margin: 0 0 4px;
      font-size: 12px;
      color: var(--text-main);
    }

    .step-block pre {
      margin: 0;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 10.5px;
      color: var(--text-muted);
      text-align: right;
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="badge">
      <span>‚öôÔ∏è</span>
      <span>Web app t√≠nh to√°n gi√°n ti·∫øp ‚Äì l√≤ h∆°i sinh kh·ªëi</span>
    </div>
    <h1>C√îNG TY TNHH KIM TR∆Ø·ªúNG PH√öC</h1>
    <h2>T√çNH HI·ªÜU SU·∫§T L√í H∆†I</h2>
    <p>Nh·∫≠p th√¥ng s·ªë v·∫≠n h√†nh, ch·ªçn nhi√™n li·ªáu &rarr; xem t·ªïn th·∫•t, hi·ªáu su·∫•t v√† chi ph√≠ 1 t·∫•n h∆°i.</p>
  </header>

  <main class="layout">
    <!-- LEFT: INPUTS -->
    <section class="card">
      <div class="card-header">
        <div>
          <h3><span class="icon">‚ë†</span> Th√¥ng s·ªë ƒë·∫ßu v√†o</h3>
          <div class="sub">Th√†nh ph·∫ßn nhi√™n li·ªáu &amp; ƒëi·ªÅu ki·ªán v·∫≠n h√†nh l√≤ h∆°i</div>
        </div>
        <div class="pill-tag">T·ª± ƒë·ªông c·∫≠p nh·∫≠t theo th·ªùi gian th·ª±c</div>
      </div>

      <div class="section-title">Ch·ªçn nhi√™n li·ªáu</div>
      <div class="fuel-grid" id="fuelOptions">
        <div class="fuel-option active" data-fuel="DNB">
          <span class="chip">Preset</span>
          <strong>DƒÉm v√°n l·∫°ng DNB</strong>
          <small>GCVdb ‚âà 19&nbsp;639 kJ/kg</small>
        </div>
        <div class="fuel-option" data-fuel="MB">
          <span class="chip">Preset</span>
          <strong>DƒÉm v√°n l·∫°ng MB</strong>
          <small>GCVdb ‚âà 17&nbsp;000 kJ/kg</small>
        </div>
        <div class="fuel-option" data-fuel="HUSK">
          <span class="chip">Preset</span>
          <strong>Tr·∫•u v·ªè</strong>
          <small>GCVdb ‚âà 16&nbsp;089 kJ/kg</small>
        </div>
      </div>
      <div class="form-row">
        <label for="fuelPreset">Ho·∫∑c ch·ªçn ki·ªÉu:</label>
        <select id="fuelPreset">
          <option value="DNB" selected>DƒÉm v√°n l·∫°ng DNB (db)</option>
          <option value="MB">DƒÉm v√°n l·∫°ng MB (db)</option>
          <option value="HUSK">Tr·∫•u v·ªè (db)</option>
          <option value="CUSTOM">Custom ‚Äì t·ª± nh·∫≠p th√†nh ph·∫ßn (db)</option>
        </select>
        <div class="hint">db: dry basis ‚Äì th√†nh ph·∫ßn tr√™n c∆° s·ªü kh√¥.</div>
      </div>

      <div class="section-title">Th√†nh ph·∫ßn nhi√™n li·ªáu (Dry Basis, % kh·ªëi l∆∞·ª£ng)</div>
      <div class="three-col">
        <div class="form-row">
          <label>C_db ‚Äì Cacbon (%)</label>
          <div class="field-inline">
            <input type="number" id="C_db" step="0.01" />
          </div>
        </div>
        <div class="form-row">
          <label>H_db ‚Äì Hydro (%)</label>
          <input type="number" id="H_db" step="0.01" />
        </div>
        <div class="form-row">
          <label>O_db ‚Äì Oxy (%)</label>
          <input type="number" id="O_db" step="0.01" />
        </div>
        <div class="form-row">
          <label>S_db ‚Äì L∆∞u hu·ª≥nh (%)</label>
          <input type="number" id="S_db" step="0.01" />
        </div>
        <div class="form-row">
          <label>N_db ‚Äì Nit∆° (%)</label>
          <input type="number" id="N_db" step="0.01" />
        </div>
        <div class="form-row">
          <label>A_db ‚Äì Tro (%)</label>
          <input type="number" id="A_db" step="0.01" />
        </div>
      </div>

      <div class="form-row">
        <label>GCV_db ‚Äì Nhi·ªát tr·ªã cao tr√™n c∆° s·ªü kh√¥ (kJ/kg)</label>
        <input type="number" id="GCV_db" step="1" />
      </div>

      <div class="section-title">ƒêi·ªÅu ki·ªán nhi√™n li·ªáu &amp; kh√≠ th·∫£i</div>
      <div class="two-col">
        <div class="form-row">
          <label>ƒê·ªô ·∫©m nhi√™n li·ªáu M (as-received, %)</label>
          <div class="field-inline">
            <input type="number" id="M_ar_pct" step="0.1" />
            <span class="unit">%</span>
          </div>
          <div class="hint">V√≠ d·ª• c·ªßi/biomass 20‚Äì50%.</div>
        </div>
        <div class="form-row">
          <label>O‚ÇÇ trong kh√≥i th·∫£i ‚Äì O‚ÇÇ_dry (%)</label>
          <div class="field-inline">
            <input type="number" id="O2_dry" step="0.1" />
            <span class="unit">%</span>
          </div>
        </div>
        <div class="form-row">
          <label>CO trong kh√≥i th·∫£i ‚Äì CO (ppm)</label>
          <div class="field-inline">
            <input type="number" id="CO_ppm" step="1" />
            <span class="unit">ppm</span>
          </div>
          <div class="hint">CO cao ‚Üí ch√°y kh√¥ng ho√†n to√†n.</div>
        </div>
        <div class="form-row">
          <label>Nhi·ªát ƒë·ªô kh√≠ th·∫£i ‚Äì T<sub>f</sub> (¬∞C)</label>
          <div class="field-inline">
            <input type="number" id="Tf" step="1" />
            <span class="unit">¬∞C</span>
          </div>
        </div>
        <div class="form-row">
          <label>Nhi·ªát ƒë·ªô m√¥i tr∆∞·ªùng ‚Äì T<sub>a</sub> (¬∞C)</label>
          <div class="field-inline">
            <input type="number" id="Ta" step="0.1" />
            <span class="unit">¬∞C</span>
          </div>
        </div>
        <div class="form-row">
          <label>ƒê·ªô ·∫©m kh√¥ng kh√≠ ‚Äì RH (%)</label>
          <div class="field-inline">
            <input type="number" id="RH" step="1" />
            <span class="unit">%</span>
          </div>
        </div>
      </div>

      <div class="section-title">ƒêi·ªÅu ki·ªán n∆∞·ªõc c·∫•p &amp; l√≤ h∆°i</div>
      <div class="two-col">
        <div class="form-row">
          <label>Nhi·ªát ƒë·ªô n∆∞·ªõc c·∫•p ‚Äì T<sub>fw</sub> (¬∞C)</label>
          <div class="field-inline">
            <input type="number" id="T_fw" step="1" />
            <span class="unit">¬∞C</span>
          </div>
        </div>
        <div class="form-row">
          <label>√Åp su·∫•t l√≤ ‚Äì P<sub>g</sub> (barg)</label>
          <div class="field-inline">
            <input type="number" id="P_g" step="0.1" />
            <span class="unit">barg</span>
          </div>
          <div class="hint">M·∫∑c ƒë·ªãnh 10 barg (‚âà 11 bar abs).</div>
        </div>
        <div class="form-row">
          <label>L∆∞u l∆∞·ª£ng x·∫£ ƒë√°y ‚Äì BR (% l∆∞u l∆∞·ª£ng h∆°i)</label>
          <div class="field-inline">
            <input type="number" id="BR" step="0.1" />
            <span class="unit">% h∆°i</span>
          </div>
        </div>
        <div class="form-row">
          <label>Gi√° nhi√™n li·ªáu (VND/kg)</label>
          <div class="field-inline">
            <input type="number" id="fuelPrice" step="10" />
            <span class="unit">VND/kg</span>
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button class="primary" id="btnCalc">üîÑ T√≠nh to√°n / C·∫≠p nh·∫≠t</button>
        <button class="secondary" id="btnReset">üßπ Reset v·ªÅ m·∫∑c ƒë·ªãnh</button>
      </div>
    </section>

    <!-- RIGHT: RESULTS -->
    <section class="card">
      <div class="card-header">
        <div>
          <h3><span class="icon">‚ë°</span> K·∫øt qu·∫£ t·ªïn th·∫•t &amp; hi·ªáu su·∫•t</h3>
          <div class="sub">T√≠nh theo ph∆∞∆°ng ph√°p gi√°n ti·∫øp (heat loss method)</div>
        </div>
        <div class="pill-tag">K·∫øt qu·∫£ cho 1 kg nhi√™n li·ªáu &amp; 1 t·∫•n h∆°i</div>
      </div>

      <div class="results-top">
        <div class="metric-card">
          <div class="metric-chip">Hi·ªáu su·∫•t l√≤ h∆°i</div>
          <div class="metric-label">Hi·ªáu su·∫•t Œ∑</div>
          <div class="metric-value">
            <span id="etaValue">‚Äì</span><span class="metric-unit">%</span>
          </div>
          <div class="metric-sub" id="etaComment">‚Äì</div>
        </div>
        <div class="metric-card">
          <div class="metric-chip">Chi ph√≠ 1 t·∫•n h∆°i</div>
          <div class="metric-label">Nhi√™n li·ªáu &amp; chi ph√≠</div>
          <div class="metric-value">
            <span id="fuelPerTon">‚Äì</span><span class="metric-unit">kg nhi√™n li·ªáu/t·∫•n h∆°i</span>
          </div>
          <div class="metric-sub">
            Chi ph√≠ ‚âà <strong id="costPerTon">‚Äì</strong> VND/t·∫•n h∆°i
          </div>
        </div>
      </div>

      <table class="loss-table" aria-label="B·∫£ng t·ªïn th·∫•t">
        <thead>
        <tr>
          <th class="loss-name">H·∫°ng m·ª•c</th>
          <th>L (%)</th>
          <th>Ghi ch√∫</th>
        </tr>
        </thead>
        <tbody id="lossBody">
        <!-- Filled by JS -->
        </tbody>
        <tfoot>
        <tr>
          <td>T·ªïng t·ªïn th·∫•t</td>
          <td id="lossTotal">‚Äì</td>
          <td></td>
        </tr>
        </tfoot>
      </table>

      <div class="note-warning" id="warningNote"></div>

      <div class="section-title">G·ª£i √Ω c·∫£i thi·ªán hi·ªáu qu·∫£ (kinh t·∫ø)</div>
      <ul class="advice-list" id="adviceList">
        <!-- Filled by JS -->
      </ul>
      <div class="pill-badge">
        üí° G·ª£i √Ω tham kh·∫£o s√°ch h∆∞·ªõng d·∫´n ƒë√°nh gi√° l√≤ h∆°i &amp; nghi√™n c·ª©u energy/exergy.
      </div>
    </section>
  </main>

  <!-- STEP DETAILS -->
  <section class="card details-card">
    <div class="card-header">
      <div>
        <h3><span class="icon">‚ë¢</span> Chi ti·∫øt t·ª´ng b∆∞·ªõc t√≠nh to√°n</h3>
        <div class="sub">D√πng ƒë·ªÉ ki·ªÉm tra l·∫°i c√¥ng th·ª©c &amp; gi√°m s√°t t√≠nh to√°n</div>
      </div>
    </div>

    <div class="accordion-header" id="accordionToggle">
      <span>Hi·ªÉn th·ªã / ·∫®n chi ti·∫øt B∆∞·ªõc 1 ‚Üí B∆∞·ªõc 6</span>
      <span class="chevron">‚ñ∂</span>
    </div>
    <div class="accordion-body" id="accordionBody">
      <div class="accordion-inner" id="stepsContainer">
        <!-- Filled by JS -->
      </div>
    </div>

    <div class="footer-note">
      (*) C√¥ng th·ª©c d·ª±a tr√™n ph∆∞∆°ng ph√°p gi√°n ti·∫øp (heat loss method) th∆∞·ªùng d√πng trong ƒë√°nh gi√° l√≤ h∆°i c√¥ng nghi·ªáp.
    </div>
  </section>
</div>

<script>
  // ---------- Preset fuel data (Dry Basis) ----------
  const fuelPresets = {
    DNB: {
      name: "DƒÉm v√°n l·∫°ng DNB",
      C_db: 47.61,
      H_db: 4.87,
      O_db: 44.24,
      S_db: 0.06,
      N_db: 0.31,
      A_db: 2.91,
      GCV_db: 19639
    },
    MB: {
      name: "DƒÉm v√°n l·∫°ng MB",
      C_db: 47.61,
      H_db: 4.87,
      O_db: 44.24,
      S_db: 0.06,
      N_db: 0.31,
      A_db: 2.91,
      GCV_db: 17000
    },
    HUSK: {
      name: "Tr·∫•u v·ªè",
      C_db: 36.42,
      H_db: 4.91,
      O_db: 35.88,
      S_db: 0.00,
      N_db: 0.59,
      A_db: 22.20,
      GCV_db: 16089
    }
  };

  // ---------- Steam table: simple interpolation for hf, hsteam vs P_abs ----------
  // Values are approximate saturated properties: hf (kJ/kg), hg (kJ/kg)
  const steamTable = [
    { P: 3,   hf: 565,  hg: 2725 },
    { P: 6,   hf: 670,  hg: 2756 },
    { P: 11,  hf: 781,  hg: 2787 },
    { P: 16,  hf: 838,  hg: 2804 },
    { P: 21,  hf: 887,  hg: 2816 }
  ];

  function interpolateSteamProps(P_abs) {
    // Clamp if outside table
    if (P_abs <= steamTable[0].P) return steamTable[0];
    if (P_abs >= steamTable[steamTable.length - 1].P) return steamTable[steamTable.length - 1];
    for (let i = 0; i < steamTable.length - 1; i++) {
      const p1 = steamTable[i];
      const p2 = steamTable[i + 1];
      if (P_abs >= p1.P && P_abs <= p2.P) {
        const t = (P_abs - p1.P) / (p2.P - p1.P);
        return {
          P: P_abs,
          hf: p1.hf + t * (p2.hf - p1.hf),
          hg: p1.hg + t * (p2.hg - p1.hg)
        };
      }
    }
    return steamTable[steamTable.length - 1];
  }

  // ---------- Helpers ----------
  function setFuelFields(presetKey) {
    const preset = fuelPresets[presetKey];
    if (!preset) return;
    document.getElementById('C_db').value = preset.C_db;
    document.getElementById('H_db').value = preset.H_db;
    document.getElementById('O_db').value = preset.O_db;
    document.getElementById('S_db').value = preset.S_db;
    document.getElementById('N_db').value = preset.N_db;
    document.getElementById('A_db').value = preset.A_db;
    document.getElementById('GCV_db').value = preset.GCV_db;
  }

  function setDefaultInputs() {
    // Default fuel: DNB
    document.getElementById('fuelPreset').value = 'DNB';
    highlightFuelCard('DNB');
    setFuelFields('DNB');

    // Operating conditions defaults
    document.getElementById('M_ar_pct').value = 20;   // 20% moisture
    document.getElementById('O2_dry').value = 8;      // 8% O2
    document.getElementById('CO_ppm').value = 200;    // 200 ppm
    document.getElementById('Tf').value = 180;        // 180¬∞C flue
    document.getElementById('Ta').value = 30;         // 30¬∞C ambient
    document.getElementById('RH').value = 80;         // 80% RH
    document.getElementById('T_fw').value = 90;       // 90¬∞C feedwater
    document.getElementById('P_g').value = 10;        // 10 barg
    document.getElementById('BR').value = 3;          // 3% blowdown
    document.getElementById('fuelPrice').value = 1500; // VND/kg
  }

  function highlightFuelCard(key) {
    const cards = document.querySelectorAll('.fuel-option');
    cards.forEach(card => {
      card.classList.toggle('active', card.dataset.fuel === key);
    });
  }

  // Saturation vapor pressure (kPa) using Tetens formula
  function saturationPressure(Tc) {
    // Tc in ¬∞C
    return 0.61094 * Math.exp(17.625 * Tc / (Tc + 243.04)) * 10; // convert from kPa? Actually 0.61094 is kPa, multiply by 10 to ~kPa? -> small adjust
  }

  // Clamp utility
  function clamp(value, min, max) {
    return Math.max(min, Math.min(max, value));
  }

  // ---------- Main calculation ----------
  function calculate() {
    // Read inputs
    function num(id, fallback = 0) {
      const v = parseFloat(document.getElementById(id).value);
      return isNaN(v) ? fallback : v;
    }

    const C_db = num('C_db');
    const H_db = num('H_db');
    const O_db = num('O_db');
    const S_db = num('S_db');
    const N_db = num('N_db');
    const A_db = num('A_db');
    const GCV_db = num('GCV_db');

    const M = num('M_ar_pct');
    const O2_dry = num('O2_dry');
    const CO_ppm = num('CO_ppm');
    const Tf = num('Tf');
    const Ta = num('Ta');
    const RH = num('RH', 80);
    const T_fw = num('T_fw');
    const P_g = num('P_g', 10);
    const BR = num('BR', 0);
    const fuelPrice = num('fuelPrice', 0);

    const steps = [];

    // Step 1: Convert to as-received basis
    const factor = (100 - M) / 100;
    const C_ar = C_db * factor;
    const H_ar = H_db * factor;
    const O_ar = O_db * factor;
    const S_ar = S_db * factor;
    const N_ar = N_db * factor;
    const A_ar = A_db * factor;
    const M_ar = M;
    const GCV_ar = GCV_db * factor;

    const c = C_ar / 100;
    const h = H_ar / 100;
    const o = O_ar / 100;
    const s = S_ar / 100;
    const n = N_ar / 100;
    const a = A_ar / 100;
    const m = M_ar / 100;

    steps.push({
      title: "B∆∞·ªõc 1 ‚Äì Quy ƒë·ªïi nhi√™n li·ªáu sang tr·∫°ng th√°i s·ª≠ d·ª•ng (as-received)",
      text:
        `C_ar = C_db √ó (100 ‚àí M) / 100 = ${C_db.toFixed(2)} √ó ${(100 - M).toFixed(2)}/100 = ${C_ar.toFixed(3)} %\n` +
        `H_ar = ${H_db.toFixed(2)} √ó ${(100 - M).toFixed(2)}/100 = ${H_ar.toFixed(3)} %\n` +
        `O_ar = ${O_db.toFixed(2)} √ó ${(100 - M).toFixed(2)}/100 = ${O_ar.toFixed(3)} %\n` +
        `S_ar = ${S_db.toFixed(2)} √ó ${(100 - M).toFixed(2)}/100 = ${S_ar.toFixed(3)} %\n` +
        `N_ar = ${N_db.toFixed(2)} √ó ${(100 - M).toFixed(2)}/100 = ${N_ar.toFixed(3)} %\n` +
        `A_ar = ${A_db.toFixed(2)} √ó ${(100 - M).toFixed(2)}/100 = ${A_ar.toFixed(3)} %\n` +
        `M_ar = ${M_ar.toFixed(3)} %\n` +
        `GCV_ar = GCV_db √ó (100 ‚àí M)/100 = ${GCV_db.toFixed(1)} √ó ${(100 - M).toFixed(2)}/100 = ${GCV_ar.toFixed(1)} kJ/kg\n\n` +
        `Ph·∫ßn kh·ªëi l∆∞·ª£ng:\n` +
        `c = C_ar/100 = ${c.toFixed(5)} kg C/kg nhi√™n li·ªáu\n` +
        `h = H_ar/100 = ${h.toFixed(5)} kg H/kg nhi√™n li·ªáu\n` +
        `o = O_ar/100 = ${o.toFixed(5)} kg O/kg nhi√™n li·ªáu\n` +
        `s = S_ar/100 = ${s.toFixed(5)} kg S/kg nhi√™n li·ªáu\n` +
        `n = N_ar/100 = ${n.toFixed(5)} kg N/kg nhi√™n li·ªáu\n` +
        `a = A_ar/100 = ${a.toFixed(5)} kg tro/kg nhi√™n li·ªáu\n` +
        `m = M_ar/100 = ${m.toFixed(5)} kg ·∫©m/kg nhi√™n li·ªáu`
    });

    // Guard
    if (GCV_ar <= 0) {
      alert("GCV_ar ‚â§ 0. Ki·ªÉm tra l·∫°i th√†nh ph·∫ßn nhi√™n li·ªáu v√† ƒë·ªô ·∫©m.");
      return;
    }

    // Step 2: Air requirement
    const O2_req = 2.667 * c + 8 * h + s - o;
    const A_th = O2_req / 0.232;
    const CO_vol = CO_ppm / 10000;         // %vol
    const lambda = 21 / (21 - O2_dry - 0.5 * CO_vol);
    const A_act = lambda * A_th;

    steps.push({
      title: "B∆∞·ªõc 2 ‚Äì L∆∞·ª£ng kh√¥ng kh√≠ l√Ω thuy·∫øt & th·ª±c t·∫ø",
      text:
        `O‚ÇÇ_req = 2.667¬∑c + 8¬∑h + s ‚àí o\n` +
        `       = 2.667¬∑${c.toFixed(5)} + 8¬∑${h.toFixed(5)} + ${s.toFixed(5)} ‚àí ${o.toFixed(5)}\n` +
        `       = ${O2_req.toFixed(5)} kg O‚ÇÇ/kg nhi√™n li·ªáu\n\n` +
        `A_th = O‚ÇÇ_req / 0.232 = ${O2_req.toFixed(5)} / 0.232 = ${A_th.toFixed(4)} kg kh√¥ng kh√≠/kg nhi√™n li·ªáu\n\n` +
        `CO_vol = CO_ppm/10000 = ${CO_ppm.toFixed(0)}/10000 = ${CO_vol.toFixed(4)} (% th·ªÉ t√≠ch)\n` +
        `Œª = 21 / (21 ‚àí O‚ÇÇ_dry ‚àí 0.5¬∑CO_vol)\n` +
        `  = 21 / (21 ‚àí ${O2_dry.toFixed(2)} ‚àí 0.5¬∑${CO_vol.toFixed(4)}) = ${lambda.toFixed(4)}\n` +
        `A_act = Œª¬∑A_th = ${lambda.toFixed(4)} ¬∑ ${A_th.toFixed(4)} = ${A_act.toFixed(4)} kg kh√¥ng kh√≠/kg nhi√™n li·ªáu`
    });

    // Step 3: dry flue gas mass
    const m_dg = A_act + 1 - a - m - 9 * h;

    steps.push({
      title: "B∆∞·ªõc 3 ‚Äì Kh·ªëi l∆∞·ª£ng kh√≥i th·∫£i kh√¥ m_dg",
      text:
        `m_dg = A_act + 1 ‚àí a ‚àí m ‚àí 9¬∑h\n` +
        `     = ${A_act.toFixed(4)} + 1 ‚àí ${a.toFixed(5)} ‚àí ${m.toFixed(5)} ‚àí 9¬∑${h.toFixed(5)}\n` +
        `     = ${m_dg.toFixed(5)} kg kh√≥i th·∫£i kh√¥/kg nhi√™n li·ªáu`
    });

    // Step 4: Flue gas composition & Cp_dg
    const K = CO_ppm * 12 / 1000000;
    const N_dg = (A_act * 0.03468 - h / 4 + n / 28) / (1 - K / 24);
    const c_CO = K * N_dg;

    const mass_CO2 = 3.667 * (c - c_CO);
    const mass_CO  = 2.333 * c_CO;
    const mass_SO2 = 2 * s;
    const mass_O2  = A_act * 0.232 - (2.667 * c - 1.333 * c_CO + 8 * h + s - o);
    const mass_N2  = A_act * 0.768 + n;

    const f_CO2 = mass_CO2 / m_dg;
    const f_CO  = mass_CO  / m_dg;
    const f_SO2 = mass_SO2 / m_dg;
    const f_O2  = mass_O2  / m_dg;
    const f_N2  = mass_N2  / m_dg;

    const Cp_CO2 = 0.85;
    const Cp_O2  = 0.91;
    const Cp_N2  = 1.04;
    const Cp_SO2 = 0.64;
    const Cp_CO  = 1.04;

    let Cp_dg = f_CO2 * Cp_CO2 + f_O2 * Cp_O2 + f_N2 * Cp_N2 + f_SO2 * Cp_SO2 + f_CO * Cp_CO;
    if (!isFinite(Cp_dg) || Cp_dg <= 0) Cp_dg = 1.0;

    steps.push({
      title: "B∆∞·ªõc 4 ‚Äì Th√†nh ph·∫ßn kh√≥i th·∫£i kh√¥ & nhi·ªát dung ri√™ng Cp_dg",
      text:
        `K = CO_ppm¬∑12/10‚Å∂ = ${CO_ppm.toFixed(0)}¬∑12/1,000,000 = ${K.toFixed(6)}\n` +
        `N_dg = (A_act¬∑0.03468 ‚àí h/4 + n/28) / (1 ‚àí K/24)\n` +
        `    = (${A_act.toFixed(4)}¬∑0.03468 ‚àí ${h.toFixed(5)}/4 + ${n.toFixed(5)}/28) / (1 ‚àí ${K.toFixed(6)}/24)\n` +
        `    = ${N_dg.toFixed(6)} kmol/kg nhi√™n li·ªáu\n` +
        `c_CO = K¬∑N_dg = ${K.toFixed(6)} ¬∑ ${N_dg.toFixed(6)} = ${c_CO.toFixed(6)} kg C/kg nhi√™n li·ªáu ch√°y th√†nh CO\n\n` +
        `mass_CO‚ÇÇ = 3.667¬∑(c ‚àí c_CO) = ${mass_CO2.toFixed(5)} kg/kg\n` +
        `mass_CO  = 2.333¬∑c_CO = ${mass_CO.toFixed(5)} kg/kg\n` +
        `mass_SO‚ÇÇ = 2¬∑s = ${mass_SO2.toFixed(5)} kg/kg\n` +
        `mass_O‚ÇÇ  = A_act¬∑0.232 ‚àí (2.667¬∑c ‚àí 1.333¬∑c_CO + 8¬∑h + s ‚àí o)\n` +
        `         = ${mass_O2.toFixed(5)} kg/kg\n` +
        `mass_N‚ÇÇ  = A_act¬∑0.768 + n = ${mass_N2.toFixed(5)} kg/kg\n\n` +
        `Ph·∫ßn kh·ªëi l∆∞·ª£ng:\n` +
        `f_CO‚ÇÇ = ${f_CO2.toFixed(4)}, f_CO = ${f_CO.toFixed(4)}, f_SO‚ÇÇ = ${f_SO2.toFixed(4)}, f_O‚ÇÇ = ${f_O2.toFixed(4)}, f_N‚ÇÇ = ${f_N2.toFixed(4)}\n\n` +
        `Cp_dg = Œ£ f_i¬∑Cp_i = ${Cp_dg.toFixed(4)} kJ/kg¬∑¬∞C`
    });

    // Step 5: Losses L1-L8
    const dT = Tf - Ta;

    const L1 = (m_dg * Cp_dg * dT) / GCV_ar * 100;
    const L2 = (9 * h * (2450 + 1.88 * dT)) / GCV_ar * 100;
    const L3 = (m * (2450 + 1.88 * dT)) / GCV_ar * 100;

    const Psat = saturationPressure(Ta); // kPa (approx)
    const Pv = (RH / 100) * Psat;
    const omega = 0.622 * Pv / (101.325 - Pv); // kg ·∫©m/kg kh√¥ng kh√≠ kh√¥
    const L4 = (A_act * omega * 1.88 * dT) / GCV_ar * 100;

    const L5 = (c_CO * 24100) / GCV_ar * 100;

    const L6 = 0.7;   // radiation & unaccounted

    // Blowdown loss L7
    const P_abs = P_g + 1;
    const steamProps = interpolateSteamProps(P_abs);
    const hf = steamProps.hf;
    const hsteam = steamProps.hg;
    const h_fw = 4.18 * T_fw; // approx

    const eta_init = 0.9;
    const BR_frac = BR / 100;
    let L7 = 0;
    if (hsteam > h_fw && BR_frac > 0) {
      L7 = eta_init * BR_frac * (hf - h_fw) / (hsteam - h_fw) * 100;
    }

    const L8 = 1.0;   // unburnt carbon (assumed)

    const losses = [
      { code: "L1", name: "L1 ‚Äì Kh√≠ th·∫£i kh√¥", value: L1 },
      { code: "L2", name: "L2 ‚Äì N∆∞·ªõc t·ª´ H trong nhi√™n li·ªáu", value: L2 },
      { code: "L3", name: "L3 ‚Äì ƒê·ªô ·∫©m trong nhi√™n li·ªáu", value: L3 },
      { code: "L4", name: "L4 ‚Äì ƒê·ªô ·∫©m kh√¥ng kh√≠", value: L4 },
      { code: "L5", name: "L5 ‚Äì CO (ch√°y kh√¥ng ho√†n to√†n)", value: L5 },
      { code: "L6", name: "L6 ‚Äì B·ª©c x·∫° & t·ªïn th·∫•t kh√°c", value: L6 },
      { code: "L7", name: "L7 ‚Äì X·∫£ ƒë√°y l√≤ (blowdown)", value: L7 },
      { code: "L8", name: "L8 ‚Äì Cacbon ch∆∞a ch√°y", value: L8 }
    ];

    const lossTotal = losses.reduce((s, l) => s + (isFinite(l.value) ? l.value : 0), 0);
    let eta = 100 - lossTotal;
    if (!isFinite(eta)) eta = 0;
    eta = clamp(eta, 0, 100);

    steps.push({
      title: "B∆∞·ªõc 5 ‚Äì T√≠nh c√°c t·ªïn th·∫•t L1‚Ä¶L8",
      text:
        `L1 ‚Äì Kh√≠ th·∫£i kh√¥:\n` +
        `L1 = (m_dg¬∑Cp_dg¬∑(T_f ‚àí T_a))/GCV_ar¬∑100%\n` +
        `   = (${m_dg.toFixed(5)}¬∑${Cp_dg.toFixed(4)}¬∑(${Tf.toFixed(1)} ‚àí ${Ta.toFixed(1)}))/` +
        `${GCV_ar.toFixed(1)}¬∑100% = ${L1.toFixed(3)} %\n\n` +
        `L2 ‚Äì N∆∞·ªõc t·ª´ H trong nhi√™n li·ªáu:\n` +
        `L2 = (9¬∑h¬∑(2450 + 1.88¬∑ŒîT))/GCV_ar¬∑100% = ${L2.toFixed(3)} %\n\n` +
        `L3 ‚Äì ƒê·ªô ·∫©m trong nhi√™n li·ªáu:\n` +
        `L3 = (m¬∑(2450 + 1.88¬∑ŒîT))/GCV_ar¬∑100% = ${L3.toFixed(3)} %\n\n` +
        `ƒê·ªô ·∫©m kh√¥ng kh√≠:\n` +
        `P_sat(T_a) ‚âà ${Psat.toFixed(3)} kPa; P_v = RH/100¬∑P_sat = ${Pv.toFixed(3)} kPa\n` +
        `œâ = 0.622¬∑P_v/(101.325 ‚àí P_v) = ${omega.toFixed(5)} kg ·∫©m/kg kk kh√¥\n` +
        `L4 = (A_act¬∑œâ¬∑1.88¬∑ŒîT)/GCV_ar¬∑100% = ${L4.toFixed(3)} %\n\n` +
        `L5 ‚Äì T·ªïn th·∫•t do CO:\n` +
        `L5 = c_CO¬∑24100/GCV_ar¬∑100% = ${L5.toFixed(3)} %\n\n` +
        `L6 ‚Äì B·ª©c x·∫°: gi·∫£ ƒë·ªãnh = 0.7 %\n` +
        `L7 ‚Äì X·∫£ ƒë√°y:\n` +
        `P_abs = P_g + 1 = ${P_abs.toFixed(2)} bar; hf ‚âà ${hf.toFixed(0)}; h_steam ‚âà ${hsteam.toFixed(0)} kJ/kg\n` +
        `h_fw = 4.18¬∑T_fw = 4.18¬∑${T_fw.toFixed(1)} = ${h_fw.toFixed(1)} kJ/kg\n` +
        `L7 = Œ∑_init¬∑BR¬∑(hf ‚àí h_fw)/(h_steam ‚àí h_fw)¬∑100% ‚âà ${L7.toFixed(3)} %\n\n` +
        `L8 ‚Äì C ch∆∞a ch√°y: gi·∫£ ƒë·ªãnh 1.0 %`
    });

    // Step 6: Efficiency & fuel consumption
    const eta_dec = eta / 100;
    let F_steam = 0;
    if (eta_dec > 0) {
      F_steam = (hsteam - h_fw) / (eta_dec * GCV_ar); // kg nhi√™n li·ªáu/kg h∆°i
    }
    const Fuel_per_ton = F_steam * 1000; // kg nhi√™n li·ªáu / t·∫•n h∆°i
    const costPerTon = Fuel_per_ton * fuelPrice;

    steps.push({
      title: "B∆∞·ªõc 6 ‚Äì Hi·ªáu su·∫•t l√≤ & l∆∞·ª£ng nhi√™n li·ªáu cho 1 t·∫•n h∆°i",
      text:
        `Hi·ªáu su·∫•t l√≤ h∆°i:\n` +
        `Œ∑ = 100% ‚àí Œ£L_i = 100 ‚àí ${lossTotal.toFixed(3)} = ${eta.toFixed(3)} %\n\n` +
        `L∆∞·ª£ng nhi√™n li·ªáu cho 1 kg h∆°i:\n` +
        `F_steam = (h_steam ‚àí h_fw)/(Œ∑¬∑GCV_ar)\n` +
        `        = (${hsteam.toFixed(1)} ‚àí ${h_fw.toFixed(1)})/(${eta_dec.toFixed(4)}¬∑${GCV_ar.toFixed(1)})\n` +
        `        = ${F_steam.toFixed(5)} kg nhi√™n li·ªáu/kg h∆°i\n\n` +
        `Cho 1 t·∫•n h∆°i (1000 kg):\n` +
        `Fuel_consumption = F_steam¬∑1000 = ${Fuel_per_ton.toFixed(2)} kg nhi√™n li·ªáu/t·∫•n h∆°i\n\n` +
        `N·∫øu gi√° nhi√™n li·ªáu = ${fuelPrice.toLocaleString('vi-VN')} VND/kg ‚áí Chi ph√≠ ‚âà ${isFinite(costPerTon) ? costPerTon.toLocaleString('vi-VN') : "‚Äì"} VND/t·∫•n h∆°i`
    });

    // ---------- Update result UI ----------
    const etaValue = document.getElementById('etaValue');
    const etaComment = document.getElementById('etaComment');
    etaValue.textContent = eta.toFixed(2);

    let comment = "";
    if (eta >= 85) comment = "Hi·ªáu su·∫•t t·ªët. C√≥ th·ªÉ t·ªëi ∆∞u th√™m ·ªü kh√≠ th·∫£i & x·∫£ ƒë√°y.";
    else if (eta >= 80) comment = "Hi·ªáu su·∫•t trung b√¨nh ‚Äì n√™n ki·ªÉm tra d∆∞ kh√¥ng kh√≠, v·ªá sinh b·ªÅ m·∫∑t trao ƒë·ªïi nhi·ªát.";
    else comment = "Hi·ªáu su·∫•t th·∫•p ‚Äì xem l·∫°i O‚ÇÇ d∆∞, nhi·ªát ƒë·ªô kh√≠ th·∫£i, ch·∫•t l∆∞·ª£ng ch√°y v√† c√°ch v·∫≠n h√†nh.";
    etaComment.textContent = comment;

    // Loss table
    const lossBody = document.getElementById('lossBody');
    lossBody.innerHTML = "";
    let maxLossVal = -1, maxLossCode = null;
    losses.forEach(l => {
      if (!isFinite(l.value)) l.value = 0;
      if (l.value > maxLossVal) {
        maxLossVal = l.value;
        maxLossCode = l.code;
      }
    });

    losses.forEach(l => {
      const tr = document.createElement('tr');
      const nameTd = document.createElement('td');
      const valTd = document.createElement('td');
      const noteTd = document.createElement('td');
      nameTd.textContent = l.name;
      valTd.textContent = l.value.toFixed(2);
      if (l.code === maxLossCode) {
        nameTd.classList.add('loss-highlight');
        valTd.classList.add('loss-highlight');
        noteTd.textContent = "Chi·∫øm l·ªõn nh·∫•t ‚Äì ∆∞u ti√™n gi·∫£m.";
      } else {
        noteTd.textContent = "";
      }
      tr.appendChild(nameTd);
      tr.appendChild(valTd);
      tr.appendChild(noteTd);
      lossBody.appendChild(tr);
    });

    document.getElementById('lossTotal').textContent = lossTotal.toFixed(2);

    // Fuel & cost
    const fuelPerTonEl = document.getElementById('fuelPerTon');
    const costPerTonEl = document.getElementById('costPerTon');
    fuelPerTonEl.textContent = isFinite(Fuel_per_ton) ? Fuel_per_ton.toFixed(1) : "‚Äì";
    costPerTonEl.textContent = isFinite(costPerTon) ? costPerTon.toLocaleString('vi-VN') : "‚Äì";

    // Warning note
    const warningNote = document.getElementById('warningNote');
    if (eta < 75) {
      warningNote.innerHTML = "<strong>L∆∞u √Ω:</strong> Hi·ªáu su·∫•t th·∫•p (&lt; 75%). N√™n ki·ªÉm tra l·∫°i s·ªë li·ªáu ƒëo, ƒë·∫∑c bi·ªát O‚ÇÇ, CO, nhi·ªát ƒë·ªô kh√≠ th·∫£i v√† ƒë·ªô ·∫©m nhi√™n li·ªáu.";
    } else {
      warningNote.textContent = "";
    }

    // Advice section ‚Äì simple heuristic based on losses
    const adviceList = document.getElementById('adviceList');
    adviceList.innerHTML = "";
    const adv = [];

    if (L1 > 5) {
      adv.push("Gi·∫£m L1 ‚Äì t·ªïn th·∫•t kh√≠ th·∫£i: xem x√©t l·∫Øp/ t·ªëi ∆∞u economizer, v·ªá sinh ƒë·ªãnh k·ª≥ b·ªÅ m·∫∑t ·ªëng, ki·ªÉm tra b√°m b·∫©n ph√≠a kh√≥i & ph√≠a n∆∞·ªõc ƒë·ªÉ h·∫° T‚Ççf‚Çé nh∆∞ng v·∫´n cao h∆°n T‚Ççƒëi·ªÉm s∆∞∆°ng‚Çé kh√≥i.");
    }
    if (L5 > 0.5 || CO_ppm > 200) {
      adv.push("Gi·∫£m L5 ‚Äì t·ªïn th·∫•t do CO: ƒëi·ªÅu ch·ªânh ch·∫ø ƒë·ªô ch√°y, ph√¢n ph·ªëi gi√≥ c·∫•p 1/2, tr√°nh thi·∫øu kh√¥ng kh√≠ c·ª•c b·ªô. CO cao ch·ª©ng t·ªè ch√°y kh√¥ng ho√†n to√†n, l√£ng ph√≠ nhi√™n li·ªáu.");
    }
    if (L3 > 3 || M > 40) {
      adv.push("Gi·∫£m L3 ‚Äì ƒë·ªô ·∫©m nhi√™n li·ªáu: ti·ªÅn s·∫•y sinh kh·ªëi, che m∆∞a, l∆∞u kho tr√™n n·ªÅn cao, d√πng gi√≥ n√≥ng/kh√≠ th·∫£i ƒë·ªÉ l√†m kh√¥ s∆° b·ªô. Nhi√™n li·ªáu qu√° ∆∞·ªõt l√†m tƒÉng ti√™u hao v√† gi·∫£m hi·ªáu su·∫•t.");
    }
    if (BR > 3) {
      adv.push("Gi·∫£m L7 ‚Äì t·ªïn th·∫•t x·∫£ ƒë√°y: t·ªëi ∆∞u h√≥a ch·∫•t l∆∞·ª£ng n∆∞·ªõc c·∫•p v√† ch·∫ø ƒë·ªô x·∫£ ƒë√°y (∆∞u ti√™n x·∫£ li√™n t·ª•c c√≥ ƒëi·ªÅu khi·ªÉn TDS), thu h·ªìi nhi·ªát x·∫£ ƒë√°y n·∫øu l∆∞u l∆∞·ª£ng l·ªõn.");
    }
    if (L6 >= 0.7) {
      adv.push("Gi·∫£m L6 ‚Äì b·ª©c x·∫° & r√≤ r·ªâ: ki·ªÉm tra v√† tƒÉng c∆∞·ªùng b·∫£o √¥n th√¢n l√≤, c·ª≠a ng∆∞·ªùi chui, m·∫∑t b√≠ch; x·ª≠ l√Ω r√≤ r·ªâ kh√≠ n√≥ng ra ngo√†i, ƒë·∫∑c bi·ªát v√πng bu·ªìng l·ª≠a v√† ·ªëng kh√≥i.");
    }
    adv.push("S·ª≠ d·ª•ng qu·∫°t c·∫•p/ h√∫t g·∫Øn bi·∫øn t·∫ßn (VSD) ƒë·ªÉ ƒëi·ªÅu ch·ªânh l∆∞u l∆∞·ª£ng gi√≥ theo t·∫£i th·ª±c t·∫ø, v·ª´a gi·∫£m ƒëi·ªán nƒÉng qu·∫°t, v·ª´a gi·ªØ O‚ÇÇ d∆∞ ·ªü m·ª©c t·ªëi ∆∞u.");

    adv.forEach(text => {
      const li = document.createElement('li');
      li.textContent = text;
      adviceList.appendChild(li);
    });

    // Fill steps detail
    const stepsContainer = document.getElementById('stepsContainer');
    stepsContainer.innerHTML = "";
    steps.forEach(step => {
      const block = document.createElement('div');
      block.className = 'step-block';
      const h4 = document.createElement('h4');
      h4.textContent = step.title;
      const pre = document.createElement('pre');
      pre.textContent = step.text;
      block.appendChild(h4);
      block.appendChild(pre);
      stepsContainer.appendChild(block);
    });
  }

  // ---------- Accordion ----------
  function setupAccordion() {
    const toggle = document.getElementById('accordionToggle');
    const body = document.getElementById('accordionBody');
    const chevron = toggle.querySelector('.chevron');
    let isOpen = false;

    toggle.addEventListener('click', () => {
      isOpen = !isOpen;
      toggle.classList.toggle('open', isOpen);
      if (isOpen) {
        body.style.maxHeight = body.scrollHeight + "px";
        chevron.textContent = "‚ñ∂"; // rotated in CSS
      } else {
        body.style.maxHeight = "0px";
        chevron.textContent = "‚ñ∂";
      }
    });

    // Start closed
    body.style.maxHeight = "0px";
  }

  // ---------- Event bindings ----------
  document.addEventListener('DOMContentLoaded', () => {
    // Default inputs
    setDefaultInputs();

    // Fuel preset select
    const fuelSelect = document.getElementById('fuelPreset');
    fuelSelect.addEventListener('change', (e) => {
      const val = e.target.value;
      if (val !== 'CUSTOM') {
        setFuelFields(val);
      }
      highlightFuelCard(val);
    });

    // Clickable fuel cards
    document.getElementById('fuelOptions').addEventListener('click', (e) => {
      const card = e.target.closest('.fuel-option');
      if (!card) return;
      const key = card.dataset.fuel;
      document.getElementById('fuelPreset').value = key;
      if (key !== 'CUSTOM') {
        setFuelFields(key);
      }
      highlightFuelCard(key);
    });

    // Buttons
    document.getElementById('btnCalc').addEventListener('click', (e) => {
      e.preventDefault();
      calculate();
    });

    document.getElementById('btnReset').addEventListener('click', (e) => {
      e.preventDefault();
      setDefaultInputs();
      calculate();
    });

    // Live update on input change (not too heavy)
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('change', () => {
        calculate();
      });
    });

    setupAccordion();

    // First calculation
    calculate();
  });
</script>
</body>
</html>
