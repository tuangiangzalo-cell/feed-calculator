<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>CÔNG TY TNHH KIM TRƯỜNG PHÚC - Tính hiệu suất lò hơi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f5fa;
      --card-bg: #ffffff;
      --accent: #00897b;
      --accent-soft: rgba(0, 137, 123, 0.08);
      --accent-strong: #00695c;
      --danger: #c62828;
      --warning: #ef6c00;
      --ok: #2e7d32;
      --text-main: #263238;
      --text-muted: #607d8b;
      --border: #dde2eb;
      --shadow-soft: 0 10px 26px rgba(15, 35, 52, 0.10);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --transition-fast: 0.2s ease-out;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: var(--bg);
      color: var(--text-main);
      font-size: 14px;
    }

    .app-shell {
      max-width: 1280px;
      margin: 24px auto 40px;
      padding: 0 16px 32px;
    }

    header {
      background: #ffffff;
      color: var(--text-main);
      padding: 18px 20px;
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid #e0e6f0;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .company-name {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #004d40;
    }

    .app-title {
      font-size: 15px;
      font-weight: 600;
    }

    .header-tagline {
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-badges {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-badges div::before {
      content: "• ";
      color: var(--accent-strong);
      font-weight: 700;
    }

    main {
      margin-top: 20px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.6fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      border: 1px solid #e1e5f0;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-size: 13px;
      font-weight: 700;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .pill-hint {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      background: #e0f2f1;
      color: #004d40;
      max-width: 220px;
      text-align: right;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
    }

    @media (max-width: 720px) {
      .input-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    label {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    label span {
      font-weight: 500;
      color: var(--text-main);
    }

    .unit {
      font-size: 11px;
      opacity: 0.8;
    }

    input[type="number"],
    select {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 7px 10px;
      font-size: 13px;
      font-family: inherit;
      background: #fafbff;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }

    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 137, 123, 0.15);
      background: #ffffff;
      transform: translateY(-1px);
    }

    select {
      cursor: pointer;
    }

    .section-divider {
      height: 1px;
      background: #e2e6f0;
      margin: 12px 0;
    }

    .section-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-label::before {
      content: "";
      width: 3px;
      height: 16px;
      border-radius: 999px;
      background: var(--accent);
    }

    .btn-primary {
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: var(--radius-pill);
      padding: 8px 18px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #00897b, #00bfa5);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 10px 18px rgba(0, 150, 136, 0.35);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      filter: brightness(1.04);
      box-shadow: 0 14px 24px rgba(0, 150, 136, 0.35);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(0, 150, 136, 0.3);
    }

    .btn-primary span.icon {
      font-size: 18px;
    }

    .results-main-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    @media (max-width: 600px) {
      .results-main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .metric-card {
      border-radius: 14px;
      padding: 10px 12px;
      background: #f6fafb;
      border: 1px solid rgba(0, 150, 136, 0.14);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .metric-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-strong);
    }

    .metric-unit {
      font-size: 11px;
      color: var(--text-muted);
    }

    .metric-chip {
      align-self: flex-start;
      margin-top: 2px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      background: rgba(255, 255, 255, 0.9);
      color: #004d40;
    }

    .loss-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }

    .loss-table th,
    .loss-table td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid #eceff1;
      vertical-align: top;
    }

    .loss-table th {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .loss-name {
      white-space: nowrap;
      font-weight: 500;
    }

    .loss-value {
      font-weight: 600;
      text-align: right;
      white-space: nowrap;
    }

    .loss-tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      font-size: 10px;
      margin-bottom: 4px;
    }

    .loss-tag.ok {
      background: rgba(46, 125, 50, 0.08);
      color: var(--ok);
    }

    .loss-tag.warn {
      background: rgba(239, 108, 0, 0.08);
      color: var(--warning);
    }

    .loss-tag.bad {
      background: rgba(198, 40, 40, 0.08);
      color: var(--danger);
    }

    .loss-advice {
      font-size: 11px;
      color: var(--text-muted);
    }

    .advice-highlight {
      font-size: 12px;
      line-height: 1.5;
    }

    .advice-highlight ul {
      padding-left: 18px;
      margin: 4px 0 0;
    }

    .advice-highlight li {
      margin-bottom: 2px;
    }

    .advice-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: rgba(0, 0, 0, 0.03);
      margin-right: 6px;
      margin-top: 4px;
    }

    .advice-badge strong {
      color: var(--accent-strong);
    }

    .small-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .details-card {
      margin-top: 18px;
    }

    details {
      margin-top: 4px;
    }

    summary {
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    summary::before {
      content: "▾";
      font-size: 10px;
      color: var(--accent-strong);
      transition: transform var(--transition-fast);
    }

    details[open] summary::before {
      transform: rotate(180deg);
    }

    .steps-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 18px;
      font-size: 12px;
    }

    @media (max-width: 900px) {
      .steps-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .step-block {
      padding: 8px 10px;
      border-radius: 10px;
      background: #fafbff;
      border: 1px dashed #cfd8dc;
    }

    .step-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 12px;
      color: var(--accent-strong);
    }

    .step-line {
      margin-bottom: 2px;
    }

    .step-line span {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }

    .step-note {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .error-text {
      font-size: 11px;
      color: var(--danger);
      margin-top: 4px;
    }

    /* So sánh 3 trường hợp */
    .compare-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    @media (max-width: 900px) {
      .compare-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .scenario-card {
      border-radius: 12px;
      padding: 8px 10px;
      background: #fafbff;
      border: 1px dashed #cfd8dc;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .scenario-title {
      color: var(--accent-strong);
    }

    .scenario-save-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--accent);
      background: #ffffff;
      color: var(--accent-strong);
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .scenario-save-btn:hover {
      background: var(--accent);
      color: #ffffff;
      transform: translateY(-1px);
    }

    .scenario-body {
      font-size: 11px;
      color: var(--text-muted);
    }

    .scenario-empty {
      font-size: 11px;
      color: var(--text-muted);
    }

    .scenario-metric-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
    }

    .scenario-metric-label {
      color: var(--text-muted);
    }

    .scenario-metric-value {
      font-weight: 600;
      text-align: right;
    }

    .scenario-best {
      border-style: solid;
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(0, 137, 123, 0.2);
      background: #f0fbf9;
    }

    .scenario-best .scenario-title::after {
      content: "★";
      margin-left: 4px;
      color: var(--accent-strong);
      font-size: 11px;
    }

    .scenario-note {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .footer-note {
      margin-top: 14px;
      font-size: 11px;
      text-align: center;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="header-left">
        <div class="company-name">CÔNG TY TNHH KIM TRƯỜNG PHÚC</div>
        <div class="app-title">TÍNH HIỆU SUẤT LÒ HƠI – BẢN TÍNH NỘI BỘ</div>
        <div class="header-tagline">Tính toán tổn thất, suất tiêu hao & chi phí nhiên liệu cho hệ thống lò hơi hiện hữu.</div>
      </div>
      <div class="header-badges">
        <div>Đánh giá tổn thất theo phương pháp gián tiếp (L1 → L8).</div>
        <div>Đề xuất giải pháp tối ưu vận hành, ưu tiên hiệu quả kinh tế.</div>
      </div>
    </header>

    <main>
      <!-- LEFT: INPUTS -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="card-title-pill">A</span>Thông số đầu vào</div>
            <div class="card-subtitle">Chọn nhiên liệu & nhập số liệu đo O₂, CO, nhiệt độ, độ ẩm…</div>
          </div>
          <div class="pill-hint">Dùng bộ số liệu cho từng <strong>trường hợp vận hành</strong> để so sánh.</div>
        </div>

        <div class="section-label">1. Lựa chọn nhiên liệu</div>
        <div class="input-grid">
          <div class="form-group">
            <label><span>Loại nhiên liệu</span></label>
            <select id="fuelPreset">
              <option value="dnb">Dăm ván lạng DNB</option>
              <option value="mb">Dăm ván lạng MB</option>
              <option value="trau">Trấu vỏ</option>
              <option value="custom">Tùy chọn (nhập tay)</option>
            </select>
          </div>

          <div class="form-group">
            <label><span>Độ ẩm M</span><span class="unit">(% as-received)</span></label>
            <input type="number" id="M" value="40" min="0" max="70" step="0.1" />
          </div>
        </div>

        <div class="section-divider"></div>

        <div class="section-label">2. Thành phần nhiên liệu (Dry Basis)</div>
        <div class="input-grid">
          <div class="form-group">
            <label><span>Carbon C_db</span><span class="unit">(%)</span></label>
            <input type="number" id="C_db" step="0.01" />
          </div>
          <div class="form-group">
            <label><span>Hydrogen H_db</span><span class="unit">(%)</span></label>
            <input type="number" id="H_db" step="0.01" />
          </div>
          <div class="form-group">
            <label><span>Oxy O_db</span><span class="unit">(%)</span></label>
            <input type="number" id="O_db" step="0.01" />
          </div>
          <div class="form-group">
            <label><span>Lưu huỳnh S_db</span><span class="unit">(%)</span></label>
            <input type="number" id="S_db" step="0.01" />
          </div>
          <div class="form-group">
            <label><span>Nitơ N_db</span><span class="unit">(%)</span></label>
            <input type="number" id="N_db" step="0.01" />
          </div>
          <div class="form-group">
            <label><span>Tro A_db (Ash)</span><span class="unit">(%)</span></label>
            <input type="number" id="A_db" step="0.01" />
          </div>
          <div class="form-group">
            <label><span>GCV_db</span><span class="unit">(kJ/kg, dry basis)</span></label>
            <input type="number" id="GCV_db" step="1" />
          </div>
          <div class="form-group">
            <label><span>Giá nhiên liệu</span><span class="unit">(VND/kg)</span></label>
            <input type="number" id="fuelPrice" step="10" value="2000" />
          </div>
        </div>

        <div class="section-divider"></div>

        <div class="section-label">3. Số liệu khí thải & môi trường</div>
        <div class="input-grid">
          <div class="form-group">
            <label><span>O₂ khô trong khói</span><span class="unit">(% vol)</span></label>
            <input type="number" id="O2_dry" value="6" step="0.1" />
          </div>
          <div class="form-group">
            <label><span>CO trong khói</span><span class="unit">(ppm)</span></label>
            <input type="number" id="CO_ppm" value="100" step="1" />
          </div>
          <div class="form-group">
            <label><span>Nhiệt độ khí thải Tf</span><span class="unit">(°C)</span></label>
            <input type="number" id="Tf" value="180" step="0.1" />
          </div>
          <div class="form-group">
            <label><span>Nhiệt độ môi trường Ta</span><span class="unit">(°C)</span></label>
            <input type="number" id="Ta" value="30" step="0.1" />
          </div>
          <div class="form-group">
            <label><span>Độ ẩm không khí RH</span><span class="unit">(% – mặc định 80%)</span></label>
            <input type="number" id="RH" value="80" step="1" />
          </div>
        </div>

        <div class="section-divider"></div>

        <div class="section-label">4. Thông số nước cấp & lò</div>
        <div class="input-grid">
          <div class="form-group">
            <label><span>Nhiệt độ nước cấp T_fw</span><span class="unit">(°C)</span></label>
            <input type="number" id="T_fw" value="80" step="0.1" />
          </div>
          <div class="form-group">
            <label><span>Áp suất lò P_g</span><span class="unit">(bar(g), mặc định 10)</span></label>
            <input type="number" id="P_g" value="10" step="0.1" />
          </div>
          <div class="form-group">
            <label><span>TDS nước cấp</span><span class="unit">(ppm – dùng để tính BR)</span></label>
            <input type="number" id="TDS_fw" value="100" step="1" />
          </div>
          <div class="form-group">
            <label><span>Tỷ lệ xả đáy BR</span><span class="unit">(% lưu lượng hơi – tự tính)</span></label>
            <input type="number" id="BR" value="3" step="0.1" readonly style="background:#f0f3ff;" />
          </div>
          <div class="form-group">
            <label><span>Tổn thất C chưa cháy L8</span><span class="unit">(% – mặc định 1%)</span></label>
            <input type="number" id="L8" value="1" step="0.1" />
          </div>
        </div>

        <button class="btn-primary" id="calcBtn">
          <span class="icon">⚙️</span>
          <span>Tính toán tổn thất & hiệu suất</span>
        </button>
        <div id="inputError" class="error-text"></div>
      </section>

      <!-- RIGHT: RESULTS -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="card-title-pill">B</span>Kết quả & khuyến nghị</div>
            <div class="card-subtitle">Hiệu suất lò hơi, suất tiêu hao nhiên liệu và chi phí cho 1 tấn hơi.</div>
          </div>
          <div class="pill-hint">Các ô màu xanh nhạt là chỉ tiêu chính.</div>
        </div>

        <div class="results-main-grid">
          <div class="metric-card">
            <div class="metric-label">Hiệu suất lò hơi ước tính</div>
            <div class="metric-value" id="etaDisplay">–</div>
            <div class="metric-unit">(% – phương pháp gián tiếp)</div>
            <div class="metric-chip" id="etaChip">Chưa tính</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Suất tiêu hao nhiên liệu</div>
            <div class="metric-value" id="fuelPerTonDisplay">–</div>
            <div class="metric-unit">(kg nhiên liệu / 1 tấn hơi)</div>
            <div class="metric-chip" id="fuelChip">Chưa tính</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Chi phí nhiên liệu</div>
            <div class="metric-value" id="costPerTonDisplay">–</div>
            <div class="metric-unit">(VND / 1 tấn hơi)</div>
            <div class="metric-chip" id="costChip">Chưa tính</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Tổn thất tổng cộng</div>
            <div class="metric-value" id="lossTotalDisplay">–</div>
            <div class="metric-unit">(% GCV – L1 → L8)</div>
            <div class="metric-chip" id="lossChip">Chưa tính</div>
          </div>
        </div>

        <table class="loss-table">
          <thead>
          <tr>
            <th style="width: 20%;">Khoản tổn thất</th>
            <th style="width: 10%;">Giá trị</th>
            <th>Nhận xét & giải pháp khả thi</th>
          </tr>
          </thead>
          <tbody id="lossTableBody">
          <!-- Filled by JS -->
          </tbody>
        </table>

        <div class="section-divider"></div>

        <div class="section-label">Khuyến nghị vận hành nhanh</div>
        <div id="adviceSummary" class="advice-highlight">
          Nhấn “Tính toán” để xem gợi ý tối ưu O₂, nhiệt độ khí thải, độ ẩm nhiên liệu, xả đáy… theo bộ số liệu bạn nhập.
        </div>
        <div class="small-note">
          Ưu tiên các biện pháp ít vốn: chỉnh gió, vệ sinh bề mặt truyền nhiệt, tối ưu xả đáy, chuẩn bị nhiên liệu, kiểm soát O₂–CO.
        </div>

        <div class="section-divider"></div>
        <div class="section-label">So sánh 3 trường hợp</div>
        <div class="compare-grid">
          <div class="scenario-card" id="scenarioCard0">
            <div class="scenario-header">
              <div class="scenario-title">Trường hợp 1</div>
              <button type="button" class="scenario-save-btn" data-index="0">Lưu TH1</button>
            </div>
            <div class="scenario-body" id="scenarioBody0">
              <div class="scenario-empty">Chưa lưu – hãy tính và bấm “Lưu TH1”.</div>
            </div>
          </div>
          <div class="scenario-card" id="scenarioCard1">
            <div class="scenario-header">
              <div class="scenario-title">Trường hợp 2</div>
              <button type="button" class="scenario-save-btn" data-index="1">Lưu TH2</button>
            </div>
            <div class="scenario-body" id="scenarioBody1">
              <div class="scenario-empty">Chưa lưu – hãy tính và bấm “Lưu TH2”.</div>
            </div>
          </div>
          <div class="scenario-card" id="scenarioCard2">
            <div class="scenario-header">
              <div class="scenario-title">Trường hợp 3</div>
              <button type="button" class="scenario-save-btn" data-index="2">Lưu TH3</button>
            </div>
            <div class="scenario-body" id="scenarioBody2">
              <div class="scenario-empty">Chưa lưu – hãy tính và bấm “Lưu TH3”.</div>
            </div>
          </div>
        </div>
        <div class="scenario-note">
          Hệ thống sẽ tự đánh dấu <strong>trường hợp tối ưu hơn về kinh tế</strong> dựa trên chi phí nhiên liệu (VND/tấn hơi).
        </div>
      </section>
    </main>

    <!-- DETAILED CALC -->
    <section class="card details-card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="card-title-pill">C</span>Chi tiết từng bước tính toán</div>
          <div class="card-subtitle">Dùng để kiểm tra, giám sát và giải trình cách tính.</div>
        </div>
      </div>

      <details>
        <summary>Hiện / Ẩn chi tiết các bước tính</summary>
        <div class="steps-grid">
          <div class="step-block">
            <div class="step-title">Bước 1 – Quy đổi về trạng thái sử dụng (as-received)</div>
            <div class="step-line"><strong>Thành phần ar (%):</strong></div>
            <div class="step-line"><span id="step1_ar"></span></div>
            <div class="step-line"><strong>Phần khối lượng (kg/kg nhiên liệu):</strong></div>
            <div class="step-line"><span id="step1_mass"></span></div>
            <div class="step-line"><strong>GCV_ar:</strong> <span id="step1_gcv"></span> kJ/kg</div>
            <div class="step-note">
              Quy đổi C_db, H_db, O_db… (trên cơ sở khô) về trạng thái có ẩm M (%).  
              Nhiệt trị làm việc GCV_ar = GCV_db·(100 − M)/100.
            </div>
          </div>

          <div class="step-block">
            <div class="step-title">Bước 2 – Không khí lý thuyết & thực tế</div>
            <div class="step-line">O₂_req = 2.667·c + 8·h + s − o = <span id="step2_O2req"></span> kg O₂/kg nhiên liệu</div>
            <div class="step-line">A_th = O₂_req / 0.232 = <span id="step2_Ath"></span> kg không khí/kg nhiên liệu</div>
            <div class="step-line">λ = 21 / (21 − O₂_dry − 0.5·CO_vol) = <span id="step2_lambda"></span></div>
            <div class="step-line">A_act = λ · A_th = <span id="step2_Aact"></span> kg không khí/kg nhiên liệu</div>
            <div class="step-note">
              Từ thành phần nhiên liệu, tính lượng O₂ cần thiết để cháy hoàn toàn → không khí lý thuyết A_th.  
              Đo O₂, CO trong khói để suy ra hệ số thừa không khí λ và không khí thực tế A_act.
            </div>
          </div>

          <div class="step-block">
            <div class="step-title">Bước 3 – Khối lượng khói thải khô</div>
            <div class="step-line">m_dg = A_act + 1 − a − m − 9·h</div>
            <div class="step-line">⇒ m_dg = <span id="step3_mdg"></span> kg khói thải khô / kg nhiên liệu</div>
            <div class="step-note">
              Tính khối lượng khói khô (CO₂, CO, SO₂, O₂, N₂…) trên 1 kg nhiên liệu.  
              Giá trị này dùng cho tổn thất L1 (khí thải khô).
            </div>
          </div>

          <div class="step-block">
            <div class="step-title">Bước 4 – Thành phần khói & Cp_dg</div>
            <div class="step-line">c_CO = K · N_dg = <span id="step4_cCO"></span> kg C/kg nhiên liệu</div>
            <div class="step-line"><span id="step4_masses"></span></div>
            <div class="step-line"><span id="step4_fractions"></span></div>
            <div class="step-line">Cp_dg = Σ fᵢ·Cpᵢ = <span id="step4_Cpdg"></span> kJ/kg·°C</div>
            <div class="step-note">
              Từ CO_ppm suy ra lượng C cháy không hoàn toàn, phân bố khối lượng CO₂, CO, SO₂, O₂, N₂ trong khói.  
              Sau đó tính nhiệt dung riêng trung bình Cp_dg của khói thải.
            </div>
          </div>

          <div class="step-block">
            <div class="step-title">Bước 5 – Tổn thất L1 → L5</div>
            <div class="step-line">L1 – Khí thải khô: <span id="step5_L1"></span> %</div>
            <div class="step-line">L2 – H₂ trong nhiên liệu: <span id="step5_L2"></span> %</div>
            <div class="step-line">L3 – Ẩm trong nhiên liệu: <span id="step5_L3"></span> %</div>
            <div class="step-line">L4 – Ẩm trong không khí: <span id="step5_L4"></span> %</div>
            <div class="step-line">L5 – CO trong khói: <span id="step5_L5"></span> %</div>
            <div class="step-note">
              Công thức chính:  
              – L1 = (m_dg·Cp_dg·(Tf − Ta))/GCV_ar·100.  
              – L2 = (9·h·(2450 + 1.88·ΔT))/GCV_ar·100.  
              – L3 = (m·(2450 + 1.88·ΔT))/GCV_ar·100.  
              – L4 = (A_act·ω·1.88·ΔT)/GCV_ar·100 (ω: ẩm riêng không khí).  
              – L5 = (c_CO·24100)/GCV_ar·100.  
              Đây là các tổn thất chủ yếu quyết định hiệu suất.
            </div>
          </div>

          <div class="step-block">
            <div class="step-title">Bước 6 – Xả đáy & các tổn thất khác</div>
            <div class="step-line">P_abs = P_g + 1 = <span id="step6_Pabs"></span> bar</div>
            <div class="step-line">h_f = <span id="step6_hf"></span> kJ/kg, h_steam = <span id="step6_hsteam"></span> kJ/kg</div>
            <div class="step-line">h_fw = 4.18·T_fw = <span id="step6_hfw"></span> kJ/kg</div>
            <div class="step-line">TDS nước cấp = <span id="step6_TDSfw"></span> ppm, TDS nước lò cho phép ≈ <span id="step6_TDSlimit"></span> ppm</div>
            <div class="step-line">BR ước tính từ TDS ≈ <span id="step6_BR"></span> % lưu lượng hơi</div>
            <div class="step-line">L7 – Xả đáy: <span id="step6_L7"></span> % (η_init = 90%)</div>
            <div class="step-line">L6 – Bức xạ: 0.7 %; L8 – C chưa cháy: <span id="step6_L8"></span> %</div>
            <div class="step-note">
              Dùng bảng hơi bão hòa để lấy entanpi nước sôi (h_f) và hơi bão hòa (h_steam).  
              Tỷ lệ xả đáy BR được ước tính từ TDS nước cấp & giới hạn TDS nước lò cho phép.  
              BR càng cao thì càng mất nhiệt qua nước xả đáy; nên tối ưu chu kỳ cô đặc & chất lượng xử lý nước.
            </div>
          </div>

          <div class="step-block">
            <div class="step-title">Bước 7 – Hiệu suất & suất tiêu hao</div>
            <div class="step-line">∑L = <span id="step7_Lsum"></span> %</div>
            <div class="step-line">η = 100 − ∑L = <span id="step7_eta"></span> %</div>
            <div class="step-line">F_steam = (h_steam − h_fw) / (η·GCV_ar) = <span id="step7_Fsteam"></span> kg nhiên liệu/kg hơi</div>
            <div class="step-line">Suất tiêu hao cho 1 tấn hơi = <span id="step7_fuelTon"></span> kg nhiên liệu/tấn hơi</div>
            <div class="step-note">
              Tổng tất cả tổn thất L1→L8 để ra ∑L, sau đó hiệu suất η = 100 − ∑L.  
              Từ chênh entanpi giữa hơi và nước cấp cùng GCV_ar và η, tính suất tiêu hao nhiên liệu cho 1 kg / 1 tấn hơi – đây là chỉ tiêu kinh tế chính để so sánh các trường hợp.
            </div>
          </div>
        </div>
      </details>
    </section>

    <div class="footer-note">
      The web app was created by Nguyen Tuan Giang KTP
    </div>
  </div>

  <script>
    // Preset fuels
    const fuels = {
      dnb: {
        C_db: 47.61,
        H_db: 4.87,
        O_db: 44.24,
        S_db: 0.06,
        N_db: 0.31,
        A_db: 2.91,
        GCV_db: 19639
      },
      mb: {
        C_db: 47.61,
        H_db: 4.87,
        O_db: 44.24,
        S_db: 0.06,
        N_db: 0.31,
        A_db: 2.91,
        GCV_db: 17000
      },
      trau: {
        C_db: 36.42,
        H_db: 4.91,
        O_db: 35.88,
        S_db: 0.0,
        N_db: 0.59,
        A_db: 22.20,
        GCV_db: 16089
      }
    };

    const fuelPresetEl = document.getElementById('fuelPreset');
    const fields = ['C_db', 'H_db', 'O_db', 'S_db', 'N_db', 'A_db', 'GCV_db'];

    function loadFuelPreset() {
      const preset = fuelPresetEl.value;
      const isCustom = preset === 'custom';

      fields.forEach(id => {
        const el = document.getElementById(id);
        if (!isCustom) {
          el.value = fuels[preset][id];
          el.readOnly = true;
          el.style.backgroundColor = '#f0f3ff';
        } else {
          el.readOnly = false;
          el.style.backgroundColor = '#fafbff';
        }
      });
    }

    fuelPresetEl.addEventListener('change', loadFuelPreset);
    loadFuelPreset();

    function getNumber(id, fallback = 0) {
      const v = parseFloat(document.getElementById(id).value);
      return isNaN(v) ? fallback : v;
    }

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    // Simple steam table (approximate)
    const steamTable = [
      { P: 1,  hf: 419, hg: 2676 },
      { P: 3,  hf: 640, hg: 2725 },
      { P: 6,  hf: 697, hg: 2770 },
      { P: 10, hf: 781, hg: 2776 },
      { P: 15, hf: 844, hg: 2789 },
      { P: 20, hf: 908, hg: 2797 }
    ];

    function interpolateSteam(P_abs) {
      if (P_abs <= steamTable[0].P) return steamTable[0];
      if (P_abs >= steamTable[steamTable.length - 1].P) return steamTable[steamTable.length - 1];

      for (let i = 0; i < steamTable.length - 1; i++) {
        const a = steamTable[i];
        const b = steamTable[i + 1];
        if (P_abs >= a.P && P_abs <= b.P) {
          const t = (P_abs - a.P) / (b.P - a.P);
          const hf = a.hf + t * (b.hf - a.hf);
          const hg = a.hg + t * (b.hg - a.hg);
          return { P: P_abs, hf, hg };
        }
      }
      return steamTable[steamTable.length - 1];
    }

    function estimateBoilerTDSLimit(P_g) {
      // Ước lượng giới hạn TDS nước lò cho phép (ppm) theo áp suất – tham khảo tài liệu kinh nghiệm
      if (P_g <= 10) return 3500;   // ~10 bar
      if (P_g <= 20) return 3000;   // 10–20 bar
      return 2500;                  // >20 bar
    }

    function formatPercent(x, decimals = 2) {
      if (!isFinite(x)) return '–';
      return x.toFixed(decimals);
    }

    const numberFormatCache = {};

    function formatNumber(x, decimals = 2, useGrouping = true) {
      if (!isFinite(x)) return '–';
      const key = `${decimals}|${useGrouping}`;
      if (!numberFormatCache[key]) {
        numberFormatCache[key] = new Intl.NumberFormat('vi-VN', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
          useGrouping
        });
      }
      return numberFormatCache[key].format(x);
    }

    // Lưu kết quả hiện tại & 3 trường hợp so sánh
    let currentResult = null;
    const scenarios = [null, null, null];

    function saveScenario(index) {
      if (!currentResult ||
          !isFinite(currentResult.eta) ||
          !isFinite(currentResult.fuelPerTon) ||
          !isFinite(currentResult.costPerTon)) {
        alert('Vui lòng bấm "Tính toán tổn thất & hiệu suất" trước khi lưu trường hợp.');
        return;
      }
      const clone = JSON.parse(JSON.stringify(currentResult));
      clone.savedAt = new Date().toLocaleString('vi-VN');
      scenarios[index] = clone;
      renderScenarioCompare();
    }

    function renderScenarioCompare() {
      let bestIdx = -1;
      let bestCost = Infinity;

      for (let i = 0; i < 3; i++) {
        const card = document.getElementById('scenarioCard' + i);
        const body = document.getElementById('scenarioBody' + i);
        if (!card || !body) continue;

        card.classList.remove('scenario-best');

        const sc = scenarios[i];
        if (!sc) {
          body.innerHTML = '<div class="scenario-empty">Chưa lưu – hãy tính và bấm “Lưu TH' + (i + 1) + '”.</div>';
          continue;
        }

        if (isFinite(sc.costPerTon) && sc.costPerTon < bestCost) {
          bestCost = sc.costPerTon;
          bestIdx = i;
        }

        const inp = sc.inputs || {};
        const lines = [];

        lines.push(
          '<div class="scenario-metric-row"><span class="scenario-metric-label">Hiệu suất η:</span><span class="scenario-metric-value">' +
          formatPercent(sc.eta, 2) + ' %</span></div>'
        );

        if (isFinite(sc.fuelPerTon)) {
          lines.push(
            '<div class="scenario-metric-row"><span class="scenario-metric-label">Suất tiêu hao:</span><span class="scenario-metric-value">' +
            formatNumber(sc.fuelPerTon, 1) + ' kg/tấn hơi</span></div>'
          );
        }

        if (isFinite(sc.costPerTon)) {
          lines.push(
            '<div class="scenario-metric-row"><span class="scenario-metric-label">Chi phí nhiên liệu:</span><span class="scenario-metric-value">' +
            formatNumber(sc.costPerTon, 0) + ' VND/tấn hơi</span></div>'
          );
        }

        if (isFinite(sc.Lsum)) {
          lines.push(
            '<div class="scenario-metric-row"><span class="scenario-metric-label">Tổn thất ∑L:</span><span class="scenario-metric-value">' +
            formatPercent(sc.Lsum, 2) + ' %</span></div>'
          );
        }

        lines.push(
          '<div class="scenario-metric-row"><span class="scenario-metric-label">Nhiên liệu:</span><span class="scenario-metric-value">' +
          (inp.fuelName || '—') + '</span></div>'
        );

        lines.push(
          '<div class="scenario-metric-row"><span class="scenario-metric-label">M, O₂, Tf:</span><span class="scenario-metric-value">' +
          (isFinite(inp.M) ? formatNumber(inp.M, 1, false) : '–') + '%, ' +
          (isFinite(inp.O2_dry) ? formatNumber(inp.O2_dry, 1, false) : '–') + '%, ' +
          (isFinite(inp.Tf) ? formatNumber(inp.Tf, 1, false) : '–') + '°C</span></div>'
        );

        lines.push(
          '<div class="scenario-metric-row"><span class="scenario-metric-label">Giá NL:</span><span class="scenario-metric-value">' +
          (isFinite(inp.price) ? formatNumber(inp.price, 0) + ' VND/kg' : '–') + '</span></div>'
        );

        if (sc.savedAt) {
          lines.push(
            '<div class="scenario-metric-row"><span class="scenario-metric-label">Lưu lúc:</span><span class="scenario-metric-value">' +
            sc.savedAt + '</span></div>'
          );
        }

        body.innerHTML = lines.join('');
      }

      if (bestIdx >= 0) {
        const bestCard = document.getElementById('scenarioCard' + bestIdx);
        if (bestCard) {
          bestCard.classList.add('scenario-best');
        }
      }
    }

    function calcAndRender() {
      const inputErrorEl = document.getElementById('inputError');
      inputErrorEl.textContent = '';

      const C_db = getNumber('C_db');
      const H_db = getNumber('H_db');
      const O_db = getNumber('O_db');
      const S_db = getNumber('S_db');
      const N_db = getNumber('N_db');
      const A_db = getNumber('A_db');
      const GCV_db = getNumber('GCV_db');
      const price = getNumber('fuelPrice');

      const sumDry = C_db + H_db + O_db + S_db + N_db + A_db;
      if (sumDry < 98 || sumDry > 102) {
        inputErrorEl.textContent = 'Cảnh báo: Tổng C+H+O+S+N+Ash (dry basis) nên xấp xỉ 100%. Hiện tại = ' + formatNumber(sumDry, 2) + '%.';
      }

      const M = clamp(getNumber('M'), 0, 70);
      const O2_dry = clamp(getNumber('O2_dry'), 0, 20.5);
      const CO_ppm = Math.max(getNumber('CO_ppm'), 0);
      const Tf = getNumber('Tf');
      const Ta = getNumber('Ta');
      let RH = getNumber('RH');
      if (!isFinite(RH) || RH <= 0) RH = 80;
      RH = clamp(RH, 10, 100);

      const T_fw = getNumber('T_fw');
      const P_g = getNumber('P_g');
      const TDS_fw = Math.max(getNumber('TDS_fw'), 0);
      const L8_user = Math.max(getNumber('L8'), 0);

      if (GCV_db <= 0) {
        inputErrorEl.textContent = 'Vui lòng nhập GCV_db (kJ/kg) hợp lý (>0).';
        return;
      }

      // STEP 1
      const C_ar = C_db * (100 - M) / 100;
      const H_ar = H_db * (100 - M) / 100;
      const O_ar = O_db * (100 - M) / 100;
      const S_ar = S_db * (100 - M) / 100;
      const N_ar = N_db * (100 - M) / 100;
      const A_ar = A_db * (100 - M) / 100;
      const M_ar = M;

      const c = C_ar / 100;
      const h = H_ar / 100;
      const o = O_ar / 100;
      const s = S_ar / 100;
      const n = N_ar / 100;
      const a = A_ar / 100;
      const m = M_ar / 100;

      const GCV_ar = GCV_db * (100 - M) / 100;

      // STEP 2
      const O2_req = 2.667 * c + 8 * h + s - o;
      const A_th = O2_req / 0.232;

      const CO_vol_percent = CO_ppm / 10000;
      const lambda = 21 / (21 - O2_dry - 0.5 * CO_vol_percent);
      const A_act = lambda * A_th;

      // STEP 3
      const m_dg = A_act + 1 - a - m - 9 * h;

      // STEP 4
      const K = CO_ppm * 12 / 1000000;
      const N_dg = (A_act * 0.03468 - h / 4 + n / 28) / (1 - K / 24);
      const c_CO = K * N_dg;

      const mass_CO2 = 3.667 * (c - c_CO);
      const mass_CO = 2.333 * c_CO;
      const mass_SO2 = 2 * s;
      const mass_O2 = A_act * 0.232 - (2.667 * c - 1.333 * c_CO + 8 * h + s - o);
      const mass_N2 = A_act * 0.768 + n;

      const f_CO2 = mass_CO2 / m_dg;
      const f_CO = mass_CO / m_dg;
      const f_SO2 = mass_SO2 / m_dg;
      const f_O2 = mass_O2 / m_dg;
      const f_N2 = mass_N2 / m_dg;

      const Cp_CO2 = 0.85;
      const Cp_O2 = 0.91;
      const Cp_N2 = 1.04;
      const Cp_SO2 = 0.64;
      const Cp_CO = 1.04;

      const Cp_dg = f_CO2 * Cp_CO2 + f_O2 * Cp_O2 + f_N2 * Cp_N2 + f_SO2 * Cp_SO2 + f_CO * Cp_CO;

      // STEP 5
      const dT = Tf - Ta;
      const L1 = (m_dg * Cp_dg * dT) / GCV_ar * 100;
      const L2 = (9 * h * (2450 + 1.88 * dT)) / GCV_ar * 100;
      const L3 = (m * (2450 + 1.88 * dT)) / GCV_ar * 100;

      const P_sat = 0.61078 * Math.exp(17.27 * Ta / (Ta + 237.3)); // kPa
      const P_v = RH / 100 * P_sat;
      const omega = 0.622 * P_v / (101.325 - P_v);
      const L4 = (A_act * omega * 1.88 * dT) / GCV_ar * 100;

      const L5 = (c_CO * 24100) / GCV_ar * 100;
      const L6 = 0.7;

      // STEP 6
      const P_abs = P_g + 1;
      const steamProps = interpolateSteam(P_abs);
      const h_f = steamProps.hf;
      const h_steam = steamProps.hg;
      const h_fw = 4.18 * T_fw;

      const eta_init = 0.9;
      const TDS_limit = estimateBoilerTDSLimit(P_g);

      let BR = getNumber('BR'); // fallback nếu TDS không nhập
      let BR_from_TDS = null;

      if (TDS_fw > 0) {
        if (TDS_fw < TDS_limit * 0.9) {
          const CoC = TDS_limit / TDS_fw;
          BR_from_TDS = 100 / (CoC - 1); // % theo hơi
        } else {
          // TDS nước cấp quá cao so với giới hạn → phải xả đáy nhiều
          BR_from_TDS = 15;
        }
      }

      if (BR_from_TDS !== null && isFinite(BR_from_TDS) && BR_from_TDS > 0) {
        BR = BR_from_TDS;
      }

      if (!isFinite(BR) || BR < 0) BR = 0;
      if (BR > 30) BR = 30;

      // Cập nhật lại ô BR để người dùng nhìn thấy
      const BRInput = document.getElementById('BR');
      if (BRInput) {
        BRInput.value = BR.toFixed(1);
      }

      const BR_frac = BR / 100;
      let L7 = 0;
      if (h_steam > h_fw) {
        L7 = eta_init * BR_frac * (h_f - h_fw) / (h_steam - h_fw) * 100;
      }

      const L8 = L8_user;

      const Lsum = L1 + L2 + L3 + L4 + L5 + L6 + L7 + L8;
      const eta = 100 - Lsum;

      let F_steam = NaN;
      let fuelPerTon = NaN;
      let costPerTon = NaN;
      if (GCV_ar > 0 && eta > 0) {
        const etaFrac = eta / 100;
        F_steam = (h_steam - h_fw) / (etaFrac * GCV_ar);
        fuelPerTon = F_steam * 1000;
        costPerTon = fuelPerTon * price;
      }

      // Lưu kết quả hiện tại cho chức năng so sánh
      currentResult = {
        eta,
        fuelPerTon,
        costPerTon,
        Lsum,
        L1, L2, L3, L4, L5, L6, L7, L8,
        inputs: {
          fuelPreset: fuelPresetEl.value,
          fuelName: fuelPresetEl.options[fuelPresetEl.selectedIndex].text,
          M,
          O2_dry,
          CO_ppm,
          Tf,
          Ta,
          RH,
          T_fw,
          P_g,
          BR,
          L8_user,
          price
        }
      };

      // MAIN METRICS
      const etaDisplay = document.getElementById('etaDisplay');
      const etaChip = document.getElementById('etaChip');
      const fuelPerTonDisplay = document.getElementById('fuelPerTonDisplay');
      const fuelChip = document.getElementById('fuelChip');
      const costPerTonDisplay = document.getElementById('costPerTonDisplay');
      const costChip = document.getElementById('costChip');
      const lossTotalDisplay = document.getElementById('lossTotalDisplay');
      const lossChip = document.getElementById('lossChip');

      etaDisplay.textContent = isFinite(eta) ? formatPercent(eta, 2) : '–';
      fuelPerTonDisplay.textContent = isFinite(fuelPerTon) ? formatNumber(fuelPerTon, 1) : '–';
      costPerTonDisplay.textContent = isFinite(costPerTon) ? formatNumber(costPerTon, 0) : '–';
      lossTotalDisplay.textContent = isFinite(Lsum) ? formatPercent(Lsum, 2) : '–';

      if (eta >= 88) {
        etaChip.textContent = 'Mức rất tốt cho lò sinh khối';
        etaChip.style.backgroundColor = 'rgba(46,125,50,0.1)';
        etaChip.style.color = '#2e7d32';
      } else if (eta >= 80) {
        etaChip.textContent = 'Mức phổ biến – có thể cải thiện';
        etaChip.style.backgroundColor = 'rgba(255,160,0,0.12)';
        etaChip.style.color = '#ef6c00';
      } else {
        etaChip.textContent = 'Hiệu suất thấp – nên kiểm toán chi tiết';
        etaChip.style.backgroundColor = 'rgba(198,40,40,0.12)';
        etaChip.style.color = '#c62828';
      }

      if (isFinite(fuelPerTon)) {
        fuelChip.textContent = formatNumber(fuelPerTon, 1) + ' kg/tấn hơi';
      } else {
        fuelChip.textContent = 'Chưa tính';
      }

      if (isFinite(costPerTon)) {
        costChip.textContent = '≈ ' + formatNumber(costPerTon, 0) + ' VND/tấn hơi';
      } else {
        costChip.textContent = 'Chưa tính';
      }

      lossChip.textContent = 'Tổn thất tổng = ' + formatPercent(Lsum, 2) + ' %';

      // LOSS TABLE
      const lossTableBody = document.getElementById('lossTableBody');
      lossTableBody.innerHTML = '';

      function classifyLoss(value, typicalLow, typicalHigh) {
        if (!isFinite(value)) return { tag: 'N/A', cls: 'warn' };
        if (value <= typicalLow) return { tag: 'Tốt', cls: 'ok' };
        if (value <= typicalHigh) return { tag: 'Chấp nhận', cls: 'warn' };
        return { tag: 'Cao', cls: 'bad' };
      }

      function addLossRow(name, code, value, typicalLow, typicalHigh, adviceLines) {
        const tr = document.createElement('tr');
        let cls = classifyLoss(value, typicalLow, typicalHigh);

        // Riêng L7: nếu BR > 6% thì cảnh báo "Cao" theo tài liệu
        if (code === 'L7' && isFinite(BR) && BR > 6) {
          cls = { tag: 'Cao', cls: 'bad' };
        }

        const tdName = document.createElement('td');
        tdName.innerHTML = '<div class="loss-name">' + code + ' – ' + name + '</div>';

        const tdVal = document.createElement('td');
        tdVal.className = 'loss-value';
        tdVal.textContent = isFinite(value) ? formatPercent(value, 2) + ' %' : '–';

        const tdAdvice = document.createElement('td');
        const tagDiv = document.createElement('div');
        tagDiv.className = 'loss-tag ' + cls.cls;
        tagDiv.textContent = cls.tag;
        const adviceDiv = document.createElement('div');
        adviceDiv.className = 'loss-advice';
        adviceDiv.innerHTML = adviceLines.join('<br>');
        tdAdvice.appendChild(tagDiv);
        tdAdvice.appendChild(adviceDiv);

        tr.appendChild(tdName);
        tr.appendChild(tdVal);
        tr.appendChild(tdAdvice);
        lossTableBody.appendChild(tr);
      }

      const adviceL1 = [];
      adviceL1.push('• Giảm O₂ thừa & nhiệt độ khí thải bằng: chỉnh gió quạt, tối ưu phân phối gió, vệ sinh bề mặt truyền nhiệt, tận dụng economizer/air-preheater.');
      if (Tf > 200) {
        adviceL1.push('• Tf > 200°C → nên vệ sinh bề mặt trao đổi nhiệt, xem xét thu hồi nhiệt khí thải.');
      } else if (Tf < 120) {
        adviceL1.push('• Tf < 120°C → cẩn trọng nguy cơ đọng sương & ăn mòn (đặc biệt nếu nhiên liệu có S).');
      }
      if (O2_dry > 8) {
        adviceL1.push('• O₂ khói cao → có thể đang thừa gió, nên giảm dần gió cấp để đưa O₂ về ≈4–8% tùy nhiên liệu & CO.');
      }

      const adviceL2 = [
        '• Gắn với H trong nhiên liệu – khó can thiệp, chủ yếu phụ thuộc loại nhiên liệu.',
        '• Khi nhiên liệu rất ẩm, L2 kết hợp L3 sẽ làm hiệu suất giảm rõ rệt.'
      ];

      const adviceL3 = [];
      adviceL3.push('• Mỗi +10% độ ẩm sinh khối gỗ có thể làm tăng tổn thất khí thải ≈1,1 điểm % tuyệt đối.');
      if (M > 50) {
        adviceL3.push('• M > 50% → nên ưu tiên sấy/phơi (có mái che), trộn với nhiên liệu khô hơn trước khi đốt.');
      } else if (M > 35) {
        adviceL3.push('• M ≈ 35–50% → lò vẫn chạy nhưng suất tiêu hao cao; nên hướng tới M ≲ 30%.');
      } else {
        adviceL3.push('• M ≤ 30% → khá tốt cho lò sinh khối.');
      }

      const adviceL4 = [
        '• L4 thường nhỏ, phụ thuộc khí hậu & độ ẩm không khí.',
        '• Giảm nhẹ bằng cách đun nóng sơ bộ không khí cháy (air-preheater) và tránh hút gió từ khu vực quá ẩm.'
      ];

      const adviceL5 = [];
      if (CO_ppm <= 100) {
        adviceL5.push('• CO thấp → cháy khá hoàn toàn, tổn thất CO nhỏ.');
      } else if (CO_ppm <= 400) {
        adviceL5.push('• CO trung bình → nên tối ưu thêm phân phối gió & lớp nhiên liệu.');
      } else {
        adviceL5.push('• CO cao → cháy không hoàn toàn, cần tăng gió cấp/buồng trộn, kiểm tra phân phối gió & kích cỡ nhiên liệu.');
      }
      adviceL5.push('• Kết hợp theo dõi O₂ & CO: giảm dần gió cấp đến khi CO tăng, rồi lùi lại một chút là vùng tối ưu.');

      const adviceL6 = [
        '• 0.7% là giá trị mặc định cho lò bảo ôn tương đối tốt.',
        '• Nếu bề mặt lò/ống nóng khi chạm tay → nên tăng cường bọc cách nhiệt, che chắn gió lùa.'
      ];

      const adviceL7 = [];
      adviceL7.push('• BR cao làm mất nhiều nhiệt qua nước xả đáy; thường BR ≈ 2–5% với nước lò xử lý tốt.');

      if (TDS_fw > 0) {
        const CoC_est = TDS_fw > 0 ? (TDS_limit / TDS_fw) : NaN;
        adviceL7.push('• TDS nước cấp ≈ ' + formatNumber(TDS_fw, 0) + ' ppm; giới hạn nước lò ước tính ≈ ' + formatNumber(TDS_limit, 0) + ' ppm → chu kỳ cô đặc ≈ ' + (isFinite(CoC_est) ? formatNumber(CoC_est, 1) : '–') + ' lần.');
      }

      if (BR > 6) {
        adviceL7.push('• Cảnh báo: mức xả đáy ≈ ' + BR.toFixed(1) + '% > 6% → được xem là CAO theo khuyến nghị; cần xem lại chất lượng xử lý nước (làm mềm/khử khoáng), giảm TDS nước cấp, hạn chế rò rỉ và tối ưu chế độ xả đáy.');
      } else if (BR > 3) {
        adviceL7.push('• BR trong khoảng 3–6% – mức trung bình; nên kiểm tra định kỳ chất lượng nước và cài đặt xả đáy tự động.');
      }

      adviceL7.push('• Nếu lưu lượng đủ lớn, có thể cân nhắc thu hồi nhiệt xả đáy (flash tank, bộ trao đổi nhiệt) để giảm tổn thất L7.');

      const adviceL8 = [
        '• L8 phản ánh C chưa cháy trong tro/xỉ – phụ thuộc thiết kế & vận hành buồng đốt.',
        '• Giảm L8 bằng cách tối ưu phân phối gió sơ/thứ cấp, kiểm soát kích cỡ nhiên liệu, tránh quạt gió quá mạnh cuốn nhiên liệu chưa cháy.'
      ];

      addLossRow('Khí thải khô', 'L1', L1, 7, 15, adviceL1);
      addLossRow('Nước từ H trong nhiên liệu', 'L2', L2, 3, 7, adviceL2);
      addLossRow('Độ ẩm trong nhiên liệu', 'L3', L3, 2, 6, adviceL3);
      addLossRow('Độ ẩm trong không khí', 'L4', L4, 0.1, 0.5, adviceL4);
      addLossRow('CO trong khói thải', 'L5', L5, 0.1, 1.0, adviceL5);
      addLossRow('Bức xạ & không tính hết', 'L6', L6, 0.5, 1.5, adviceL6);
      addLossRow('Xả đáy lò hơi', 'L7', L7, 0.5, 3.0, adviceL7);
      addLossRow('C chưa cháy trong tro/xỉ', 'L8', L8, 0.5, 2.0, adviceL8);

      // ADVICE SUMMARY
      const adviceSummary = document.getElementById('adviceSummary');
      const adviceBadges = [];

      if (O2_dry > 0) {
        if (O2_dry > 8) {
          adviceBadges.push('<span class="advice-badge"><strong>O₂ khói:</strong> ' + formatNumber(O2_dry, 1, false) + '% → thừa gió, nên giảm quạt cấp.</span>');
        } else if (O2_dry < 3) {
          adviceBadges.push('<span class="advice-badge"><strong>O₂ khói:</strong> ' + formatNumber(O2_dry, 1, false) + '% → gió thấp, cần kiểm soát CO.</span>');
        } else {
          adviceBadges.push('<span class="advice-badge"><strong>O₂ khói:</strong> ' + formatNumber(O2_dry, 1, false) + '% – vùng vận hành tốt (≈4–8%).</span>');
        }
      }

      adviceBadges.push('<span class="advice-badge"><strong>Độ ẩm nhiên liệu:</strong> ' + formatNumber(M, 1, false) + '%.</span>');
      if (M > 40) {
        adviceBadges.push('<span class="advice-badge"><strong>Gợi ý:</strong> phơi/sấy hoặc trộn với nhiên liệu khô hơn để đưa M về ≲30–35%.</span>');
      }

      adviceBadges.push('<span class="advice-badge"><strong>Tf:</strong> ' + formatNumber(Tf, 1, false) + '°C.</span>');
      if (Tf > 200) {
        adviceBadges.push('<span class="advice-badge"><strong>Gợi ý:</strong> vệ sinh bề mặt, xem xét thu hồi nhiệt khí thải.</span>');
      }

      adviceBadges.push('<span class="advice-badge"><strong>BR xả đáy:</strong> ' + BR.toFixed(1) + ' %.</span>');

      let summaryHtml = '<div class="advice-highlight">';
      summaryHtml += adviceBadges.join(' ');
      summaryHtml += '<ul>';

      if (eta > 0 && isFinite(eta)) {
        if (eta < 80) {
          summaryHtml += '<li>Hiệu suất ' + formatNumber(eta, 1, false) + '% – thấp hơn mức tối ưu; ưu tiên giảm L1 (khí thải) & L3 (ẩm nhiên liệu).</li>';
        } else if (eta < 88) {
          summaryHtml += '<li>Hiệu suất ' + formatNumber(eta, 1, false) + '% – mức phổ biến; vẫn có dư địa giảm O₂ & Tf để tiết kiệm nhiên liệu.</li>';
        } else {
          summaryHtml += '<li>Hiệu suất ' + formatNumber(eta, 1, false) + '% – rất tốt; tập trung duy trì chế độ vận hành hiện tại.</li>';
        }
      }

      if (isFinite(fuelPerTon) && isFinite(costPerTon)) {
        summaryHtml += '<li>Suất tiêu hao ≈ <strong>' + formatNumber(fuelPerTon, 1) + ' kg/tấn hơi</strong>, chi phí nhiên liệu ≈ <strong>' + formatNumber(costPerTon, 0) + ' VND/tấn hơi</strong>.</li>';
      }

      if (M > 30) {
        summaryHtml += '<li>Mỗi 10% tăng độ ẩm sinh khối gỗ có thể làm tăng tổn thất khí thải ≈1,1 điểm % tuyệt đối; giảm ẩm thường rất hiệu quả về kinh tế.</li>';
      }

      summaryHtml += '</ul></div>';
      adviceSummary.innerHTML = summaryHtml;

      // STEP DETAILS
      document.getElementById('step1_ar').textContent =
        'C_ar=' + formatNumber(C_ar, 2, false) + '%, H_ar=' + formatNumber(H_ar, 2, false) + '%, O_ar=' + formatNumber(O_ar, 2, false) +
        '%, S_ar=' + formatNumber(S_ar, 2, false) + '%, N_ar=' + formatNumber(N_ar, 2, false) + '%, Ash A_ar=' + formatNumber(A_ar, 2, false) +
        '%, M=' + formatNumber(M_ar, 2, false) + '%';

      document.getElementById('step1_mass').textContent =
        'c=' + formatNumber(c, 4, false) + ', h=' + formatNumber(h, 4, false) + ', o=' + formatNumber(o, 4, false) +
        ', s=' + formatNumber(s, 4, false) + ', n=' + formatNumber(n, 4, false) + ', a=' + formatNumber(a, 4, false) +
        ', m=' + formatNumber(m, 4, false);

      document.getElementById('step1_gcv').textContent = formatNumber(GCV_ar, 2);
      document.getElementById('step2_O2req').textContent = formatNumber(O2_req, 4, false);
      document.getElementById('step2_Ath').textContent = formatNumber(A_th, 4, false);
      document.getElementById('step2_lambda').textContent = formatNumber(lambda, 3, false);
      document.getElementById('step2_Aact').textContent = formatNumber(A_act, 4, false);
      document.getElementById('step3_mdg').textContent = formatNumber(m_dg, 4, false);
      document.getElementById('step4_cCO').textContent = formatNumber(c_CO, 6, false);

      document.getElementById('step4_masses').textContent =
        'Khối lượng: CO₂=' + formatNumber(mass_CO2, 4, false) + ', CO=' + formatNumber(mass_CO, 4, false) +
        ', SO₂=' + formatNumber(mass_SO2, 4, false) + ', O₂=' + formatNumber(mass_O2, 4, false) +
        ', N₂=' + formatNumber(mass_N2, 4, false) + ' (kg/kg nhiên liệu)';

      document.getElementById('step4_fractions').textContent =
        'Tỷ phần: f_CO₂=' + formatNumber(f_CO2, 4, false) + ', f_CO=' + formatNumber(f_CO, 4, false) +
        ', f_SO₂=' + formatNumber(f_SO2, 4, false) + ', f_O₂=' + formatNumber(f_O2, 4, false) +
        ', f_N₂=' + formatNumber(f_N2, 4, false);

      document.getElementById('step4_Cpdg').textContent = formatNumber(Cp_dg, 4, false);
      document.getElementById('step5_L1').textContent = formatPercent(L1, 3);
      document.getElementById('step5_L2').textContent = formatPercent(L2, 3);
      document.getElementById('step5_L3').textContent = formatPercent(L3, 3);
      document.getElementById('step5_L4').textContent = formatPercent(L4, 3);
      document.getElementById('step5_L5').textContent = formatPercent(L5, 3);

      document.getElementById('step6_Pabs').textContent = formatNumber(P_abs, 2, false);
      document.getElementById('step6_hf').textContent = formatNumber(h_f, 1);
      document.getElementById('step6_hsteam').textContent = formatNumber(h_steam, 1);
      document.getElementById('step6_hfw').textContent = formatNumber(h_fw, 1);
      document.getElementById('step6_TDSfw').textContent = formatNumber(TDS_fw, 0);
      document.getElementById('step6_TDSlimit').textContent = formatNumber(TDS_limit, 0);
      document.getElementById('step6_BR').textContent = formatNumber(BR, 2, false);
      document.getElementById('step6_L7').textContent = formatPercent(L7, 3);
      document.getElementById('step6_L8').textContent = formatPercent(L8, 3);

      document.getElementById('step7_Lsum').textContent = formatPercent(Lsum, 3);
      document.getElementById('step7_eta').textContent = formatPercent(eta, 3);
      document.getElementById('step7_Fsteam').textContent = isFinite(F_steam) ? formatNumber(F_steam, 4, false) : '–';
      document.getElementById('step7_fuelTon').textContent = isFinite(fuelPerTon) ? formatNumber(fuelPerTon, 1) : '–';
    }

    document.getElementById('calcBtn').addEventListener('click', calcAndRender);

    // Nút "Lưu TH1, TH2, TH3"
    document.querySelectorAll('.scenario-save-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const index = parseInt(this.dataset.index, 10);
        saveScenario(index);
      });
    });

    // Nhấn Enter trong bất kỳ ô input/select sẽ tính lại hiệu suất
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          calcAndRender();
        }
      });
    });

    // Khởi tạo giao diện so sánh
    renderScenarioCompare();
  </script>
</body>
</html>
